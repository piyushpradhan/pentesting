# Devzat

Difficulty: 5
Key takeway: Check how the parameters of the post request's body are used, try for OS command injection
Check the backups(if any) thoroughly [ diff command works on directories too! ]
Tags: Backups, InfluxDB, OS command Injection, POST, subdomains
Type: Linux

# Enumeration

- portscan

```bash
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 c2:5f:fb:de:32:ff:44:bf:08:f5:ca:49:d4:42:1a:06 (RSA)
|   256 bc:cd:e8:ee:0a:a9:15:76:52:bc:19:a4:a3:b2:ba:ff (ECDSA)
|_  256 62:ef:72:52:4f:19:53:8b:f2:9b:be:46:88:4b:c3:d0 (ED25519)
80/tcp   open  http    Apache httpd 2.4.41
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: devzat - where the devs at
8000/tcp open  ssh     (protocol 2.0)
| fingerprint-strings: 
|   NULL: 
|_    SSH-2.0-Go
| ssh-hostkey: 
|_  3072 6a:ee:db:90:a6:10:30:9f:94:ff:bf:61:95:2a:20:63 (RSA)
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port8000-TCP:V=7.91%I=7%D=10/17%Time=616C057C%P=x86_64-pc-linux-gnu%r(N
SF:ULL,C,"SSH-2\.0-Go\r\n");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

- subdomain scan

```bash
~ gobuster vhost -u devzat.htb -w subdomain-wordlist.txt 
Found: http://pets.devzat.htb (Status: 200)
```

- POST request to /api/posts

```bash
POST /api/pet HTTP/1.1
Host: pets.devzat.htb
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://pets.devzat.htb/
Content-Type: text/plain;charset=UTF-8
Origin: http://pets.devzat.htb
Content-Length: 32
Connection: close

{"name":"tommy","species":"cat"}
```

This is what a serialized object with a function should look like. During the deserialization process, anything after a special tag $$ND_FUNC$$ goes directly to eval function. Therefore, we can use IIFE (as mentioned in the article) or write code directly

# Initial Access

in the post request's body, the "species" parameter was susceptible to OS command injection.

- Found this out after checking the pets.devzat.htb/build/main.js source code
- passed a bash reverse shell one liner wrapped in backticks in the value of species parameter to get an initial foothold

# Privilege Escalation

Analyzing the forwarded ports

```bash
kali@kali:~/htb/devzat$ nmap -A -sC -sV -p 5000,8086,8443 127.0.0.1 -T4
Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-18 00:04 EDT
Nmap scan report for localhost (127.0.0.1)
Host is up (0.00012s latency).

PORT     STATE SERVICE VERSION
5000/tcp open  upnp?
| fingerprint-strings: 
|   GenericLines, Help, RTSPRequest: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest: 
|     HTTP/1.0 200 OK
|     Server: My genious go pet server
|     Date: Mon, 18 Oct 2021 04:04:57 GMT
|     Content-Length: 510
|     Content-Type: text/html; charset=utf-8
|     <!DOCTYPE html>
|     <html lang="en">
|     <head>
|     <meta charset='utf-8'>
|     <meta name='viewport' content='width=device-width,initial-scale=1'>
|     <title>Pet Inventory</title>
|     <link rel='icon' type='image/png' href='/favicon.ico'>
|     <link rel='stylesheet' href='/css/global.css'>
|     <link rel='stylesheet' href='/css/bootstrap.min.css'>
|     <link rel='stylesheet' href='/css/all.min.css'>
|     <link rel='stylesheet' href='/build/bundle.css'>
|     <script type="module" src='/build/main.js'></script>
|     </head>
|     <body>
|     </body>
|     </html>
|   HTTPOptions: 
|     HTTP/1.0 200 OK
|     Server: My genious go pet server
|     Date: Mon, 18 Oct 2021 04:05:14 GMT
|     Content-Length: 510
|     Content-Type: text/html; charset=utf-8
|     <!DOCTYPE html>
|     <html lang="en">
|     <head>
|     <meta charset='utf-8'>
|     <meta name='viewport' content='width=device-width,initial-scale=1'>
|     <title>Pet Inventory</title>
|     <link rel='icon' type='image/png' href='/favicon.ico'>
|     <link rel='stylesheet' href='/css/global.css'>
|     <link rel='stylesheet' href='/css/bootstrap.min.css'>
|     <link rel='stylesheet' href='/css/all.min.css'>
|     <link rel='stylesheet' href='/build/bundle.css'>
|     <script type="module" src='/build/main.js'></script>
|     </head>
|     <body>
|     </body>
|_    </html>
8086/tcp open  http    InfluxDB http admin 1.7.5
|_http-title: Site doesn't have a title (text/plain; charset=utf-8).
8443/tcp open  ssh     (protocol 2.0)
| fingerprint-strings: 
|   NULL: 
|_    SSH-2.0-Go
| ssh-hostkey: 
|_  256 66:61:73:b4:a2:9c:b1:b7:a9:81:7a:6e:1d:5d:fc:ec (ED25519)
2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service :
==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============
SF-Port5000-TCP:V=7.91%I=7%D=10/18%Time=616CF261%P=x86_64-pc-linux-gnu%r(G
SF:enericLines,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20
SF:text/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Bad\
SF:x20Request")%r(GetRequest,295,"HTTP/1\.0\x20200\x20OK\r\nServer:\x20My\
SF:x20genious\x20go\x20pet\x20server\r\nDate:\x20Mon,\x2018\x20Oct\x202021
SF:\x2004:04:57\x20GMT\r\nContent-Length:\x20510\r\nContent-Type:\x20text/
SF:html;\x20charset=utf-8\r\n\r\n<!DOCTYPE\x20html>\n<html\x20lang=\"en\">
SF:\n<head>\n\t<meta\x20charset='utf-8'>\n\t<meta\x20name='viewport'\x20co
SF:ntent='width=device-width,initial-scale=1'>\n\n\t<title>Pet\x20Inventor
SF:y</title>\n\n\t<link\x20rel='icon'\x20type='image/png'\x20href='/favico
SF:n\.ico'>\n\t<link\x20rel='stylesheet'\x20href='/css/global\.css'>\n\t<l
SF:ink\x20rel='stylesheet'\x20href='/css/bootstrap\.min\.css'>\n\t<link\x2
SF:0rel='stylesheet'\x20href='/css/all\.min\.css'>\n\t<link\x20rel='styles
SF:heet'\x20href='/build/bundle\.css'>\n\n\t<script\x20type=\"module\"\x20
SF:src='/build/main\.js'></script>\n</head>\n\n<body>\n</body>\n</html>\n"
SF:)%r(RTSPRequest,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:
SF:\x20text/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20
SF:Bad\x20Request")%r(HTTPOptions,295,"HTTP/1\.0\x20200\x20OK\r\nServer:\x
SF:20My\x20genious\x20go\x20pet\x20server\r\nDate:\x20Mon,\x2018\x20Oct\x2
SF:02021\x2004:05:14\x20GMT\r\nContent-Length:\x20510\r\nContent-Type:\x20
SF:text/html;\x20charset=utf-8\r\n\r\n<!DOCTYPE\x20html>\n<html\x20lang=\"
SF:en\">\n<head>\n\t<meta\x20charset='utf-8'>\n\t<meta\x20name='viewport'\
SF:x20content='width=device-width,initial-scale=1'>\n\n\t<title>Pet\x20Inv
SF:entory</title>\n\n\t<link\x20rel='icon'\x20type='image/png'\x20href='/f
SF:avicon\.ico'>\n\t<link\x20rel='stylesheet'\x20href='/css/global\.css'>\
SF:n\t<link\x20rel='stylesheet'\x20href='/css/bootstrap\.min\.css'>\n\t<li
SF:nk\x20rel='stylesheet'\x20href='/css/all\.min\.css'>\n\t<link\x20rel='s
SF:tylesheet'\x20href='/build/bundle\.css'>\n\n\t<script\x20type=\"module\
SF:"\x20src='/build/main\.js'></script>\n</head>\n\n<body>\n</body>\n</htm
SF:l>\n")%r(Help,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x
SF:20text/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Ba
SF:d\x20Request");
==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============
SF-Port8443-TCP:V=7.91%I=7%D=10/18%Time=616CF261%P=x86_64-pc-linux-gnu%r(N
SF:ULL,C,"SSH-2\.0-Go\r\n");
```

- 8086 is running InfluxDB 1.7.5
- there is an authentication bypass vulnerability
- Using an authentication bypass script from github â†’ username : admin
    - got into the database

```bash
[1] Insert query (exit to change db): SELECT * FROM "devzat"."myretention"."user"
{
    "results": [
        {
            "series": [
                {
                    "columns": [
                        "time",
                        "enabled",
                        "password",
                        "username"
                    ],
                    "name": "user",
                    "values": [
                        [
                            "2021-06-22T20:04:16.313965493Z",
                            false,
                            "WillyWonka2021",
                            "wilhelm"
                        ],
                        [
                            "2021-06-22T20:04:16.320782034Z",
                            true,
                            "woBeeYareedahc7Oogeephies7Aiseci",
                            "catherine"
                        ],
                        [
                            "2021-06-22T20:04:16.996682002Z",
                            true,
                            "RoyalQueenBee$",
                            "charles"
                        ]
                    ]
                }
            ],
            "statement_id": 0
        }
    ]
}
```

- `diff dev main` after extracting the file present in /var/backups
- a new function is present in commands.go but running on port 8443 instead of 8000
- password :

<       // Check my secure password
<       if pass != "CeilingCatStillAThingIn2021?" {
<               u.system("You did provide the wrong password")
<               return
<       }

- used /file command in the ssh application running on 8443 to read the contents of root.txt

## Notes

-