# Kerberos 

Kerberos is the default authentication service for Microsoft Windows domains. 

## Terminology: 
1. Ticket Granting Ticket - Authentication Ticket for requesting access to certain resources from TGS 
2. Key Distribution Center - Service for providing TGT and service tickets that consists of Ticket granting Service and Authentication service
3. Authentication Service - Grants TGTs to be used by TGS in the domain to access other machines and services
4. Ticket Granting Service - Takes a TGT and returns a ticket to a machine on the domain 
5. Service Principal Name - Identifier given to a service instance to associate it with a domain service account. Windows requires every service instance to have a service account. 
6. KDC Long Term Secret Key - Used to encrypt TGT and sign the PAC.
7. Client Long Term Secret Key (Client LT Key) - The client key is based on the computer or service account. It is used to check the encrypted timestamp and encrypt the session key.
8. Service Long Term Secret Key (Service LT Key) - The service key is based on the service account. It is used to encrypt the service portion of the service ticket and sign the PAC.
9. Session Key - Issued by the KDC when a TGT is issued. The user will provide the session key to the KDC along with the TGT when requesting a service ticket.
10. Privilege Attribute Certificate (PAC) - The PAC holds all of the user's relevant information, it is sent along with the TGT to the KDC to be signed by the Target LT Key and the KDC LT Key in order to validate the user.

## AS-REQ w/ Pre-authentication: 
- Starts when a user requests a TGT from the KDC. 
- Steps to validate a user and create a TGT: 
    1. user encrypts a timestamp NT hash and sends it to the AS (Authentication Service). 
    2. KDC attempts to decrypt the timestamp using the NT hash from the user, if successful the KDC will then issue a TGT as well as a session key for the user. 

## Kerberos Authentication: 
1. The client requests an authentication ticket or ticket granting ticket. 
2. The Key Distribution Center verifies the client and sends back an encrypted TGT. 
3. The client sends the encrypted TGT to the Ticket Granting Server with the Service Principal Name (SPN) of the service the client wants to access. 
4. The KDC verifies the TGT of the user and that the user has access to the service then sends a valid session key for the service to the client. 
5. The client then requests the service and sends the valid session key to prove the user has access 
6. The service grants access. 

## Attack Privilege Requirements 
- Kerbrute Enumeration - No domain access required 
- Pass the ticket - Access as a user to the domain required 
- Kerberoasting - Access as any user required 
- AS-REP roasting - access as any user required 
- Golden Ticket - Full domain compromise (domain admin) required 
- Silver Ticket - Service hash required 
- Skeleton key - Full domain compromise (domain admin) required
