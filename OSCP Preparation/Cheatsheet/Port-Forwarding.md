# Port forwarding and Pivoting

## SSH Tunneling

### Local Port Forwarding 

- Allows access to remote resources that we couldn't have accessed earlier
- Ex: Internal remote database, RDP

```
                                         +----------------------------------------------------------+
+-----------------+                      |                                                          |
|                 |                      |                                                          |
|                 |                      |                                                          |
|                 |                      |                                                          |
|     8888        |                      |                                                          |
|                 |                      |                                                          |
|                 |                      |    +--------------+                  +--------------+    |
|                 |----------------------+--->|              |                  |              |    |
|                 |<---------------------+----+              |                  |              |    |
+-----------------+                      |    |              |                  |              |    |
         ^                               |    |              |                  |              |    |
         |                               |    |              |                  |              |    |
         |                               |    |              |                  |              |    |
+--------+--------+                      |    |  Machine 1   +------------------>   Machine 2  |    |
|                 |                      |    |   (Public)   |                  | (Not Public) |    |
|                 |                      |    |              |                  |              |    |
|                 |                      |    |              |                  |              |    |
|                 |                      |    |              |                  |              |    |
|    Box A        |                      |    |              |                  |              |    |
|    (Outside)    |                      |    |              |                  |              |    |
|                 |                      |    |              |                  |              |    |
|                 |                      |    +--------------+                  +--------------+    |
+-----------------+                      |                                                          |
                                         |                                                          |
                                         +----------------------------------------------------------+


                                                          Internal Network
```

- Machine 1 is the **public** SSH server
- Machine 2 (internal resource -> target) is completely restricted to the Internal Network
- Box A is a machine outside of the Internal network and can't directly access Machine 2. 
- So we create a **tunnel** between Box A and Machine 1, because Machine 1 is a **public** SSH server
- `ssh -L 8888:<Machine 2 IP>:8080 <Machine A IP>` after doing this Machine 1 (public SSH Server) will start listening to port 8888 of Box A forward the traffic going to 8888 of Box A to 8080 of Machine 2
- If we visit localhost:8888, this will make a request to 8888 of Box A and it'll send content as TCP packet through the tunnel to Machine 1 which will notice that we're trying to access resources of Machine 2, which it (Machine 1) has access to and it'll forward the request internally to Machine 2 and return us the response

- Use case: VPN 
  - Machine 1 -> proxy machine -> this will be making the request, not your original machine

### Remote Port Forwarding

- Allows other people to access your local resources
- Ex: Local web server

```

                                                      Public SSH Server
                                                      44.11.22.33:22
                                                      44.11.22.33:8888

                                                      +------------+
                                                      |            |
Internal Resource                                     |            |
                        10.0.0.4                      |            |
+------------+       +------------+                   |            |
|            |       |            +------------------>| Machine 1  |
|            |       |            |                   |            |
|            |       |  Box A     |                   |            |
|            |       |            |<------------------+            |
|            |       |            |                   |            |
|            |       |            |                   +------------+
+------------+       +------------+                          ^
                                                             |
                                                             |   44.11.22.33:8888
   10.0.0.3:8080                                             |
                                                             |
                                                       +-----+-----+
                                                       |           |
                                                       |           |
                                                       | Machine 2 |
  ssh -R 8888:10.0.0.3:8080 44.11.22.33                |           |
                                                       |           |
                                                       +-----------+

```

- We want people outside our network to be able to acess the internal resource (Box A)
- Public server will listen on 8888, anything that goes to port 8888 of Machine 1 must go to the internal resource **via 8080**
- After the TCP connection is established through the SSH tunnel, any TCP requests made to the ssh server through port 8888 will be encapsulated as legitimate ssh request, will be sent to internal resource (Box A) now Box A owner will make the request on the outsider's behalf


### Using Plink.exe for SSH Tunneling

- SSH Tunneling between a windows machine having a blocked service and a Linux Machine
- Downloading plink.exe -> https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
- SSH server is running on the linux machine and tunneling will be initiated from the client's side
```
C:\> plink.exe -ssh -l <linux-username> -pw <linux-password> -R <linux-ip>:<linux-port>:127.0.0.1:8090 <linux-ip>
```

