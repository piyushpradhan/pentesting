# nmap 

## Syn scan 
### -sS
- fast scan 
- not restricted by firewalls
- doesn't complete TCP handshake

### -sU 
- UDP scans

### -O 
- detects the operating system the target is using

### -sV
- enables version detection and controlled with some options: 
    - --allports: dont exclude any ports
    - --version-light: enable light mode -> faster
    - --version-all: try every single probe -> ensures every single probe is attempted against each port 
    - --version-trace: trace version scan activity -> prints excessive info about what version scanning it's doing

### nmap output formats 
- -oN filespec -> normal output
- -oX filespec -> XML output
- -oS filespec -> ScRipT KIdd output
- -oG filespec -> grepable output
- -oA basename -> outputs to all formats -> stored as basename.nmap, basename.gnmap, basename.xml


### Aggressive scan options (-A)
- enables additional advanced and aggressive options
- enables: 
    - OS detection -> -O
    - version scanning -> -sV
    - script scanning -> -sC
    - traceroute -> --traceroute

### Timing Template 
### -T paranoid|sneaky|polite|normal|aggressive|insane
- 0, 1, 2, 3, 4, 5 -> paranoid|sneaky|polite|normal|aggressive|insane

### Scan a specific port
- -p <port no>
- -p <range> ex. -p 100-120
- -p- --> scans all ports 

### --script -> to run a script from nmap 

## Scan Types 

- *TCP Connect scans (-sT)*
- *SYN "Half-open" scans (-sS)*
- *UDP Scans (-sU)*

- TCP Null scans (-sN)
- TCP FIN Scans (-sF)
- TCP Xmas Scans (-sX)

### TCP Connect Scans (-sT)
- Performs the three-way handshake with each target port. 
- Nmap tries to connect to each specified TCP port, and determines whether the service is open by the response it receives

``` 
if the connnection doesn't exist (CLOSED) then a reset is sent in response to any incoming
segment except another reset.In particular, SYNs addressed to a non-existent connection 
are rejected by this means.
```
If Nmap tries to send a TCP Request with the SYN Flag set to a closed port the target server will respond with a TCP packet with the RST (reset) flag set.

If the request is sent to an open port then the target responds with an TCP packet containing SYN/ACK flags set. Nmap then marks the port as open _and completes the handshake by sending back an TCP packet with ACK set)._

*If the port is open but is hidden behind a firewall*
- Many firewalls are configured to simply drop the incoming packets.
- Nmap sends a TCP request and receives nothing, it then marks the port as *filtered*.

*Configuring a firewall to respond with a RST TCP packet*
Example: in IPtables for Linux a simple version of the command to reconfigure the firewall would be: 

```
iptables -I INPUT -p tcp --dport <port> -j REJECT --reject-with tcp-reset
```

### SYN Scans (-sS)

- Half-open or stealth scans
- SYN Scans send back an RST TCP packet after receiving SYN/ACK from the server which prevents the target server from repeatedly trying to make the request. 

*Advantages*
1. Used to bypass older Intrusion Detection systems that depend on completion of the Three-way handshake. 
2. Nothing is logged by applications listening on open ports as standard practice is to log only after a connection is full established. 
3. Faster than a standard TCP Connect scan as it doesn't complete a three-way handshake. 

*Disadvantages*
1. require sudo permissions becuase SYN scans require the ability to create raw packets which is a privilege only the root user has. 
2. Unstable services are sometimes brought down by SYN scans, which could prove to be problematic if a client has provided a production environment for the test. 

- Default scans in nmap if run with *sudo permissions*.
- If run without *sudo permissions* nmap defaults to TCP connect scan. 

### UDP Scans (-sU)

- UDP scans are stateless 
- Rather than initiating a connection with a "handshake", it tries to send packets to the target and hopes they make it. 
- Useful for connections that depend on speed rather than quality 
- When a packet is send to an open UDP port, ideally there should be no response and nmap with mark the port as open|filtered which means it suspects the port is open but it could be firewalled. 
- If it gets an UDP response then the port is marked as open. 
- When no response is received the request is sent a second time to double check, if there's still no response then the port is marked as open|filtered and nmap moves on. 
- When a packet is send to a closed UDP port, the target should respond with an ICMP (ping) packet containing a message that the port is unreachable. This clearly identifies closed ports.

- Due to this difficulty in determining the status of the ports UDP scans are very slow in comparison to various other TCP scans.
- Advisable to use --top-ports while using UDP scan. 
Example: nmap -sU --top-ports <number> <target> 
<number> : number of ports to scan 
  

## Some less commonly used scans 

- These are stelthier than SYN Scans 
- Expected response from open ports in these scans are identical and quite similar to UDP Scan. 
- No response is expected is the port is open, i.e. It can't detemine if the port is open or protected with firewall. 
- These will only mark ports as open|filtered, closed or filtered. 
- If the target responds with ICMP unreachable packet then the port is marked as filtered. 

- Some ports are known to respond with RST to any malformed TCP packet regardless of whether the port is actually open or not. This results in all ports showing up as being closed. 

- Many firewalls are configured to drop incoming TCP Packets with SYN flag set. Thus by sending request which do not contain the SYN Flag, in theory, these firewalls can be bypassed. However, it is very common so most IDS solutions won't fall for this. 

### NULL Scans (-sN)
- TCP request is sent with no flags set at all. 
- If the port is closed then, the target host should respond with RST. 

### FIN Scans (-sF)
- TCP request is sent with a FIN Flag 
- Expects an RST if the port is closed

### Xmas Scans (-sX)
- Malformed TCP requests are sent
- Expects a RST response from closed ports
